---

		title:  æ·±å…¥æ¢ç´¢ Android ç½‘ç»œä¼˜åŒ–ï¼ˆä¸‰ã€ç½‘ç»œä¼˜åŒ–ç¯‡ï¼‰
		date: 2020/2/5 17:43:00   
		tags: 
		- Androidè¿›é˜¶
		categories: Androidè¿›é˜¶
		thumbnail: https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1557665970516&di=b58d306a0db07efca58f8c9b655f5c13&imgtype=0&src=http%3A%2F%2Fimg02.tooopen.com%2Fimages%2F20160520%2Ftooopen_sl_055418231108.jpg
---

---

# å‰è¨€

### æˆä¸ºä¸€åä¼˜ç§€çš„Androidå¼€å‘ï¼Œéœ€è¦ä¸€ä»½å®Œå¤‡çš„[çŸ¥è¯†ä½“ç³»](https://github.com/JsonChao/Awesome-Android-Exercise)ï¼Œåœ¨è¿™é‡Œï¼Œè®©æˆ‘ä»¬ä¸€èµ·æˆé•¿ä¸ºè‡ªå·±æ‰€æƒ³çš„é‚£æ ·~ã€‚

# æœ¬æ–‡æ€ç»´å¯¼å›¾

![](https://user-gold-cdn.xitu.io/2020/6/8/172912c4eee1f382?w=3576&h=2136&f=png&s=1034100)


# ä¸€ã€ç½‘ç»œä¼˜åŒ–ç»´åº¦

## 1ã€ç½‘ç»œä¼˜åŒ–åˆ†æ

åŸºç¡€ç½‘ç»œçš„æ•ˆç‡å°±åƒä¸€è¾†åˆ—è½¦ï¼Œæ—¶å»¶æ˜¯ç«è½¦çš„é€Ÿåº¦ (å¯åŠ¨æ—¶é—´)ï¼Œè€Œå¸¦å®½å°±åƒç«è½¦çš„è½¦å¢è£…è½½é‡ï¼Œæ•´ä¸ªä¼ è¾“çš„ç‰©ç†é“¾è·¯å°±åƒç«è½¦çš„é“è½¨ã€‚ä»ç½‘ç»œçš„é€šä¿¡è¿‡ç¨‹æ¥çœ‹ï¼Œå…±æ¶‰åŠåˆ° **ä¸‰ä¸ªæ¨¡å—**ï¼š

- 1ï¼‰ã€**ç½‘ç»œåº“ SDK å†…éƒ¨çš„è®¾è®¡ä¸ç­–ç•¥ï¼šI/O å¹¶å‘æ¨¡å‹ï¼Œé’ˆå¯¹ç½‘ç»œé—®é¢˜çš„ä¼˜åŒ–**ã€‚
- 2ï¼‰ã€**æœåŠ¡å™¨æ€§èƒ½ï¼šå¹¶å‘ã€å¸¦å®½èƒ½åŠ›**ã€‚
- 3ï¼‰ã€**ç½‘ç»œç›¸å…³ï¼šç”¨æˆ·ç½‘ç»œï¼ˆå¼±ç½‘/å¼ºç½‘ï¼‰ã€è¿è¥å•†ã€ç½‘ç»œé“¾è·¯ç­‰**ã€‚


è€Œå¯¹äºç½‘ç»œçš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä»¥ä¸‹äº”ä¸ªç»´åº¦æ¥è¿›è¡Œã€‚

### 1ï¼‰ã€æµé‡ä¼˜åŒ–

ç²¾ç¡®è·å–ç½‘ç»œæµé‡çš„æ¶ˆè€—é‡ï¼Œè§£å†³æ•´ä½“å‡å€¼æ©ç›–å•ç‚¹å¼‚å¸¸æµé‡çš„é—®é¢˜ã€‚

### 2ï¼‰ã€ç½‘ç»œç›‘æ§

å»ºè®¾å…¨é¢çš„ç½‘ç»œç›‘æ§ï¼Œå› ä¸ºç²—ç²’åº¦çš„ç›‘æ§ä¸èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å‘ç°å’Œè§£å†³é—®é¢˜ã€‚

### 3ï¼‰ã€æµé‡æ¶ˆè€—

- 1ã€ç²¾å‡†è·å–ä¸€æ®µæ—¶é—´çš„æµé‡æ¶ˆè€—ã€ç½‘ç»œç±»å‹ã€å‰åå°ã€‚
- 2ã€ç”¨æˆ·æµé‡æ¶ˆè€—å‡å€¼ã€å¼‚å¸¸ç‡ï¼ˆæ¶ˆè€—å¤šã€æ¬¡æ•°å¤šï¼‰ã€‚
- 3ã€å®Œæ•´é“¾è·¯å…¨ç›‘æ§ï¼ˆRequestã€Responseï¼‰ã€ä¸»åŠ¨ä¸ŠæŠ¥ã€‚

### 4ï¼‰ã€ç½‘ç»œè¯·æ±‚è´¨é‡

- 1ã€è¯·æ±‚æ—¶é•¿ã€ä¸šåŠ¡æˆåŠŸç‡ã€å¤±è´¥ç‡ã€TOP å¤±è´¥æ¥å£ï¼Œå¯¼è‡´è¯·æ±‚å¤±è´¥çš„åŸå› é€šå¸¸æœ‰ä¸¤ç§æƒ…å†µï¼š
    - 1ï¼‰ã€å¼±ä¿¡å·ï¼šå¯ä»¥ç®€å•çœ‹æˆæ‰‹æœºä¿¡å·åªæœ‰ä¸€ä¸¤æ ¼çš„æ—¶å€™ï¼Œè¿™æ˜¯ä¸ä»…ä»…æ˜¯ä¿¡ä»¤ï¼ˆæ— çº¿ç½‘ç»œé€šä¿¡çš„éƒ½æ˜¯ä¸€ä¸ªä¸ªçš„ä¿¡ä»¤ï¼‰å‘å‡ºå»å›°éš¾ï¼Œè¿˜å¯èƒ½å¯¼è‡´ä¸æ–­åˆ‡æ¢ç½‘ç»œã€åŸºç«™ã€‚App åªèƒ½åœ¨åº”ç”¨å±‚åšé‡è¯•ï¼Œå› ä¸ºå¼±ä¿¡å·ä¸€èˆ¬éƒ½æ˜¯ä¸€æ—¶çš„ã€‚
    - 2ï¼‰ã€æ‹¥å¡ç½‘ç»œï¼šå¯ä»¥ç±»æ¯”ä¸ºå µè½¦ã€æ’é˜Ÿçš„åœºæ™¯ï¼Œæ•°æ®åŒ…æ’é˜Ÿï¼Œä¿¡ä»¤ä¹Ÿåœ¨æ’é˜Ÿã€‚è¿™æ—¶ App ä¸æ–­é‡è¯•ï¼Œåªä¼šä½¿å¾—æ‹¥å¡ç½‘ç»œæ›´ä¸ºä¸¥é‡ã€‚æˆ‘ä»¬åªèƒ½è®©è‡ªå·±çš„éæ ¸å¿ƒä¸šåŠ¡ä¸è¦å»æ’é˜Ÿï¼Œå¹¶è®©æ ¸å¿ƒä¸šåŠ¡çš„æ•°æ®é‡æ›´å°‘ï¼Œåè®®æ¥å›æ›´å°‘ã€‚
- 2ã€ç”¨æˆ·ä½“éªŒ
- 3ã€è¯·æ±‚é€Ÿåº¦ã€æˆåŠŸç‡ï¼šç½‘ç»œæ­£å¸¸æ—¶å¦‚ä½•æ›´å¥½åœ°åˆ©ç”¨å¸¦å®½æå‡ç½‘ç»œè¯·æ±‚é€Ÿåº¦ï¼Ÿ
- 4ã€å¼±ç½‘ï¼šç½‘ç»œä¸ç¨³å®šæ˜¯å¦‚ä½•æœ€å¤§ç¨‹åº¦ä¸Šä¿è¯ç½‘ç»œçš„è¿é€šæ€§ï¼Ÿ
- 5ã€å®‰å…¨ï¼šå¦‚ä½•é˜²æ­¢è¢«ç¬¬ä¸‰æ–¹åŠ«æŒã€çªƒå¬ç”šè‡³ç¯¡æ”¹ï¼Ÿ

### 5ï¼‰ã€å…¶å®ƒ

- 1ã€å…¬å¸æˆæœ¬
- 2ã€å¸¦å®½ã€æœåŠ¡å™¨æ•°é‡ã€CDN
- 3ã€è€—ç”µ


## 2ã€ç½‘ç»œä¼˜åŒ–è¯¯åŒº

- 1ï¼‰ã€ä»…ä»…å…³æ³¨æµé‡æ¶ˆè€—ï¼Œå¿½è§†å…¶å®ƒç»´åº¦ã€‚
- 2ï¼‰ã€ä»…ä»…å…³æ³¨å‡å€¼ã€æ•´ä½“ã€å¿½è§†ä¸ªä½“ã€‚


# äºŒã€ç½‘ç»œä¼˜åŒ–å·¥å…·

## 1ã€Network Profiler

### ç‰¹ç‚¹

- 1ï¼‰ã€æ˜¾ç¤ºå®æ—¶ç½‘ç»œæ´»åŠ¨ï¼šå‘é€ã€æ¥æ”¶æ•°æ®åŠè¿æ¥æ•°ã€‚
- 2ï¼‰ã€éœ€å¯åŠ¨é«˜çº§åˆ†æã€‚
- 3ï¼‰ã€ä»…æ”¯æŒ HttpURLConnection ä¸ OkHttp


### æ‰“å¼€é«˜çº§åˆ†æ

> Run => Edit Cofigurations => ç•Œé¢æœ€å³è¾¹ Profiling => æ‰“å¼€ Enable advanced profiling ï¼ˆrequired for API level < 26 onlyï¼‰


### ä½¿ç”¨ Network Profiler è°ƒè¯• WanAndroid ç½‘ç»œè¯·æ±‚

é€‰ä¸­ç›®æ ‡ç½‘ç»œè¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ä¸‹æ–¹çš„ Connection View ä¸€æ çœ‹åˆ°å¯¹åº”çš„ç½‘ç»œæ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

- Size
- Type
- Status
- Time
- Timeline


é€‰ä¸­ Connection View ç‰¹å®šçš„ä¸€æ¡æ•°æ®å³å¯åœ¨å³è¾¹çœ‹åˆ°è¯¥è¯·æ±‚å¯¹åº”çš„ç½‘ç»œæ•°æ®ã€‚

#### Overview

è¯¥ç½‘ç»œè¯·æ±‚çš„é¢„è§ˆä¿¡æ¯

#### æ™®é€š Json æ•°æ®è¯·æ±‚


![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc2498f34313?w=2394&h=1246&f=png&s=231794)


#### å›¾ç‰‡åŠ è½½è¯·æ±‚


![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc35a3b634da?w=2406&h=1250&f=png&s=512906)


![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc3e289ff062?w=2402&h=1312&f=png&s=452439)


#### Response

Response Header ä¸ Body ä¿¡æ¯

#### Request

Request Header ä¸ Body ä¿¡æ¯

#### CallStack

ç½‘ç»œè¯·æ±‚çš„è°ƒç”¨å †æ ˆä¿¡æ¯ï¼Œ
ä¸‹å›¾å°±æ˜¯ Awesome-WanAndroid å‘èµ·ä¸€ä¸ªç½‘ç»œè¯·æ±‚æ‰€ç»å†çš„è°ƒç”¨å †æ ˆï¼š

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc4b1c16acb6?w=906&h=1154&f=png&s=304570)


Awesome-WanAndroid ä½¿ç”¨ Glide å‘èµ·ä¸€ä¸ªå›¾ç‰‡åŠ è½½è¯·æ±‚æ‰€ç»å†çš„è°ƒç”¨å †æ ˆï¼š

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc4ebc7cb5a7?w=968&h=628&f=png&s=168544)


#### å…³é”®ç»†èŠ‚

é«˜çº§é…ç½®ä¸­çš„ required for API level < 26 only ä¸æ˜¯é™å®šè°ƒè¯•çš„æ‰‹æœºç‰ˆæœ¬å°äº26ï¼Œæˆ‘ä½¿ç”¨ API 27 çš„æ‰‹æœºä¹Ÿå¯ä»¥è°ƒè¯•ã€‚


#### å®è·µä¸­è·å¾—çš„æ–°çŸ¥è¯†åŠæ„Ÿæ‚Ÿ

å¦‚æœæƒ³å¿«é€Ÿææ‡‚æ¥æ‰‹é¡¹ç›®ä¸­çš„ç½‘ç»œ/å›¾ç‰‡åŠ è½½ç­‰æ¡†æ¶çš„wç½‘ç»œè¯·æ±‚æµç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ Profiler NETWORK çš„ CallStack åŠŸèƒ½ï¼Œå¹¶ä¸”åŒå‡»å…¶ä¸­ä»»æ„çš„ä¸€è¡Œè°ƒç”¨é“¾æ–¹æ³•éƒ½å¯ä»¥ jump to æŒ‡å®šæºç ã€‚


> é€‰ä¸­ç½‘ç»œè¯·æ±‚æ— æ³•æ˜¾ç¤ºæ•°æ®ï¼Ÿ

æ‰“å¼€é«˜çº§åˆ†æå³å¯ã€‚


## 2ã€Charles

ä½¿ç”¨ Java å¼€å‘çš„ï¼ŒMAC ä¸Šä½¿ç”¨è¾ƒå¤šã€‚

### ç‰¹ç‚¹

- 1ï¼‰ã€æ–­ç‚¹åŠŸèƒ½
- 2ï¼‰ã€Map Local
- 3ï¼‰ã€å¼±ç½‘ç¯å¢ƒæ¨¡æ‹Ÿ


### å®‰è£…é…ç½®

#### 1ã€ä¸‹è½½ [Charles](https://www.charlesproxy.com)ã€‚

#### 2ã€æˆªè·æ‰‹æœºç«¯çš„ç½‘ç»œåŒ…ã€‚

éœ€è¦é…ç½®æ‰‹æœºä¸ç”µè„‘è¿æ¥åŒä¸€ WIFIã€‚

##### 1ï¼‰ã€ç”µè„‘ç«¯è®¾ç½® Charles â€” æ‰“å¼€ HTTP ä»£ç†å¹¶è®¾ç½®ä»£ç†ç«¯å£

- Charles èœå•æ  => Proxy => Proxy Settings => å¡«ä»£ç†ç«¯å£ 8888 å¹¶å‹¾é€‰ Enable transparent HTTP proxyingã€‚

##### 2ï¼‰ã€æ‰‹æœºç«¯è®¾ç½® WIFI ä»£ç†åŠç«¯å£

- è·å–ç”µè„‘ IP åœ°å€
    - ç‚¹å‡» Charles çš„ help => local addressã€‚
- è®¾ç½® WIFI ä»£ç†åŠç«¯å£å·
    - æ‰‹æœºè®¾ç½® => WLAN => æŸ¥çœ‹å½“å‰è¿æ¥çš„ WIFI è¯¦æƒ… => æœ€åº•éƒ¨ä»£ç†é¡¹è®¾ç½®ä¸ºæ‰‹åŠ¨ => é…ç½® ç”µè„‘ IP åœ°å€ä¸ç«¯å£å·8888ã€‚

##### 3ï¼‰ã€è®¾ç½®å®Œæˆï¼Œè¿è¡Œä»»æ„è”ç½‘ç¨‹åºï¼ŒCharles ä¼šå¼¹å‡ºè¯·æ±‚è¿æ¥çš„ç¡®è®¤æ¡†ï¼Œç‚¹å‡» allow å³å¯ã€‚

#### 3ã€æˆªå– HTTPS

éœ€è¦ä¿¡ä»» Charles çš„ CA è¯ä¹¦ã€‚

##### 1ï¼‰ã€æ‰“å¼€ SSL ä»£ç†ï¼Œå¹¶é…ç½® Host ä¸ Port

- ç”µè„‘ç«¯ Proxy => SSL Proxying Setting => é€‰ä¸­ Enable SSL Proxying å¹¶ç‚¹å‡» Add é…ç½® Host ä¸ Port åˆ†åŠä¸º * ä¸ 443ã€‚

##### 2ï¼‰ã€ä¿¡ä»» Charles Proxy CA æœºæ„

- ç”µè„‘ç«¯ Help => SSL Proxying => Install Charles Root Certificate => é€‰ä¸­å¹¶åŒå‡» Charles Proxy CA æ ¹è¯ä¹¦é¢å‘æœºæ„ => ç‚¹å‡»ä¿¡ä»» => ä½¿ç”¨æ­¤è¯ä¹¦æ—¶é€‰æ‹©å§‹ç»ˆä¿¡ä»»ã€‚

##### 3ï¼‰ã€æ‰‹æœºç«¯å®‰è£… Charles é¢å‘çš„ SSL è¯ä¹¦

- ç”µè„‘ç«¯ Help => SSL Proxying => Install Charles Root Certificate on a Mobile Deviceï¼Œæ­¤æ—¶ä¼šå¼¹å‡ºæç¤ºæ¡†è®©æ‰‹æœºç«¯è®¿é—® http://chls.pro/ssl å»ä¸‹è½½è¯ä¹¦ã€‚

##### 4ï¼‰ã€æ‰‹æœºç«¯å®‰è£…è¯ä¹¦

- ä»æ–‡ä»¶ç®¡ç†å™¨ä¸­æ‰¾åˆ°ä¸‹è½½æ–‡ä»¶ => å¦‚æœæ˜¯ .pem ç»“å°¾iï¼Œå°†åç¼€åæ”¹ä¸º .crt å¹¶ç‚¹å‡»è¯¥æ–‡ä»¶ => è¾“å…¥é”å±å¯†ç  => ç­‰å¾…è¯ä¹¦å¯¼å…¥åé…ç½®è¯ä¹¦åï¼ˆæˆ‘å¡«çš„æ˜¯ Charlesï¼‰å³å¯ã€‚

### å®è·µè¿‡ç¨‹

#### é€‰ä¸­ç›®æ ‡ç½‘ç»œè¯·æ±‚

ä» Overview ä¸­å¯ä»¥çœ‹åˆ°å¾ˆå…¨é¢æŠ“åŒ…ä¿¡æ¯ ã€‚

#### ä½¿ç”¨æ–­ç‚¹åŠŸèƒ½

##### 1ï¼‰ã€å³é”®ç‚¹å‡»è¦æ–­ç‚¹çš„ URLï¼Œé€‰ä¸­ BreakPoints å¼€å¯æ–­ç‚¹åŠŸèƒ½ã€‚

##### 2ï¼‰ã€ç‚¹å‡»é¡¶éƒ¨ Proxy => Breadkpoint Settingsã€‚

##### 3ï¼‰ã€åŒå‡» Breakpoints Settings é¢æ¿ä¸­çš„ç›®æ ‡
URLï¼Œåœ¨å¼¹å‡ºçš„ Edit Breakpoint é¢æ¿ä¸­è¿›è¡Œç¼–è¾‘ã€‚

##### 4ï¼‰ã€è¿™é‡Œé»˜è®¤é€‰æ‹©æ–­ç‚¹ Request ä¸ Responseï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä»…æ–­ç‚¹ Response æˆ– Requestã€‚ç‚¹å‡»ç¡®è®¤å³æ–­ç‚¹è®¾ç½®å®Œæˆã€‚

##### 5ï¼‰ã€ç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç‚¹å‡»ä¸»é¢æ¿å³ä¾§çš„ Edit Response ç¼–è¾‘ Responseï¼Œä¿®æ”¹å®Œæˆåç‚¹å‡»æœ€ä¸‹æ–¹çš„ Execute å³å¯ã€‚

#### ä½¿ç”¨ Map Local

##### 1ï¼‰ã€è‡ªç”±æ¨¡æ‹ŸæœåŠ¡ç«¯çš„è¿”å›æ•°æ®ï¼Œä»¥æå‰è¿›è¡Œæ¥å£æµ‹è¯•ã€‚

##### 1ï¼‰ã€å³é”®ç‚¹å‡»è¦ä½¿ç”¨ Map Local çš„ URLï¼Œé€‰ä¸­Map Local å¼€å¯æ–­ç‚¹åŠŸèƒ½ã€‚

##### 1ï¼‰ã€ç„¶åï¼Œæˆ‘ä»¬åœ¨ Edit Mapping é¢æ¿ä¸­é€‰æ‹© Map To çš„ Local pathï¼Œé€‰æ‹©æœ¬åœ°è®¾å®šçš„ maplocal æœ¬åœ°æ•°æ®ï¼ˆä¾‹å¦‚ JsonStringï¼‰


#### å¼±ç½‘æ¨¡æ‹ŸåŠŸèƒ½

- 1ï¼‰ã€æ³¨æ„å¼€å¯å‰éœ€å°† Map Local å…³é—­ã€‚

- 2ï¼‰ã€ç‚¹å‡» Proxy => Throttle Setting => é€‰ä¸­ Enable Throttling

- 3ï¼‰ã€è¿™é‡Œé¢„è®¾äº†å¾ˆå¤šæ¨¡æ‹Ÿè®¾ç½®ï¼Œæˆ‘ä»¬åªéœ€å°† ç½‘ç»œåŒ…ä¼ è¾“çš„é€Ÿç‡ Throttle preset è®¾ç½®ä¸ºè¾ƒä½çš„é€Ÿç‡ï¼ˆä¸€èˆ¬è®¾ä¸º 256/512ï¼‰ã€‚


### ç¢°åˆ°çš„é—®é¢˜

- 1ï¼‰ã€æ³¨æ„æ‰‹æœºä¸ç¬”è®°æœ¬ç”µè„‘éœ€è¦åŒä¸€ WIFI ä¸‹ï¼Œä¸èƒ½è‡ªå·±å¼€çƒ­ç‚¹æˆ–ä½¿ç”¨å…¬å¸å†…ç½‘ï¼Œå¦åˆ™æ— æ³•åœ¨ ç”µè„‘ç«¯ æ— æ³•å¼¹å‡ºæ‰‹æœºè¿æ¥ Charles çš„æç¤ºç¡®è®¤æ¡†ï¼Œå¹¶ä¸”ä¹Ÿæ— æ³•ä¸‹è½½ Charles æä¾›çš„ SSL è¯ä¹¦ã€‚
- 2ï¼‰ã€æ‰‹æœºç«¯ä¸‹è½½ Charles æä¾›çš„ SSL è¯ä¹¦æ—¶æœ€å¥½ä¸ä½¿ç”¨ç³»ç»Ÿæµè§ˆå™¨è®¿é—®ã€‚


## 3ã€Wireshark

> å¼ºçƒˆæ¨è [geektime-webprotocol](https://github.com/geektime-geekbang/geektime-webprotocol)


WireShark ä¸»è¦å¯ä»¥ç”¨æ¥å¯¹å››ç§æµè¿›è¡Œè·Ÿè¸ªï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

- TCP
- UDP 
- SSL
- HTTP


### 1ï¼‰ã€WireShark åŸºæœ¬ä½¿ç”¨

#### å¦‚ä½•æ•è·æŠ¥æ–‡

- 1ï¼‰ã€ç‚¹å‡»æ•è·->é€‰é¡¹ï¼Œæ‰“å¼€æ•è·çª—å£
    - ç½‘å¡è®¾å¤‡/æµé‡/æ•è·è¿‡æ»¤å™¨ï¼Œç‚¹å‡»â€œå¼€å§‹â€æŒ‰é’®å¼€å§‹æŠ“åŒ…
    - è¾“å‡º(æŒ‡å®šç¼“å­˜æ–‡ä»¶)/é€‰é¡¹(æ˜¾ç¤ºã€åç§°è§£æã€è‡ªåŠ¨åœæ­¢æŠ“åŒ…æ¡ä»¶) é¢æ¿
- 2ï¼‰ã€ç‚¹å‡»æ•è·->åœæ­¢ï¼Œåœæ­¢æŠ“åŒ…


![](https://user-gold-cdn.xitu.io/2020/6/7/1728cbd5e35aed47?w=1738&h=696&f=png&s=499751)


#### Wireshark é¢æ¿

![](https://user-gold-cdn.xitu.io/2020/6/7/1728cbe46b1fbf33?w=2112&h=1012&f=png&s=2244828)


#### å¿«æ·æ–¹å¼å·¥å…·æ 


![](https://user-gold-cdn.xitu.io/2020/6/7/1728cbef2412372d?w=1978&h=936&f=png&s=519686)


#### æ•°æ®åŒ…çš„é¢œè‰²(è§†å›¾->ç€è‰²è§„åˆ™)


![](https://user-gold-cdn.xitu.io/2020/6/7/1728cbfc4b7c46cc?w=1700&h=764&f=png&s=1098039)


#### è®¾å®šæ—¶é—´æ˜¾ç¤ºæ ¼å¼

![](https://user-gold-cdn.xitu.io/2020/6/7/1728cc27686a0a0c?w=1156&h=944&f=png&s=572015)


#### æ•°æ®åŒ…åˆ—è¡¨é¢æ¿çš„æ ‡è®°ç¬¦å·

![](https://user-gold-cdn.xitu.io/2020/6/7/1728cc30efa16f56?w=1560&h=832&f=png&s=190573)


#### æ–‡ä»¶æ“ä½œ

- 1ï¼‰ã€æ ‡è®°æŠ¥æ–‡ Ctrl+Mã€‚
- 2ï¼‰ã€å¯¼å‡ºæ ‡è®°æŠ¥æ–‡(æ–‡ä»¶->å¯¼å‡ºç‰¹å®šåˆ†ç»„)ï¼Œäº¦å¯æŒ‰è¿‡æ»¤å™¨å¯¼å‡ºæŠ¥æ–‡ ï¼Œ
- 3ï¼‰ã€åˆå¹¶è¯»å…¥å¤šä¸ªæŠ¥æ–‡(æ–‡ä»¶->åˆå¹¶)ã€‚


#### å¦‚ä½•å¿«é€ŸæŠ“å–ç§»åŠ¨è®¾å¤‡çš„æŠ¥æ–‡?

- 1ã€æ‰“å¼€æ‰‹æœºçš„ wifi çƒ­ç‚¹ã€‚
- 2ã€ç”µè„‘è¿æ¥æ‰‹æœºçš„ wifi çƒ­ç‚¹ã€‚
- 3ã€ç”¨ Wireshark æ‰“å¼€æ•è·->é€‰é¡¹é¢æ¿ï¼Œé€‰æ‹© wifi çƒ­ç‚¹å¯¹åº”çš„æ¥å£è®¾å¤‡æŠ“åŒ…å³å¯ã€‚


### 2ï¼‰ã€Wireshark è¿‡æ»¤å™¨

å¦‚æœè¡¨è¾¾å¼çš„èƒŒæ™¯ä¸ºç»¿è‰²ï¼Œåˆ™è¯´æ˜è¿‡æ»¤å™¨çš„è¯­æ³•æ˜¯æ­£ç¡®çš„ï¼Œçº¢è‰²åˆ™è¯´æ˜æœ‰é”™è¯¯ã€‚

#### æ•è·è¿‡æ»¤å™¨

å®ƒç”¨äºå‡å°‘æŠ“å–çš„æŠ¥æ–‡ä½“ç§¯ï¼Œä½¿ç”¨ BPFï¼ˆBerkeley Packet Filterï¼‰ è¯­æ³•ï¼ŒåŠŸèƒ½ç›¸å¯¹æœ‰é™ã€‚

BPF å¯ä»¥åœ¨è®¾å¤‡é©±åŠ¨çº§åˆ«æä¾›æŠ“åŒ…è¿‡æ»¤æ¥å£ï¼Œå¤šæ•°æŠ“åŒ…å·¥å…·éƒ½æ”¯æŒæ­¤è¯­æ³•ã€‚è€Œ BPF çš„ Expression è¡¨è¾¾å¼ç”±å¤šä¸ª primitives åŸè¯­ç»„æˆã€‚è€Œæ¯ä¸€ä¸ª primitives åŸè¯­åˆ™ç”±åç§°æˆ–æ•°å­—ï¼Œä»¥åŠæè¿°å®ƒçš„å¤šä¸ª qualifiers é™å®šè¯ç»„æˆã€‚

##### qualifiers é™å®šè¯

- 1ã€Typeï¼šè®¾ç½®æ•°å­—æˆ–è€…åç§°æ‰€æŒ‡ç¤ºç±»å‹
    - hostã€portã€‚
    - net ï¼Œè®¾å®šå­ç½‘ï¼Œnet 192.168.0.0 mask 255.255.255.0 ç­‰ä»·äº net 192.168.0.0/24ã€‚
    - portrangeï¼Œè®¾ç½®ç«¯å£èŒƒå›´ï¼Œä¾‹å¦‚ portrange 6000-8000ã€‚
- 2ã€Dir:è®¾ç½®ç½‘ç»œå‡ºå…¥æ–¹å‘
    - srcã€dstã€src or dstã€src and dstã€‚
    - raã€taã€addr1ã€addr2ã€addr3ã€addr4(ä»…å¯¹ IEEE 802.11 Wireless LAN æœ‰æ•ˆ)ã€‚
- 3ã€Proto:æŒ‡å®šåè®®ç±»å‹
    - etherã€fddiã€trã€ wlanã€ 
    - ipã€ ip6ã€ arpã€ rarpã€ 
    - decnetã€ tcpã€udpã€icmpã€igmpã€icmp
    - igrpã€pimã€ahã€espã€vrrp
- 4ã€å…¶ä»–
    - gateway:æŒ‡æ˜ç½‘å…³ IP åœ°å€ï¼Œç­‰ä»·äº ether host ehost and not host hostã€‚
    - broadcast:å¹¿æ’­æŠ¥æ–‡ï¼Œä¾‹å¦‚ ether broadcast æˆ–è€… ip broadcastã€‚
    - multicast:å¤šæ’­æŠ¥æ–‡ï¼Œä¾‹å¦‚ ip multicast æˆ–è€… ip6 multicastã€‚
    - less, greater:å°äºæˆ–è€…å¤§äºã€‚


#### ç®€å•ç¤ºä¾‹

```
src or dst portrange 6000-8000 && tcp or ip6
```


#### æ˜¾ç¤ºè¿‡æ»¤å™¨

å®ƒå¯¹å·²ç»æŠ“å–åˆ°çš„æŠ¥æ–‡è¿›è¡Œè¿‡æ»¤æ˜¾ç¤ºï¼ŒåŠŸèƒ½å¼ºå¤§ã€‚

##### åŸºäºåè®®åŸŸè¿‡æ»¤

- æ•è·æ‰€æœ‰ TCP ä¸­çš„ RST æŠ¥æ–‡ï¼štcp[13]&4==4ã€‚
- æŠ“å– HTTP GET æŠ¥æ–‡ï¼šport 80 and tcp[((tcp[12:1] & 0xf0) >> 2):4] = 0x47455420ã€‚ï¼ˆ47455420 æ˜¯ ASCII ç çš„ 16 è¿›åˆ¶ï¼Œè¡¨ç¤ºâ€GET â€ï¼‰
- æŠ“å– HTTP POST æŠ¥æ–‡ï¼šport 80 and tcp[((tcp[12:1] & 0xf0) >> 2):4] = 0x504F5354


##### æ˜¾ç¤ºè¿‡æ»¤å™¨çš„è¿‡æ»¤å±æ€§

ä»»ä½•åœ¨æŠ¥æ–‡ç»†èŠ‚é¢æ¿ä¸­è§£æå‡ºçš„å­—æ®µåï¼Œéƒ½å¯ä»¥ä½œä¸ºè¿‡æ»¤å±æ€§ã€‚åœ¨è§†å›¾->å†…éƒ¨->æ”¯æŒçš„åè®®é¢æ¿é‡Œï¼Œå¯ä»¥çœ‹åˆ°å„å­—æ®µåå¯¹åº”çš„å±æ€§åã€‚ä¾‹å¦‚ï¼Œåœ¨æŠ¥æ–‡ç»†èŠ‚é¢æ¿ä¸­ TCP åè®®å¤´ä¸­çš„ Source Portï¼Œå¯¹åº”ç€è¿‡æ»¤å±æ€§ä¸º tcp.srcportã€‚


##### å¸¸ç”¨æ“ä½œç¬¦

- 1ï¼‰ã€andï¼ˆ&&ï¼‰ï¼šAND é€»è¾‘ä¸ï¼Œip.src==10.0.0.5 and tcp.flags.finã€‚
- 2ï¼‰ã€orï¼ˆ||ï¼‰ï¼šOR é€»è¾‘æˆ–ï¼Œip.scr==10.0.0.5 or ip.src==192.1.1.1ã€‚
- 3ï¼‰ã€xorï¼ˆ^^ï¼‰ï¼šXOR é€»è¾‘å¼‚æˆ–ï¼Œtr.dst[0:3] == 0.6.29 xor tr.src[0:3] == 0.6.29ã€‚
- 4ï¼‰ã€notï¼ˆ!ï¼‰ï¼šNOT é€»è¾‘éï¼Œnot llcã€‚
- 5ï¼‰ã€[...â€‹]ï¼šä¸­æ‹¬å·[]Slice åˆ‡ç‰‡æ“ä½œç¬¦
    - [n:m]è¡¨ç¤º n æ˜¯èµ·å§‹åç§»é‡ï¼Œm æ˜¯åˆ‡ç‰‡é•¿åº¦ï¼Œä¾‹å¦‚ï¼šeth.src[0:3] == 00:00:83
    - [n-m]è¡¨ç¤º n æ˜¯èµ·å§‹åç§»é‡ï¼Œm æ˜¯æˆªæ­¢åç§»é‡ï¼Œä¾‹å¦‚ï¼šeth.src[1-2] == 00:83
    - [:m]è¡¨ç¤ºä»å¼€å§‹å¤„è‡³ m æˆªæ­¢åç§»é‡ï¼Œä¾‹å¦‚ï¼šeth.src[:4] == 00:00:83:00
    - [m:]è¡¨ç¤º m æ˜¯èµ·å§‹åç§»é‡ï¼Œè‡³å­—æ®µç»“å°¾ï¼Œä¾‹å¦‚ï¼šeth.src[4:] == 20:20
    - [m]è¡¨ç¤ºå–åç§»é‡ m å¤„çš„å­—èŠ‚ï¼Œä¾‹å¦‚ï¼šeth.src[2] == 83
    - [,]ä½¿ç”¨é€—å·åˆ†éš”æ—¶ï¼Œå…è®¸ä»¥ä¸Šæ–¹å¼åŒæ—¶å‡ºç°ï¼Œä¾‹å¦‚ï¼šeth.src[0:3,1-2,:4,4:,2] ==00:00:83:00:83:00:00:83:00:20:20:83
- 6ï¼‰ã€inï¼šå¤§æ‹¬å·{}é›†åˆæ“ä½œç¬¦ï¼Œä¾‹å¦‚ tcp.port in {443 4430..4434} ï¼Œå®é™…ç­‰ä»·äº tcp.port == 443 || (tcp.port >= 4430 && tcp.port â‡ 4434)ã€‚


##### å¯ç”¨å‡½æ•°

- upperï¼šå°†å­—ç¬¦ä¸²å­—æ®µè½¬æ¢ä¸ºå¤§å†™ã€‚
- lowerï¼šå°†å­—ç¬¦ä¸²å­—æ®µè½¬æ¢ä¸ºå°å†™ã€‚
- lenï¼šè¿”å›å­—ç¬¦ä¸²æˆ–å­—èŠ‚æ•°ç»„çš„å­—èŠ‚é•¿åº¦ã€‚
- countï¼šè¿”å›åœ¨ä¸€å¸§ä¸­å­—æ®µå‡ºç°çš„æ•°é‡ã€‚
- stringï¼šå°†éå­—ç¬¦ä¸²å­—æ®µè½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚


##### æ˜¾ç¤ºè¿‡æ»¤å™¨çš„å¯è§†åŒ–å¯¹è¯æ¡†

![](https://user-gold-cdn.xitu.io/2020/6/7/1728cf091d66d139?w=1982&h=952&f=png&s=1094535)


##### ç¯å½¢ç¼“å†²å™¨

ä¾‹å¦‚ä½¿ç”¨ 3 ä¸ªæ–‡ä»¶çš„ç¯å½¢ç¼“å­˜å™¨ï¼Œä» **.1 => **.2 => **.3 ç„¶ååˆä» **.1 æ–‡ä»¶å¼€å§‹è®°å½•ï¼Œå½¢æˆç¯å½¢ã€‚


## 4ã€TcpDumpï¼ˆç½‘ç»œæ•°æ®åŒ…å—…æ¢å™¨ï¼‰

### 1ï¼‰ã€æŠ“åŒ…æ­¥éª¤

#### 1ã€è·å– ROOT æƒé™çš„æ‰‹æœºä¸€éƒ¨

#### 2ã€ä¸‹è½½ [tcpdump](www.androidtcpdump.com)

#### 3ã€å°† tcpdump å®‰è£…åˆ°æ‰‹æœºä¸Š

```
adb push tcpdump /data/local/tmp
```


#### 4ã€ä¿®æ”¹ tcpdump çš„æƒé™ï¼Œä½¿å…¶å…·æœ‰å¯æ‰§è¡Œçš„æƒé™

```
chmod 777 /data/local/tmp/tcpdump
```


#### 5ã€æ‰§è¡Œ tcpdump å‘½ä»¤è¿›è¡ŒæŠ“åŒ…ï¼ŒæŒ‰ç»„åˆé”® Ctrl + C å¯ä»¥åœæ­¢æŠ“åŒ…

#### 6ã€å°†æŠ“åˆ°çš„æ•°æ®åŒ…çš„ä¿¡æ¯ä¿å­˜ä¸º Pcap æ–‡ä»¶ï¼Œè¿™é‡Œä»…éœ€åœ¨æ‰§è¡Œ tcpdump ååŠ ä¸Š -w å‚æ•°

```
tcpdump-w /data/local/tmp/tcp.pcap
```

#### 7ã€æŠŠ Pcap å¤åˆ¶åˆ° ç”µè„‘ä¸Šï¼Œä½¿ç”¨ Wireshark åˆ†ææ•°æ®åŒ…çš„æµé‡ã€‚

### 2ï¼‰ã€æ•è·åŠåœæ­¢æ¡ä»¶

- -Dï¼šåˆ—ä¸¾æ‰€æœ‰ç½‘å¡è®¾å¤‡ã€‚
- -iï¼šé€‰æ‹©ç½‘å¡è®¾å¤‡ã€‚
- -cï¼šæŠ“å–å¤šå°‘æ¡æŠ¥æ–‡ã€‚
- --time-stamp-precisionï¼šæŒ‡å®šæ•è·æ—¶çš„æ—¶é—´ç²¾åº¦ï¼Œé»˜è®¤æ¯«ç§’ microï¼Œå¯é€‰çº³ç§’ nanoã€‚ 
- -sï¼šæŒ‡å®šæ¯æ¡æŠ¥æ–‡çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œé»˜è®¤ 262144 å­—èŠ‚ã€‚


### 3ï¼‰ã€æ–‡ä»¶æ“ä½œ

- -wï¼šè¾“å‡ºç»“æœè‡³æ–‡ä»¶(å¯è¢«Wiresharkè¯»å–åˆ†æ)ã€‚
- -Cï¼šé™åˆ¶è¾“å…¥æ–‡ä»¶çš„å¤§å°ï¼Œè¶…å‡ºåä»¥åç¼€åŠ  1 ç­‰æ•°å­—çš„å½¢å¼é€’å¢ã€‚ æ³¨æ„å•ä½æ˜¯ 1,000,000 å­—èŠ‚ã€‚
- -Wï¼šæŒ‡å®šè¾“å‡ºæ–‡ä»¶çš„æœ€å¤§æ•°é‡ï¼Œåˆ°è¾¾åä¼šé‡æ–°è¦†å†™ç¬¬ 1 ä¸ªæ–‡ä»¶ã€‚
- -Gï¼šæŒ‡å®šæ¯éš”Nç§’å°±é‡æ–°è¾“å‡ºè‡³æ–°æ–‡ä»¶ï¼Œæ³¨æ„-w å‚æ•°åº”åŸºäº
strftime å‚æ•°æŒ‡å®šæ–‡ä»¶åã€‚
- -rï¼šè¯»å–ä¸€ä¸ªæŠ“åŒ…æ–‡ä»¶ã€‚
- -Vï¼šå°†å¾…è¯»å–çš„å¤šä¸ªæ–‡ä»¶åå†™å…¥ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œé€šè¿‡è¯»å–è¯¥æ–‡ä»¶åŒæ—¶ è¯»å–å¤šä¸ªæ–‡ä»¶ã€‚


### 4ï¼‰ã€è¾“å‡ºæ—¶é—´æˆ³æ ¼å¼

- -tï¼šä¸æ˜¾ç¤ºæ—¶é—´æˆ³ã€‚
- -ttï¼šè‡ª1970å¹´1æœˆ1æ—¥0ç‚¹è‡³ä»Šçš„ç§’æ•°ã€‚
- -tttï¼šæ˜¾ç¤ºé‚»è¿‘ä¸¤è¡ŒæŠ¥æ–‡é—´ç»è¿‡çš„ç§’æ•°ã€‚
- -ttttï¼šå¸¦æ—¥æœŸçš„å®Œæ•´æ—¶é—´ã€‚
- -tttttï¼šè‡ªç¬¬ä¸€ä¸ªæŠ“å–çš„æŠ¥æ–‡èµ·ç»å†çš„ç§’æ•°ã€‚


### 5ï¼‰ã€åˆ†æä¿¡æ¯è¯¦æƒ…

- -eï¼šæ˜¾ç¤ºæ•°æ®é“¾è·¯å±‚å¤´éƒ¨ã€‚ 
- -qï¼šä¸æ˜¾ç¤ºä¼ è¾“å±‚ä¿¡æ¯ã€‚
- -vï¼šæ˜¾ç¤ºç½‘ç»œå±‚å¤´éƒ¨æ›´å¤šçš„ä¿¡æ¯ï¼Œå¦‚ TTLã€id ç­‰ã€‚
- -nï¼šæ˜¾ç¤º IP åœ°å€ã€æ•°å­—ç«¯å£ä»£æ›¿ hostname ç­‰ã€‚
- -Sï¼šTCP ä¿¡æ¯ä»¥ç»å¯¹åºåˆ—å·æ›¿ä»£ç›¸å¯¹åºåˆ—å·ã€‚
- -Aï¼šä»¥ ASCII æ–¹å¼æ˜¾ç¤ºæŠ¥æ–‡å†…å®¹ï¼Œé€‚ç”¨ HTTP åˆ†æã€‚
- -xï¼šä»¥ 16 è¿›åˆ¶æ–¹å¼æ˜¾ç¤ºæŠ¥æ–‡å†…å®¹ï¼Œä¸æ˜¾ç¤ºæ•°æ®é“¾è·¯å±‚ã€‚
- -xxï¼šä»¥ 16 è¿›åˆ¶æ–¹å¼æ˜¾ç¤ºæŠ¥æ–‡å†…å®¹ï¼Œæ˜¾ç¤ºæ•°æ®é“¾è·¯å±‚ã€‚
- -Xï¼šåŒæ—¶ä»¥ 16 è¿›åˆ¶åŠ ACII æ–¹å¼æ˜¾ç¤ºæŠ¥æ–‡å†…å®¹ï¼Œä¸æ˜¾ç¤ºæ•°æ®é“¾è·¯å±‚ â€¢ -XX åŒæ—¶ä»¥ 16 è¿›åˆ¶åŠ ACII æ–¹å¼æ˜¾ç¤ºæŠ¥æ–‡å†…å®¹ï¼Œæ˜¾ç¤ºæ•°æ®é“¾è·¯å±‚ã€‚


## 5ã€Stetho

- 1ï¼‰ã€åœ¨ build.gradle ä¸­ï¼Œé™¤äº† Stetho ä¾èµ–å¤–ï¼Œè¿˜éœ€æ·»åŠ  'com.facebook.stetho:stetho-okhttp3:1.5.0'ã€‚
- 2ï¼‰ã€åœ¨ Application çš„ onCreate æ–¹æ³•ä¸­åˆå§‹åŒ– 'Stetho.initializeWithDefaults(this)'ã€‚
- 3ï¼‰ã€è°ƒç”¨ OkHttp çš„ 'addNeworkInterceptor' æ–¹æ³•æ·»åŠ  Stetho ç”¨äºæ”¶é›†ç½‘ç»œä¿¡æ¯è€Œæä¾›çš„ç½‘ç»œæ‹¦æˆªå™¨ã€‚
- 4ï¼‰ã€è®¿é—® Chrome è°ƒè¯•é¡µé¢ 'chrome://inspect'ã€‚


## 6ã€å…¶å®ƒçš„æ€§èƒ½æ£€æµ‹å·¥å…·

- straceï¼šè·Ÿè¸ª Socket ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ã€‚
- netstatï¼šè®°å½•å¤šç§ç½‘ç»œæ ˆå’Œæ¥å£ç»Ÿè®¡ä¿¡æ¯ã€‚
- ifconfigï¼šè®°å½•æ¥å£é…ç½®ã€‚
- ipï¼šè®°å½•ç½‘ç»œæ¥å£ç»Ÿè®¡ä¿¡æ¯ã€‚
- pingï¼šæµ‹è¯•ç½‘ç»œè¿é€šæ€§ã€‚
- tracerouteï¼šæµ‹è¯•ç½‘ç»œè·¯ç”±ã€‚
- /proc/net å‘½ä»¤ï¼šæŸ¥çœ‹ç½‘ç»œç»Ÿè®¡ä¿¡æ¯ï¼ŒAndroid TrafficState ä½¿ç”¨äº† /proc/net/xt_qtaguid/stats å’Œ /proc/net/xt_qtaguid/iface_stat_fmt æ–‡ä»¶æ¥ç»Ÿè®¡ App çš„æµé‡ä¿¡æ¯ã€‚


# ä¸‰ã€ç²¾å‡†è·å–æµé‡æ¶ˆè€—

## 1ã€å¦‚ä½•åˆ¤æ–­ App æµé‡æ¶ˆè€—åé«˜ï¼Ÿ

- 1ï¼‰ã€ç»å¯¹å€¼çœ‹ä¸å‡ºé«˜ä½ã€‚
- 2ï¼‰ã€å¯¹æ¯”ç«å“ï¼Œç›¸åŒ Case å¯¹æ¯”æµæµªæ¶ˆè€—ã€‚
- 3ï¼‰ã€å¼‚å¸¸ç›‘æ§è¶…è¿‡æ­£å¸¸æŒ‡æ ‡ã€‚

## 2ã€æµ‹è¯•æ–¹æ¡ˆ

- 1ï¼‰ã€æ‰“å¼€æ‰‹æœºè®¾ç½® => æµé‡ç®¡ç† => ä»…å…è®¸ç›®æ ‡ App è”ç½‘
- 2ï¼‰ã€å¯ä»¥æŸ¥æ‰¾å‡ºå¤§å¤šæ•°çš„é—®é¢˜ï¼Œä½†æ˜¯çº¿ä¸Šåœºæ™¯çº¿ä¸‹å¯èƒ½é‡ä¸åˆ°ã€‚


## 3ã€çº¿ä¸Šæµé‡è·å–æ–¹æ¡ˆ

### 1ï¼‰ã€TrafficStats

#### ç‰¹ç‚¹

- API 18 ä»¥ä¸Šã€‚
- è®°å½•æ‰‹æœºé‡å¯ä»¥æ¥çš„æ•°æ®æµé‡ã€‚

#### API

- getMobileRxBytes()ï¼šé€šè¿‡èœ‚çªæµé‡æ¥æ”¶åˆ°çš„ä¿¡æ¯ã€‚
- getUidRxBytes(int uid)ï¼šè·å–æŒ‡å®š uid çš„æ¥æ”¶æµé‡ã€‚
- getTotalRxBytes()ï¼šæ€»å‘é€æµé‡ã€‚


#### ç¼ºç‚¹

æ— æ³•è·å–æŸä¸ªæ—¶é—´æ®µå†…çš„æµé‡æ¶ˆè€—ã€‚

### 2ï¼‰ã€NetworkStatsManager

API 23 ä¹‹åã€‚

#### ç‰¹ç‚¹

- 1ï¼‰ã€è·å–æŒ‡å®šæ—¶é—´é—´éš”å†…çš„æµé‡ä¿¡æ¯ã€‚
- 2ï¼‰ã€è·å–ä¸åŒç½‘ç»œç±»å‹ä¸‹çš„æ¶ˆè€—ã€‚


#### NetUtils.getStats 

è·å–æŒ‡å®šæ—¶é—´é—´éš”çš„ èœ‚çª + WIFI æµé‡æ€»ä¿¡æ¯


## 4ã€å‰åå°æµé‡è·å–æ–¹æ¡ˆ

### é—®é¢˜ï¼šçº¿ä¸Šåé¦ˆ App åå¤©æµé‡æ¶ˆè€—å¤§ï¼Ÿ

åªè·å–ä¸€ä¸ªæ—¶é—´æ®µçš„æµé‡ä¸å¤Ÿå…¨é¢ã€‚

### å®ç°åŸç†

> åå°å®šæ—¶ä»»åŠ¡ => è·å–æ—¶é—´é—´éš”å†…æµé‡ => è®°å½•å‰åå° => åˆ†åˆ«è®¡ç®— => ä¸ŠæŠ¥ APM åå° => æµé‡æ²»ç†ä¾æ®


### å°ç»“

- 1ï¼‰ã€è¯¥æ–¹æ¡ˆæ— æ³•è·å–åº”ç”¨åœ¨å‰åå°åˆ‡æ¢æ—¶çš„æµé‡ï¼Œå› æ­¤æœ‰ä¸€å®šçš„è¯¯å·®ï¼Œä½†è¿™ä¸ªè¯¯å·®æ˜¯å¯ä»¥æ¥å—çš„ã€‚
- 2ï¼‰ã€ç»“åˆç²¾ç»†åŒ–çš„æµé‡å¼‚å¸¸æŠ¥è­¦é’ˆå¯¹æ€§çš„è§£å†³åå°è·‘æµé‡çš„é—®é¢˜ã€‚


æˆåŠŸ log å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
2020-05-11 10:47:55.633 4036-4181/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ [MainActivity.java | 193 | lambda$initEventAndData$1$MainActivity] backNetUseData: 4 MB
2020-05-11 10:47:55.646 4036-4181/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ [MainActivity.java | 194 | lambda$initEventAndData$1$MainActivity] foreNetUseData: 4 MB
2020-05-11 10:47:55.652 4036-4181/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ [MainActivity.java | 197 | lambda$initEventAndData$1$MainActivity] totalNetUseData: 8 MB
```

 
# å››ã€ç½‘ç»œè¯·æ±‚æµé‡ä¼˜åŒ–

## 1ã€å¸¸è§ä½¿ç”¨ç½‘ç»œçš„åœºæ™¯

### 1ï¼‰ã€æ•°æ®å‹ç¼©

POST è¯·æ±‚ Body ä½¿ç”¨ GZip å‹ç¼©ï¼ŒåŒæ—¶æœåŠ¡ç«¯è¿”å› Body ä¹Ÿä½¿ç”¨ GZip å‹ç¼©ã€‚

### 2ï¼‰ã€å›¾ç‰‡

- å›¾ç‰‡ä¸Šä¼ å‰å‹ç¼©ã€‚
- å›¾ç‰‡ä½¿ç”¨ç­–ç•¥ç»†åŒ–ï¼šè®© æœåŠ¡ç«¯/CDN äº‘æœåŠ¡å™¨ ä¼˜å…ˆä½¿ç”¨ç¼©ç•¥å›¾/WebPæ ¼å¼å›¾ç‰‡ã€‚


### 3ï¼‰ã€æ€§èƒ½æ—¥å¿—ä¸ŠæŠ¥ï¼šæ‰¹é‡ + ç‰¹å®šåœºæ™¯ä¸ŠæŠ¥

APM ç›¸å…³ã€å•ç‚¹é—®é¢˜ç›¸å…³ã€‚ä¾‹å¦‚åŸ‹ç‚¹æ•°æ®å¯ä»¥ç­‰åˆ°æŸä¸€æ—¶æœºç‚¹ï¼ˆä¾‹å¦‚ å¼€å¯äº† WIFIã€æ•°æ®é‡è¿‡å¤§å¿…é¡»ä¸Šä¼ ä¸€éƒ¨åˆ†æ—¶ï¼‰å†ä¸Šä¼ ã€‚

### 4ï¼‰ã€æ•°æ®ç¼“å­˜

æœåŠ¡ç«¯è¿”å›åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œé¿å…æ¯æ¬¡é‡æ–°è·å–ã€‚
èŠ‚çº¦æµé‡ä¸”å¤§å¹…æé«˜æ•°æ®è®¿é—®é€Ÿåº¦ï¼Œæ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

#### Request ç¼“å­˜è®¾ç½®

- 1ã€Pragma:no-cacheï¼šå»æœåŠ¡å™¨æ‹‰å–æœ€æ–°çš„èµ„æºï¼Œä¸ä½¿ç”¨ç¼“å­˜ã€‚
- 2ã€If-Modified-Since:datetimeï¼šå¦‚æœèµ„æºåœ¨å®¢æˆ·ç«¯æä¾›çš„æ—¶é—´åå‘ç”Ÿæ”¹å˜ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›æ–°çš„èµ„æºï¼Œå¦åˆ™ä½¿ç”¨ç¼“å­˜ã€‚
- 3ã€If-None-Match:etagvalueï¼šå¦‚æœèµ„æºçš„æ ‡è¯†å’ŒæœåŠ¡å™¨çš„ä¸åŒï¼Œè¿”å›æ–°çš„èµ„æºã€‚


å½“ Request çš„å¤´éƒ¨æ˜¯ 2 å’Œ 3 æ—¶ï¼Œå¦‚æœæœåŠ¡å™¨çš„èµ„æºæ²¡æœ‰ä¿®æ”¹ï¼Œåˆ™æœåŠ¡å™¨ä¼šè¿”å› HTTP/304 Not Modifiedï¼Œå®¢æˆ·ç«¯ä¼šä½¿ç”¨ç¼“å­˜çš„ Responseã€‚

#### Response ç¼“å­˜è®¾ç½®

HTTP Response æ˜¯å¦å¯ä»¥ç¼“å­˜æ˜¯ç”± Response çš„å¤´éƒ¨æ§åˆ¶çš„ï¼ŒæœåŠ¡å™¨å¯ä»¥é€šè¿‡ Expires å’Œ Cache-Control æ§åˆ¶ Response å¦‚ä½•åœ¨å®¢æˆ·ç«¯ç¼“å­˜ã€‚

##### Expires

Expires å¤´éƒ¨ä¼šåŒ…å«ä¸€ä¸ªæ—¥æœŸï¼Œå³è¯¥èµ„æºç¼“å­˜çš„æœ‰æ•ˆæœŸï¼Œå®¢æˆ·ç«¯æœ‰æ–°çš„ç›¸åŒè¯·æ±‚æ—¶ï¼Œå¦‚æœèµ„æºç¼“å­˜æ²¡æœ‰è¿‡æœŸï¼Œåˆ™ä½¿ç”¨ç¼“å­˜èµ„æºï¼ŒæœåŠ¡å™¨ä¸ä¼šè¿”å›ä»»ä½•ä¸œè¥¿ã€‚

##### Cache-Control

Cache-Control å¯ä»¥æ ‡æ˜ Response å¦‚ä½•å­˜å‚¨åŠå…¶å¦‚ä½•ä½¿ç”¨ï¼Œå…¶é€‰é¡¹å¦‚ä¸‹æ‰€ç¤ºï¼š

- 1ï¼‰ã€publicï¼šResponse å¯ä»¥å­˜å‚¨åœ¨ä»»ä½• Cache ä¸­ï¼ŒåŒ…æ‹¬å…±äº«çš„ Cacheã€‚
- 2ï¼‰ã€privateï¼šResponse å­˜å‚¨åœ¨ç§æœ‰ Cache ä¸­ï¼Œåªèƒ½è¢«ä¸€ä¸ªç”¨æˆ·ä½¿ç”¨ã€‚
- 3ï¼‰ã€no-cacheï¼šResponse å°†æ¥ä¸ä¼šè¢«ä½¿ç”¨ã€‚
- 4ï¼‰ã€no-storeï¼šResponse å°†æ¥ä¸ä¼šè¢«ä½¿ç”¨ï¼Œä¹Ÿä¸ä¼šå†™åˆ°ç£ç›˜ä¸Šã€‚
- 5ï¼‰ã€max-age=#secondsï¼šResponse åœ¨è®¾å®šçš„æ—¶é—´å†…å¯ä»¥è¢«é‡å¤ä½¿ç”¨ã€‚
- 6ï¼‰ã€must-revalidateï¼šå’ŒåŸå§‹æœåŠ¡å™¨ç¡®è®¤ Response æ˜¯æœ€æ–°åï¼Œå¯ä»¥ä½¿ç”¨ç¼“å­˜ã€‚


#### OKHttp æ— ç½‘æ•°æ®ç¼“å­˜å®ç°

POST åœ¨ OKHttp ä¸­é»˜è®¤ä¸ä¼šç¼“å­˜ï¼Œå› ä¸º POST ä¸€èˆ¬æ˜¯ç”¨æ¥ä¿®æ”¹æ•°æ®çš„ã€‚åœ¨ Awesome-WanAndroid ä¸­çš„ HttpModuleâ€”cacheInterceptor ä¸­å°±å·²ç»å®ç°äº† OKHttp çš„æ— ç½‘æ•°æ®ç¼“å­˜ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
File cacheFile = new File(Constants.PATH_CACHE);
Cache cache = new Cache(cacheFile, 1024 * 1024 * 50);
Interceptor cacheInterceptor = chain -> {
    Request request = chain.request();
    if (!CommonUtils.isNetworkConnected()) {
        // æ— ç½‘æ—¶å¼ºåˆ¶ä½¿ç”¨æ•°æ®ç¼“å­˜ï¼Œä»¥æå‡ç”¨æˆ·ä½“éªŒã€‚
        request = request.newBuilder()
                .cacheControl(CacheControl.FORCE_CACHE)
                .build();
    }
    Response response = chain.proceed(request);
    if (CommonUtils.isNetworkConnected()) {
        int maxAge = 0;
        // æœ‰ç½‘ç»œæ—¶, ä¸ç¼“å­˜, æœ€å¤§ä¿å­˜æ—¶é•¿ä¸º0
        response.newBuilder()
                .header("Cache-Control", "public, max-age=" + maxAge)
                .removeHeader("Pragma")
                .build();
    } else {
        // æ— ç½‘ç»œæ—¶ï¼Œè®¾ç½®è¶…æ—¶ä¸º4å‘¨
        int maxStale = 60 * 60 * 24 * 28;
        response.newBuilder()
                .header("Cache-Control", "public, only-if-cached, max-stale=" + maxStale)
                .removeHeader("Pragma")
                .build();
    }
    return response;
};
// ç¼“å­˜ä¼˜åŒ–
builder.addNetworkInterceptor(cacheInterceptor);
builder.addInterceptor(cacheInterceptor);
builder.cache(cache);
```


### 5ï¼‰ã€ç¦»çº¿åŒ…ã€å¢é‡æ•°æ®æ›´æ–°

åŠ ä¸Šç‰ˆæœ¬çš„æ¦‚å¿µï¼Œä»…ä¼ è¾“æœ‰å˜åŒ–çš„æ•°æ®ã€‚

### 6ï¼‰ã€è¯·æ±‚å¤´å‹ç¼©

å¦‚æœè¯·æ±‚å¤´ä¸å˜ï¼ŒæœåŠ¡ç«¯å¯ä»¥ä½¿ç”¨æ˜ å°„ç¼“å­˜ è¯·æ±‚å¤´ MD5 : è¯·æ±‚å¤´ï¼Œä¹‹åè¯·æ±‚å¤´éƒ½ä½¿ç”¨ MD5 å³å¯ã€‚

### 7ï¼‰ã€ä¼˜åŒ–å‘é€é¢‘ç‡å’Œæ—¶æœº

### 8ï¼‰ã€åˆå¹¶ç½‘ç»œè¯·æ±‚ã€å‡å°‘è¯·æ±‚æ¬¡æ•°ã€‚

### 9ï¼‰ã€æµé‡å…œåº•èƒ½åŠ›

å¦‚æœå‘ç°æµé‡å¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå°æœåŠ¡å™¨ç»ˆæ­¢åè®®äº¤äº’ï¼Œä»¥é¿å…é—®é¢˜æ¶åŒ–ã€‚



## 2ã€æµé‡ç»Ÿè®¡

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ [network-connection-class](https://github.com/facebookarchive/network-connection-class) è¿›è¡Œæµé‡ç»Ÿè®¡ï¼Œå®ƒå†…éƒ¨ä½¿ç”¨çš„æ˜¯ API 8 çš„ TrafficStats ç±»ï¼Œç”¨äºè·å–æ•´ä¸ªæ‰‹æœºæˆ–è€…æŸä¸ª UID ä»å¼€æœºç®—èµ·çš„ç½‘ç»œæµé‡ã€‚


### 1ï¼‰ã€å››ä¸ªæ ¸å¿ƒ API

```java
// ä»å¼€æœºå¼€å§‹Mobileç½‘ç»œæ¥æ”¶çš„å­—èŠ‚æ€»æ•°ï¼Œä¸åŒ…æ‹¬Wifi
getMobileRxBytes()        
// ä»å¼€æœºå¼€å§‹æ‰€æœ‰ç½‘ç»œæ¥æ”¶çš„å­—èŠ‚æ€»æ•°ï¼ŒåŒ…æ‹¬Wifi
getTotalRxBytes()     
// ä»å¼€æœºå¼€å§‹Mobileç½‘ç»œå‘é€çš„å­—èŠ‚æ€»æ•°ï¼Œä¸åŒ…æ‹¬Wifi
getMobileTxBytes()        
// ä»å¼€æœºå¼€å§‹æ‰€æœ‰ç½‘ç»œå‘é€çš„å­—èŠ‚æ€»æ•°ï¼ŒåŒ…æ‹¬Wifi
getTotalTxBytes()         
```


### 2ï¼‰ã€å¯¹åº”çš„Linux å†…æ ¸ proc ç»Ÿè®¡æ¥å£

```java
// statsæ¥å£æä¾›å„ä¸ªuidåœ¨å„ä¸ªç½‘ç»œæ¥å£ï¼ˆwlan0, ppp0ç­‰ï¼‰çš„æµé‡ä¿¡æ¯
/proc/net/xt_qtaguid/stats
// iface_stat_fmtæ¥å£æä¾›å„ä¸ªæ¥å£çš„æ±‡æ€»æµé‡ä¿¡æ¯
proc/net/xt_qtaguid/iface_stat_fmt
```


### 3ï¼‰ã€å·¥ä½œåŸç†

- 1ï¼‰ã€è¯»å– procï¼Œå¹¶å°†ç›®æ ‡ UID ä¸‹é¢æ‰€æœ‰ç½‘ç»œæ¥å£çš„æµé‡ç›¸åŠ ã€‚
- 2ï¼‰ã€Android 7.0 ä¹‹ååªèƒ½é€šè¿‡ TrafficStats æ‹¿åˆ°è‡ªå·±åº”ç”¨çš„æµé‡ä¿¡æ¯ã€‚

ã€

# äº”ã€ç½‘ç»œè¯·æ±‚è´¨é‡ä¼˜åŒ–ï¼ˆğŸ”¥ï¼‰

## 1ã€Http è¯·æ±‚è¿‡ç¨‹

- 1ï¼‰ã€è¯·æ±‚åˆ°è¾¾è¿è¥å•†çš„ **DNS** æœåŠ¡å™¨å¹¶* *è§£æ** æˆå¯¹åº”çš„ IP åœ°å€ã€‚
    - **HTTPDNS**
- 2ï¼‰ã€æ ¹æ® IP åœ°å€æ‰¾åˆ°ç›¸åº”çš„æœåŠ¡å™¨ï¼Œè¿›è¡Œ TCP ä¸‰æ¬¡æ¡æ‰‹ï¼Œ**åˆ›å»ºè¿æ¥**ã€‚
    - **è¿æ¥å¤ç”¨**
    - **ç½‘ç»œåº“çš„è¿æ¥ç®¡ç†**
- 3ï¼‰ã€å‘é€/æ¥æ”¶æ•°æ®ã€‚
    - **å‹ç¼©**
    - **åŠ å¯†**
- 4ï¼‰ã€å…³é—­è¿æ¥ã€‚


## 2ã€HTTPDNS

> é—®é¢˜ï¼šDNS è§£ææ…¢/è¢«åŠ«æŒï¼Ÿ

ä½¿ç”¨ HTTPDSNï¼ŒHTTPDNS ä¸æ˜¯ä½¿ç”¨ DNS åè®®ï¼Œå‘ DNS æœåŠ¡å™¨ä¼ ç»Ÿçš„ 53 ç«¯å£å‘é€è¯·æ±‚ï¼Œè€Œæ˜¯ä½¿ç”¨ HTTP åè®®å‘ DSN æœåŠ¡å™¨çš„ 80 ç«¯å£å‘é€è¯·æ±‚ã€‚

### 1ï¼‰ã€HTTPDNS ä¼˜åŠ¿

- 1ã€ç»•è¿‡è¿è¥å•†åŸŸåè§£æçš„è¿‡ç¨‹ï¼Œé¿å… Local DNS çš„åŠ«æŒã€‚
- 2ã€é™ä½å¹³å‡è®¿é—®æ—¶å»¶ï¼Œæä¾›è¿æ¥æˆåŠŸç‡ã€‚
- 3ã€HTTPDNS æœåŠ¡å™¨ä¼šå¢åŠ æµé‡è°ƒåº¦ã€ç½‘ç»œæ‹¨æµ‹/ç°åº¦ã€ç½‘ç»œå®¹ç¾ç­‰åŠŸèƒ½ã€‚


### 2ï¼‰ã€HTTPDNS + OKHttp å®è·µ

åœ¨ Awesome-WanAndroid ä¸­å·²ç»å®ç°äº† HTTPDNS ä¼˜åŒ–ï¼Œå…¶ä¼˜åŒ–ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
// HttpModule-provideClientï¼šhttpDns ä¼˜åŒ–
builder.dns(OkHttpDns.getIns(WanAndroidApp.getAppComponent().getContext()));

/**
 * FileName: OkHttpDNS
 * Date: 2020/5/8 16:08
 * Description: HttpDns ä¼˜åŒ–
 * @author JsonChao
 */
public class OkHttpDns implements Dns {

    private HttpDnsService dnsService;
    private static OkHttpDns instance = null;

    private OkHttpDns(Context context) {
        dnsService = HttpDns.getService(context, "161133");
        // 1ã€è®¾ç½®é¢„è§£æçš„ IP ä½¿ç”¨ Https è¯·æ±‚ã€‚
        dnsService.setHTTPSRequestEnabled(true);
        // 2ã€é¢„å…ˆæ³¨å†Œè¦ä½¿ç”¨åˆ°çš„åŸŸåï¼Œä»¥ä¾¿ SDK æå‰è§£æï¼Œå‡å°‘åç»­è§£æåŸŸåæ—¶è¯·æ±‚çš„æ—¶å»¶ã€‚
        ArrayList<String> hostList = new ArrayList<>(Arrays.asList("www.wanandroid.com"));
        dnsService.setPreResolveHosts(hostList);
    }

    public static OkHttpDns getIns(Context context) {
        if (instance == null) {
            synchronized (OkHttpDns.class) {
                if (instance == null) {
                    instance = new OkHttpDns(context);
                }
            }
        }
        return instance;
    }

    @Override
    public List<InetAddress> lookup(String hostname) throws UnknownHostException {
        String ip = dnsService.getIpByHostAsync(hostname);
        LogHelper.i("httpDns: " + ip);
        if(ip != null){
            List<InetAddress> inetAddresses = Arrays.asList(InetAddress.getAllByName(ip));
            return inetAddresses;
        }
        // 3ã€å¦‚æœä»é˜¿é‡Œäº‘ DNS æœåŠ¡å™¨è·å–ä¸åˆ° ip åœ°å€ï¼Œåˆ™èµ°è¿è¥å•†åŸŸåè§£æçš„è¿‡ç¨‹ã€‚
        return Dns.SYSTEM.lookup(hostname);
    }
}
```


é‡æ–°å®‰è£… Appï¼Œé€šè¿‡ HTTPDNS è·å–åˆ° IP åœ°å€ log å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
2020-05-11 10:41:55.139 4036-4184/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ [OkHttpDns.java | 52 | lookup] httpDns: 47.104.74.169
2020-05-11 10:41:55.142 4036-4185/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ [OkHttpDns.java | 52 | lookup] httpDns: 47.104.74.169
```


## 3ã€ç½‘ç»œåº“çš„è¿æ¥ç®¡ç†

åˆ©ç”¨ HTTP åè®®çš„ keep-aliveï¼Œå»ºç«‹è¿æ¥åï¼Œä¼šå…ˆå°†è¿æ¥æ”¾å…¥è¿æ¥æ± ä¸­ï¼Œå¦‚æœæœ‰å¦ä¸€ä¸ªè¯·æ±‚çš„åŸŸåå’Œç«¯å£æ˜¯ä¸€æ ·çš„ï¼Œå°±ç›´æ¥ä½¿ç”¨è¿æ¥æ± ä¸­å¯¹åº”çš„è¿æ¥å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚åœ¨å®ç°ç½‘ç»œåº“çš„è¿æ¥ç®¡ç†æ—¶éœ€è¦æ³¨æ„ä»¥ä¸‹4ç‚¹ï¼š

- 1ï¼‰ã€åŒä¸€ä¸ªè¿æ¥ä»…æ”¯æŒåŒä¸€ä¸ªåŸŸåã€‚
- 2ï¼‰ã€åç«¯æ”¯æŒ HTTP 2.0 éœ€è¦æ”¹é€ ï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡åœ¨ç½‘ç»œå¹³å°çš„ç»Ÿä¸€æ¥å…¥å±‚å°†æ•°æ®è½¬æ¢åˆ° HTTP 1.1 åå†è½¬å‘åˆ°å¯¹åº”åŸŸåçš„æœåŠ¡å™¨å³å¯ã€‚
- 3ï¼‰ã€å½“æ‰€æœ‰è¯·æ±‚éƒ½é›†ä¸­åœ¨ä¸€æ¡è¿æ¥ä¸­æ—¶ï¼Œåœ¨ç½‘ç»œæ‹¥å¡æ—¶å®¹æ˜“å‡ºç° TCP é˜Ÿé¦–é˜»å¡é—®é¢˜ã€‚
- 4ï¼‰ã€åœ¨æ–‡ä»¶ä¸‹è½½ã€è§†é¢‘æ’­æ”¾ç­‰åœºæ™¯ä¸‹å¯èƒ½ä¼šé‡åˆ°ä¸‰æ–¹æœåŠ¡å™¨å•è¿æ¥é™é€Ÿçš„é—®é¢˜ï¼Œæ­¤æ—¶å¯ä»¥ç¦ç”¨ HTTP 2.0ã€‚


## 4ã€åè®®ç‰ˆæœ¬å‡çº§

### HTTP 1.0

TCP è¿æ¥ä¸å¤ç”¨ï¼Œä¹Ÿå°±æ˜¯æ¯å‘èµ·ä¸€ä¸ªç½‘ç»œè¯·æ±‚éƒ½è¦é‡æ–°å»ºç«‹è¿æ¥ï¼Œè€Œåˆšå¼€å§‹è¿æ¥éƒ½ä¼šç»å†ä¸€ä¸ªæ…¢å¯åŠ¨çš„è¿‡ç¨‹ï¼Œå¯è°“æ˜¯æ…¢ä¸ŠåŠ æ…¢ï¼Œå› æ­¤ HTTP 1.0 æ€§èƒ½éå¸¸å·®ã€‚

### HTTP 1.1

å¼•å…¥äº†æŒä¹…è¿æ¥ï¼Œå³ TCP è¿æ¥å¯ä»¥å¤ç”¨ï¼Œä½†æ•°æ®é€šä¿¡å¿…é¡»æŒ‰æ¬¡åºæ¥ï¼Œä¹Ÿå°±æ˜¯åé¢çš„è¯·æ±‚å¿…é¡»ç­‰å‰é¢çš„è¯·æ±‚å®Œæˆæ‰èƒ½è¿›è¡Œã€‚å½“æ‰€æœ‰è¯·æ±‚éƒ½é›†ä¸­åœ¨ä¸€æ¡è¿æ¥ä¸­æ—¶ï¼Œåœ¨ç½‘ç»œæ‹¥å¡æ—¶å®¹æ˜“å‡ºç° TCP é˜Ÿé¦–é˜»å¡é—®é¢˜ã€‚

### HTTP 2

- äºŒè¿›åˆ¶åè®®
- å¤šå·¥
- æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯å¯ä»¥åŒå‘å®æ—¶é€šä¿¡ã€‚


### QUIC

Google 2013 å®ç°ï¼Œ2018 åŸºäº QUIC åè®®çš„ HTTP è¢«ç¡®è®¤ä¸º HTTP3ã€‚

QUIC ç®€å•ç†è§£ä¸º HTTP/2.0 + TLS 1.3 + UDPã€‚å¼±ç½‘ç¯å¢ƒä¸‹è¡¨ç°å¥½ä¸ TCPã€‚

#### ä¼˜åŠ¿

- 1ï¼‰ã€è§£å†³äº†åœ¨è¿æ¥å¤ç”¨ä¸­ HTTP2 + TCP å­˜åœ¨çš„é˜Ÿé¦–é˜»å¡é—®é¢˜ï¼Œ
- 2ï¼‰ã€ç”±äºæ˜¯åŸºäº UDPï¼Œæ‰€ä»¥å¯ä»¥çµæ´»æ§åˆ¶æ‹¥å¡åè®®ã€‚ä¾‹å¦‚ Client ç«¯å¯ä»¥ç›´æ¥ä½¿ç”¨ Google çš„ [BBR ç®—æ³•](https://queue.acm.org/detail.cfm?id=3022184)ã€‚
- 3ï¼‰ã€è¿æ¥è¿ï¼šç”±äº UDP é€šè¿‡ç±»ä¼¼connection id çš„ç‰¹æ€§,ä½¿å¾—å®¢æˆ·ç«¯ç½‘ç»œåˆ‡æ¢çš„æ—¶å€™ä¸éœ€è¦é‡è¿ï¼Œç”¨æˆ·ä½¿ç”¨ App çš„ä½“éªŒä¼šæ›´åŠ æµç•…ã€‚


#### ç›®å‰çš„ç¼ºç‚¹

- 1ï¼‰ã€NAT å±€åŸŸç½‘è·¯ç”±ã€äº¤æ¢æœºã€é˜²ç«å¢™ç­‰ä¼šç¦æ­¢ UDP 443 é€šè¡Œï¼Œå› æ­¤ QUIC åˆ›å»ºè¿æ¥æˆåŠŸç‡åªæœ‰95%ã€‚
- 2ï¼‰ã€è¿è¥å•†é’ˆå¯¹ UDP é€šé“ä¸æ”¯æŒ/æ”¯æŒä¸è¶³ã€‚
- 3ï¼‰ã€ä½¿ç”¨ UDP ä¸ä¸€å®šä¼šæ¯” TCP æ›´å¿«ï¼Œå®¢æˆ·ç«¯å¯åŒæ—¶ä½¿ç”¨ TCP å’Œ QUIC ç«é€Ÿï¼Œä»è€Œé€‰æ‹©æ›´ä¼˜é“¾è·¯ã€‚


#### ä½¿ç”¨åœºæ™¯

- 1ï¼‰ã€å®æ—¶æ€§
- 2ï¼‰ã€å¯ä¸¢å¼ƒ
- 3ï¼‰ã€è¯·æ±‚äº’ç›¸ä¾èµ–
- 4ï¼‰ã€å¯åŒæ—¶ä½¿ç”¨ TCP & QUIC


#### QUIC åŠ å¯†åè®®åŸç†

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc56664e2a6b?w=1332&h=398&f=png&s=322001)


- 1ï¼‰ã€å½“ Client ä¸ Server ç¬¬ä¸€æ¬¡é€šä¿¡æ—¶ï¼Œä¼šå‘é€ Inchoate Client Hello æ¶ˆæ¯ä¸‹è½½ Server Configï¼ˆSCFG) æš‚å­˜æ¶ˆæ¯ã€‚
- 2ï¼‰ã€SCFG ä¸­åŒ…å«ä¸€ä¸ª Diffie-Hellman å…±äº«ï¼Œä¸‹ä¸€æ¬¡ Client å°†ä½¿ç”¨å®ƒæ´¾ç”Ÿåˆå§‹å¯†é’¥ï¼ˆå³ 0-RTT å¯†é’¥ï¼‰å¹¶åˆ©ç”¨å…¶åŠ å¯†æ•°æ®ç»™ Serverã€‚
- 3ï¼‰ã€ä¹‹åï¼ŒServer å°†å‘å‡ºä¸€ä¸ªæ–°çš„æš‚å­˜ Diffie-Hellman å…±äº«ï¼Œå¹¶ç”±æ­¤æ´¾ç”Ÿå‡ºä¸€ç»„ å‰å‘å®‰å…¨å¯†é’¥å»è¿›è¡Œæ•°æ®çš„åŠ å¯†é€šä¿¡ã€‚


## 5ã€ç½‘ç»œè¯·æ±‚è´¨é‡ç›‘æ§

### 1ï¼‰ã€æ¥å£è¯·æ±‚è€—æ—¶ã€æˆåŠŸç‡ã€é”™è¯¯ç 

åœ¨ Awesome-WanAndroid ä¸­å·²ç»ä½¿ç”¨ OkHttpEventListener å®ç°äº†ç½‘ç»œè¯·æ±‚çš„è´¨é‡ç›‘æ§ï¼Œå…¶ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
// ç½‘ç»œè¯·æ±‚è´¨é‡ç›‘æ§
builder.eventListenerFactory(OkHttpEventListener.FACTORY);

/**
 * FileName: OkHttpEventListener
 * Date: 2020/5/8 16:28
 * Description: OkHttp ç½‘ç»œè¯·æ±‚è´¨é‡ç›‘æ§
 * @author quchao
 */
public class OkHttpEventListener extends EventListener {

    public static final Factory FACTORY = new Factory() {
        @Override
        public EventListener create(Call call) {
            return new OkHttpEventListener();
        }
    };

    OkHttpEvent okHttpEvent;
    public OkHttpEventListener() {
        super();
        okHttpEvent = new OkHttpEvent();
    }

    @Override
    public void callStart(Call call) {
        super.callStart(call);
        LogHelper.i("okHttp Call Start");
        okHttpEvent.callStartTime = System.currentTimeMillis();
    }

    /**
     * DNS è§£æå¼€å§‹
     *
     * @param call
     * @param domainName
     */
    @Override
    public void dnsStart(Call call, String domainName) {
        super.dnsStart(call, domainName);
        okHttpEvent.dnsStartTime = System.currentTimeMillis();
    }

    /**
     * DNS è§£æç»“æŸ
     *
     * @param call
     * @param domainName
     * @param inetAddressList
     */
    @Override
    public void dnsEnd(Call call, String domainName, List<InetAddress> inetAddressList) {
        super.dnsEnd(call, domainName, inetAddressList);
        okHttpEvent.dnsEndTime = System.currentTimeMillis();
    }

    @Override
    public void connectStart(Call call, InetSocketAddress inetSocketAddress, Proxy proxy) {
        super.connectStart(call, inetSocketAddress, proxy);
        okHttpEvent.connectStartTime = System.currentTimeMillis();
    }

    @Override
    public void secureConnectStart(Call call) {
        super.secureConnectStart(call);
        okHttpEvent.secureConnectStart = System.currentTimeMillis();
    }

    @Override
    public void secureConnectEnd(Call call, @Nullable Handshake handshake) {
        super.secureConnectEnd(call, handshake);
        okHttpEvent.secureConnectEnd = System.currentTimeMillis();
    }

    @Override
    public void connectEnd(Call call, InetSocketAddress inetSocketAddress, Proxy proxy, @Nullable Protocol protocol) {
        super.connectEnd(call, inetSocketAddress, proxy, protocol);
        okHttpEvent.connectEndTime = System.currentTimeMillis();
    }

    @Override
    public void connectFailed(Call call, InetSocketAddress inetSocketAddress, Proxy proxy, @Nullable Protocol protocol, IOException ioe) {
        super.connectFailed(call, inetSocketAddress, proxy, protocol, ioe);
    }

    @Override
    public void connectionAcquired(Call call, Connection connection) {
        super.connectionAcquired(call, connection);
    }

    @Override
    public void connectionReleased(Call call, Connection connection) {
        super.connectionReleased(call, connection);
    }

    @Override
    public void requestHeadersStart(Call call) {
        super.requestHeadersStart(call);
    }

    @Override
    public void requestHeadersEnd(Call call, Request request) {
        super.requestHeadersEnd(call, request);
    }

    @Override
    public void requestBodyStart(Call call) {
        super.requestBodyStart(call);
    }

    @Override
    public void requestBodyEnd(Call call, long byteCount) {
        super.requestBodyEnd(call, byteCount);
    }

    @Override
    public void responseHeadersStart(Call call) {
        super.responseHeadersStart(call);
    }

    @Override
    public void responseHeadersEnd(Call call, Response response) {
        super.responseHeadersEnd(call, response);
    }

    @Override
    public void responseBodyStart(Call call) {
        super.responseBodyStart(call);
    }

    @Override
    public void responseBodyEnd(Call call, long byteCount) {
        super.responseBodyEnd(call, byteCount);
        // è®°å½•å“åº”ä½“çš„å¤§å°
        okHttpEvent.responseBodySize = byteCount;
    }

    @Override
    public void callEnd(Call call) {
        super.callEnd(call);
        okHttpEvent.callEndTime = System.currentTimeMillis();
        // è®°å½• API è¯·æ±‚æˆåŠŸ
        okHttpEvent.apiSuccess = true;
        LogHelper.i(okHttpEvent.toString());
    }

    @Override
    public void callFailed(Call call, IOException ioe) {
        LogHelper.i("callFailed ");
        super.callFailed(call, ioe);
        // è®°å½• API è¯·æ±‚å¤±è´¥åŠåŸå› 
        okHttpEvent.apiSuccess = false;
        okHttpEvent.errorReason = Log.getStackTraceString(ioe);
        LogHelper.i("reason " + okHttpEvent.errorReason);
        LogHelper.i(okHttpEvent.toString());
    }
}
```


æˆåŠŸ log å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
2020-05-11 11:00:42.678 6682-6847/json.chao.com.wanandroid D/OkHttp: --> GET https://www.wanandroid.com/banner/json
2020-05-11 11:00:42.687 6682-6848/json.chao.com.wanandroid I/WanAndroid-LOG: â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2020-05-11 11:00:42.688 6682-6848/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ Thread: RxCachedThreadScheduler-3
2020-05-11 11:00:42.688 6682-6848/json.chao.com.wanandroid I/WanAndroid-LOG: â”œâ”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„
2020-05-11 11:00:42.688 6682-6848/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ OkHttpEventListener.callStart  (OkHttpEventListener.java:46)
2020-05-11 11:00:42.688 6682-6848/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚    LogHelper.i  (LogHelper.java:37)
2020-05-11 11:00:42.688 6682-6848/json.chao.com.wanandroid I/WanAndroid-LOG: â”œâ”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„
2020-05-11 11:00:42.688 6682-6848/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ [OkHttpEventListener.java | 46 | callStart] okHttp Call Start
2020-05-11 11:00:42.688 6682-6848/json.chao.com.wanandroid I/WanAndroid-LOG: â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2020-05-11 11:00:43.485 6682-6847/json.chao.com.wanandroid D/OkHttp: <-- 200 OK https://www.wanandroid.com/banner/json (806ms, unknown-length body)
2020-05-11 11:00:43.496 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2020-05-11 11:00:43.498 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ Thread: RxCachedThreadScheduler-2
2020-05-11 11:00:43.498 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”œâ”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„
2020-05-11 11:00:43.498 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ OkHttpEventListener.callEnd  (OkHttpEventListener.java:162)
2020-05-11 11:00:43.498 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚    LogHelper.i  (LogHelper.java:37)
2020-05-11 11:00:43.498 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”œâ”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„
2020-05-11 11:00:43.498 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ [OkHttpEventListener.java | 162 | callEnd] NetData: [
2020-05-11 11:00:43.498 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ callTime: 817
2020-05-11 11:00:43.498 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ dnsParseTime: 6
2020-05-11 11:00:43.498 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ connectTime: 721
2020-05-11 11:00:43.499 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ secureConnectTime: 269
2020-05-11 11:00:43.499 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ responseBodySize: 975
2020-05-11 11:00:43.499 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ apiSuccess: true
2020-05-11 11:00:43.499 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â”‚ ]
2020-05-11 11:00:43.499 6682-6847/json.chao.com.wanandroid I/WanAndroid-LOG: â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```


### 2ï¼‰ã€æ ¹æ®ç½‘ç»œè´¨é‡æ¥åŠ¨æ€è®¾å®šç½‘ç»œæœåŠ¡çš„é‡è¦å‚æ•°ï¼ˆè¶…æ—¶ã€å¹¶å‘çº¿ç¨‹æ•°ï¼‰

- æ ¹æ®ç”¨æˆ· 2G/3G/4G/WIFI çš„ç½‘ç»œç¯å¢ƒã€‚
- æ ¹æ®ç”¨æˆ·å½“å‰ç½‘ç»œçš„ RTTã€‚


## 6ã€å‹ç¼©

### 1ï¼‰ã€headerï¼ˆHTTP 2.0 å¤´éƒ¨å‹ç¼©ï¼‰

è§ [æ·±å…¥æ¢ç´¢ Android ç½‘ç»œä¼˜åŒ–ï¼ˆäºŒã€ç½‘ç»œä¼˜åŒ–åŸºç¡€ç¯‡ï¼‰ä¸‹ - é¦–éƒ¨å‹ç¼©](https://juejin.im/post/5ecda2b6f265da77084772a1#heading-55)ã€‚

### 2ï¼‰ã€URL

ä¸å˜å‚æ•°å®¢æˆ·ç«¯åªéœ€ä¸Šä¼ ä»¥æ­¤ï¼Œå…¶å®ƒå‚æ•°å‡åœ¨æ¥å…¥å±‚è¿›è¡Œæ‰©å±•ã€‚


### 3ï¼‰ã€body

ä½¿ç”¨ Protocol Buffers æ›¿ä»£ JSON åºåˆ—åŒ–ã€‚


### 4ï¼‰ã€å›¾ç‰‡

- 1ï¼‰ã€webp
- 2ï¼‰ã€hevc
- 3ï¼‰ã€SharpP
- 4ï¼‰ã€åŸºäº AI çš„å›¾ç‰‡è¶…æ¸…åŒ–
    - æ·±åº¦å­¦ä¹  CNNï¼ˆConvolutional Neural Networkï¼Œå·ç§¯ç¥ç»ç½‘ç»œï¼‰ã€‚
    - CNN å­¦ä¹ åˆ°çš„æ˜¯é«˜åˆ†è¾¨ç‡å›¾åƒå’Œä½åˆ†è¾¨ç‡å›¾åƒçš„å·®ã€‚


### 5ï¼‰ã€å‹ç¼©ç®—æ³•

- 1ï¼‰ã€GZIP
- 2ï¼‰ã€[Google Brotli](https://github.com/google/brotli)
- 3ï¼‰ã€[Facebook Z-standardï¼ˆæ¨èï¼‰](https://github.com/facebook/zstd)ï¼šé€šè¿‡ä¸šåŠ¡æ•°æ®æ ·æœ¬è®­ç»ƒå¤„åˆé€‚çš„å­—å…¸ï¼Œå› æ­¤æ˜¯å‹ç¼©ç‡æœ€å¥½çš„ç®—æ³•ï¼Œç”±äºå„ä¸šåŠ¡çº¿ç»´æŠ¤å­—å…¸æˆæœ¬è¾ƒå¤§ï¼Œå¯ä»¥åœ¨ç½‘ç»œå¹³å°çš„ç»Ÿä¸€æ¥å…¥å±‚è¿›è¡Œå‹ç¼©ä¸è§£å‹ã€‚æˆ‘ä»¬å¯ä»¥æŠ½æ ·1%çš„æ•°æ®æ¥è®­ç»ƒå­—å…¸ï¼Œè€Œå­—å…¸çš„ä¸‹å‘ä¸æ›´æ–°ç”±ç»Ÿä¸€æ¥å…¥å±‚è´Ÿè´£ã€‚


## 7ã€åŠ å¯†

HTTPS é€šå¸¸éœ€è¦å¤šæ¶ˆè€— 2 RTT çš„åå•†æ—¶å»¶ã€‚

### 1ï¼‰ã€HTTPS ä¼˜åŒ–

#### 1ã€æé«˜è¿æ¥å¤ç”¨ç‡

- 1ï¼‰ã€å¤šä¸ªåŸŸåå…±ç”¨åŒä¸€ä¸ª HTTP2 è¿æ¥ã€‚
- 2ï¼‰ã€é•¿è¿æ¥ã€‚


#### 2ã€å‡å°‘æ¡æ‰‹æ¬¡æ•°ï¼ˆTLS 1.3 å®ç° 0 RTT åå•†ï¼‰

TLS 1.2 å¼•å…¥äº† SHA-256 å“ˆå¸Œç®—æ³•ï¼Œæ‘’å¼ƒäº† SHA-1ï¼Œå¯¹å¢å¼ºæ•°æ®å®Œæ•´æ€§æœ‰ç€æ˜¾è‘—ä¼˜åŠ¿ã€‚

IETFï¼ˆInternet Engineering Task Froceï¼Œäº’è”ç½‘å·¥ç¨‹ä»»åŠ¡ç»„ï¼‰åˆ¶å®šçš„ TLS 1.3 æ˜¯æœ‰å²ä»¥æ¥æœ€å®‰å…¨ã€å¤æ‚çš„ TLS åè®®ã€‚å®ƒå…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š

##### 1ï¼‰ã€æ›´å¿«çš„è®¿é—®é€Ÿåº¦

ç›¸æ¯”äº TLS 1.2 åŠä¹‹å‰çš„ç‰ˆæœ¬ï¼ŒTLS 1.3 çš„æ¡æ‰‹ä¸å†æ”¯æŒé™æ€çš„ RSA å¯†é’¥äº¤æ¢ï¼Œä½¿ç”¨çš„æ˜¯å¸¦æœ‰å‰å‘å®‰å…¨çš„ Diffie-Hellman è¿›è¡Œå…¨é¢æ¡æ‰‹ã€‚å› æ­¤ TLS 1.3 åªéœ€ 1-RTT æ¡æ‰‹æ—¶é—´ã€‚

##### 2ï¼‰ã€æ›´å¼ºçš„å®‰å…¨æ€§

åˆ é™¤äº†ä¹‹å‰ç‰ˆæœ¬çš„ä¸å®‰å…¨çš„åŠ å¯†ç®—æ³•ã€‚

- 1ï¼‰ã€RSA å¯†é’¥ä¼ è¾“ï¼šä¸æ”¯æŒå‰å‘å®‰å…¨æ€§ã€‚
- 2ï¼‰ã€CBC æ¨¡å¼å¯†ç ï¼šæ˜“å— BEAST å’Œ Lucky 13 æ”»å‡»ã€‚
- 3ï¼‰ã€RC4 æµå¯†ç ï¼šåœ¨ HTTPS ä¸­ä½¿ç”¨å¹¶ä¸å®‰å…¨ã€‚
- 4ï¼‰ã€SHA-1 å“ˆå¸Œå‡½æ•°ï¼šå»ºè®®ä»¥ SHA-2 æ›¿ä»£ã€‚
- 5ï¼‰ã€ä»»æ„ Diffie-Hellman ç»„ï¼šCVE-2016-0701 æ¼æ´ã€‚
- 6ï¼‰ã€è¾“å‡ºå¯†ç ï¼šæ˜“å— FREAK å’Œ LogJam æ”»å‡»ã€‚


æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ [Google æµè§ˆå™¨è®¾ç½® TLS 1.3](chrome://flags/#tls13-hardening-for-local-anchors)ã€‚

#### 3ã€slight-ssl

å‚è€ƒ TLS 1.3 åè®®ï¼Œåˆå¹¶è¯·æ±‚ï¼Œä¼˜åŒ–åŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨ session-ticket ç­‰ç­–ç•¥ï¼ŒåŠ›æ±‚åœ¨å®‰å…¨å’Œä½“éªŒé—´æ‰¾åˆ°ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚

åœ¨ TLS ä¸­æ€§èƒ½å¼€é”€æœ€å¤§çš„æ˜¯ TLS æ¡æ‰‹é˜¶æ®µçš„ RSA åŠ è§£å¯†ã€‚åœ¨ slight-ssl ä¸­åˆå°è¯•å¦‚ä¸‹å‡ ç§è§£å†³æ–¹æ¡ˆï¼š

- 1ï¼‰ã€ç¡¬ä»¶åŠ é€Ÿï¼šä½¿ç”¨å•ç‹¬çš„ç¡¬ä»¶åŠ é€Ÿå¡å¤„ç† RSA åŠ è§£å¯†ã€‚
- 2ï¼‰ã€ECDSAï¼šECSDSA æœ€åº•å±‚çš„ç®—æ³•å’Œæˆæœ¬å¯¹æ€§èƒ½çš„æ¶ˆè€—è¿œä½äº RSAï¼Œç›¸å·®5~6å€ã€‚
- 3ï¼‰ã€Session Ticket æœºåˆ¶ï¼šå°† TLS æ¡æ‰‹ä» 2RTT é™ä½ä¸º 1RTTã€‚



#### 4ã€å¾®ä¿¡ mmtls åŸç†

åŸºäº TLS 1.3 è‰æ¡ˆæ ‡å‡†è€Œå®ç°ã€‚

ç±»ä¼¼äº TLS åè®®ï¼Œmmtls åè®®ä¹Ÿæ˜¯ä½äºä¸šåŠ¡å±‚ä¸ç½‘ç»œè¿æ¥å±‚ä¸­é—´ã€‚

##### mmtls åè®®ç»„æˆå›¾

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc5a1f6b416e?w=1352&h=436&f=png&s=161442)


- 1ï¼‰ã€Handshakeã€Alert å’Œ Application Protocol éƒ½æ˜¯ record åè®®çš„ä¸Šå±‚åè®®ã€‚
- 2ï¼‰ã€Record åè®®åŒ…ä¸­æœ‰å­—æ®µç”¨äºåŒºåˆ†å™¨ä¸Šå±‚åè®®æ˜¯ä¸Šè¿°3ç§ä»»ä¸€åè®®ã€‚
- 3ï¼‰ã€åœ¨ mmtls/TLS ä¸­Handshake å­åè®®è´Ÿè´£å¯†é’¥åå•†ï¼Œ Record å­åè®®è´Ÿè´£æ•°æ®å¯¹ç§°åŠ å¯†ä¼ è¾“ã€‚é™¤äº†æ€§èƒ½ä¸æ•ˆç‡çš„å› ç´ ä¹‹å¤–ï¼Œæ›´åˆ©äºéš”ç¦»å¤æ‚æ€§ã€‚


##### Handshake åè®®

TLS 1.3 Handshake åè®®æœ‰å¦‚ä¸‹å‡ ç±»ï¼š

- 1-RTT å¯†é’¥åå•†æ–¹å¼
    - 1-RTT ECDHE
    - 1-RTT PSKï¼ˆPre-Shared Keyï¼‰
- 0-RTT å¯†é’¥åå•†æ–¹å¼
    - 0-RTT PSK
    - 0-RTT ECDH
    - 0-RTT PSK-ECDHE
    - 0-RTT ECDH-ECDHE


è€Œ mmtls Handshake åè®®æœ‰å¦‚ä¸‹å‡ ç§ï¼š

- 1-RTT ECDHE
- 1-RTT PSK
- 0-RTT PSK


**1-RTT ECDHE å¯†é’¥åå•†åŸç†**

ECDH å¯†é’¥äº¤æ¢åè®®éœ€è¦ä½¿ç”¨ä¸¤ä¸ªç®—æ³•ï¼š

- 1ï¼‰ã€å¯†é’¥ç”Ÿæˆç®—æ³• ECDH_Generate_Keyï¼šç”Ÿæˆå…¬ç§é’¥å¯¹ï¼ˆECDH_pub_keyã€ECDH_pri_key)ï¼Œå…¶ä¸­ä¿å­˜ç§é’¥ï¼Œå°†å…¬é’¥äº’ç›¸å‘é€ç»™å¯¹æ–¹ã€‚
- 2ï¼‰ã€å¯†é’¥åå•†ç®—æ³• ECDH_compute_keyï¼šè¾“å…¥å¯¹æ–¹å…¬é’¥ä¸è‡ªèº«ç§é’¥ï¼Œè®¡ç®—å‡ºé€šä¿¡åŒæ–¹ä¸€è‡´çš„å¯¹ç§°å¯†é’¥ Keyã€‚


ä½†æ˜¯ 1-RTT ECDHE ç®—æ³•å®¹æ˜“è¢«ä¸­é—´äººæ”»å‡»ï¼Œä¸­é—´äººå¯ä»¥æˆªè·åŒæ–¹çš„å…¬é’¥è¿è¡Œ ECDH_Generate_key ç”Ÿæˆè‡ªå·±çš„å…¬ç§é’¥å¯¹ï¼Œç„¶åå°†å…¬é’¥å‘é€ç»™æŸä¸€æ–¹ã€‚


> å¦‚ä½•è§£å†³ä¸­é—´äººæ”»å‡»ï¼Ÿ


ä¸­é—´äººæ”»å‡»äº§ç”Ÿçš„æœ¬è´¨åŸå› æ˜¯æ²¡æœ‰ç»è¿‡ç«¯ç‚¹è®¤è¯ï¼Œéœ€è¦â€å¸¦è®¤è¯çš„å¯†é’¥åå•†â€œã€‚


> æ•°æ®è®¤è¯çš„æ–¹å¼ï¼Ÿ

æ•°æ®è®¤è¯æœ‰å¯¹ç§°ä¸éå¯¹ç§°ä¸¤ç§æ–¹å¼ï¼š

- 1ï¼‰ã€åŸºäº MACï¼ˆMessage Authentication Codeï¼Œæ¶ˆæ¯è®¤è¯ç ï¼‰çš„å¯¹ç§°è®¤è¯
- 2ï¼‰ã€åŸºäºç­¾åç®—æ³•çš„éå¯¹ç§°è®¤è¯ã€‚


ECDH è®¤è¯å¯†é’¥åå•†å°±æ˜¯ ECDH å¯†é’¥åå•† + æ•°å­—ç­¾åç®—æ³• ECDSAã€‚

åŒæ–¹å¯†é’¥åå•†ä¼šå¯¹è‡ªèº«å‘å‡ºçš„å…¬é’¥ä½¿ç”¨ç­¾åç®—æ³•ï¼Œç”±äºç­¾åç®—æ³•ä¸­çš„å…¬é’¥ ECDSA_verify_key æ˜¯å…¬å¼€çš„ï¼Œä¸­é—´äººæ²¡æœ‰åŠæ³•é˜»æ­¢åˆ«äººè·å–å…¬é’¥ã€‚

è€Œ mmtls ä»…å¯¹ Server åšè®¤è¯ï¼Œå› ä¸ºé€šä¿¡ä¸€æ–¹ç­¾åå…¶åå•†æ•°æ®å°±ä¸ä¼šè¢«ä¸­é—´äººæ”»å‡»ã€‚

åœ¨ TLS ä¸­ï¼Œæä¾›äº†å¯é€‰çš„åŒæ–¹ç›¸äº’è®¤è¯çš„èƒ½åŠ›ï¼š

- Client é€šè¿‡é€‰æ‹© CipherSuite æ˜¯ä»€ä¹ˆç±»å‹æ¥å†³å®šæ˜¯å¦è¦å¯¹ Server è¿›è¡Œè®¤è¯ã€‚
- Server é€šè¿‡æ˜¯å¦å‘é€ CertificateRequest æ¡æ‰‹æ¶ˆæ¯æ¥å†³å®šæ˜¯å¦è¦å¯¹ Client è¿›è¡Œè®¤è¯ã€‚


**1-RTT PSK å¯†é’¥åå•†åŸç†**

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc5d11dde4ff?w=1350&h=632&f=png&s=224751)


åœ¨ä¹‹å‰çš„ ECDH æ¡æ‰‹ä¸‹ï¼ŒServer ä¼šä¸‹å‘åŠ å¯†çš„ PSK{key, ticket{key}}ï¼Œå…¶ä¸­ï¼š

- keyï¼šç”¨æ¥åšå¯¹ç§°åŠ å¯†å¯†é’¥çš„ key æ˜æ–‡ã€‚
- ticket{key}ï¼šç”¨ server ç§å¯†ä¿å­˜çš„ ticket_key å¯¹ key è¿›è¡ŒåŠ å¯†çš„å¯†æ–‡ ticketã€‚


1ï¼‰ã€é¦–å…ˆï¼ŒClient å°† ticket{key}ã€Client_Random å‘é€ç»™ Serverã€‚

2ï¼‰ã€ç„¶åï¼ŒServer ä½¿ç”¨ ticket_key è§£å¯†å¾—åˆ° keyã€Server_Randomã€Client_Random è®¡ç®— MAC æ¥è®¤è¯ã€‚

3ï¼‰ã€æœ€åï¼ŒServer å°† Server_Randomã€MAC å‘é€ç»™ Clientï¼ŒClient åŒ Server ä½¿ç”¨ ticket_key è§£å¯†å¾—åˆ° keyã€Server_Randomã€Client_Random å»è®¡ç®— MAC æ¥éªŒè¯æ˜¯å¦ä¸æ”¶åˆ°çš„ MAC åŒ¹é…ã€‚


**0-RTT ECDH å¯†é’¥åå•†åŸç†**

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc621d0a35e9?w=1342&h=560&f=png&s=212862)


è¦æƒ³å®ç° 0-RTT å¯†é’¥åå•†ï¼Œå°±å¿…é¡»åœ¨åå•†ä¸€å¼€å§‹å°±å°†ä¸šåŠ¡æ•°æ®å®‰å…¨åœ°ä¼ é€’åˆ°å¯¹ç«¯ã€‚

é¢„å…ˆç”Ÿæˆä¸€å¯¹å…¬ç§é’¥ï¼ˆstatic_svr_pub_key, static_svr_pri_key)ï¼Œå¹¶å°†å…¬é’¥é¢„ç½®åœ¨ Clientï¼Œç§é’¥æŒä¹…ä¿å­˜åœ¨ Serverã€‚

1ï¼‰ã€é¦–å…ˆï¼ŒClient é€šè¿‡ static_svr_pub_key ä¸ cli_pri_key ç”Ÿæˆä¸€ä¸ªå¯¹ç§°å¯†é’¥SSï¼ˆStatic Secretï¼‰ï¼Œç”¨ SS è¡ç”Ÿçš„å¯†é’¥å¯¹ä¸šåŠ¡æ•°æ®åŠ å¯†ã€‚

2ï¼‰ã€ç„¶åï¼ŒClient 
cli_pub_keyã€Client_Randomã€SS åŠ å¯†çš„ AppData å‘é€ç»™ Serverï¼ŒSever é€šè¿‡ cli_pub_key å’Œ static_svr_pri_key ç®—å‡º SSï¼Œè§£å¯†ä¸šåŠ¡æ•°æ®åŒ…ã€‚


**1-RTT PSK å¯†é’¥åå•†åŸç†**

åœ¨è¿›è¡Œ 1-RTT PSK æ¡æ‰‹ä¹‹å‰ï¼ŒClient å·²ç»æœ‰ä¸€ä¸ªå¯¹ç§°åŠ å¯†å¯†é’¥ key äº†ï¼Œç›´æ¥ä½¿ç”¨æ­¤ key ä¸ ticket{key} ä¸€èµ·ä¼ é€’ç»™ Server å³å¯ã€‚


> TLS 1.3 ä¸ºä»€ä¹ˆè¦åºŸé™¤ RSAï¼Ÿ

- 1ï¼‰ã€2015å¹´å‘ç°äº† FREAK æ”»å‡»ï¼Œå‡ºç°äº† RSA æ¼æ´ã€‚
- 2ï¼‰ã€ä¸€æ—¦ç§é’¥æ³„éœ²ï¼Œä¸­é—´äººå°±å¯ä»¥é€šè¿‡ç§é’¥è®¡ç®—å‡ºä¹‹å‰æ‰€æœ‰æŠ¥æ–‡çš„å¯†é’¥ï¼Œç ´è§£ä¹‹å‰æ‰€æœ‰çš„å¯†æ–‡ã€‚


å› æ­¤ TLS 1.3 å¼•å…¥äº† PFSï¼ˆperfect forward secrecyï¼Œå‰å‘å®‰å…¨æ€§ï¼‰ï¼Œå³å®Œå…¨å‘å‰ä¿å¯†ï¼Œä¸€ä¸ªå¯†é’¥è¢«ç ´è§£ï¼Œå¹¶ä¸ä¼šå½±å“å…¶å®ƒå¯†é’¥çš„å®‰å…¨æ€§ã€‚

ä¾‹å¦‚ 0-RTT ECDH å¯†é’¥åå•†åŠ å¯†ä¾èµ–äº†é™æ€ static_svr_pri_keyï¼Œä¸ç¬¦åˆ PFSï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ 0-RTT ECDH-ECDHE å¯†é’¥åå•†ï¼Œå³è¿›è¡Œ 0-RTT ECDH åå•†çš„è¿‡ç¨‹ä¸­ä¹Ÿè¿›è¡Œ ECDHE åå•†ã€‚0-RTT PSK å¯†é’¥åå•†çš„é™æ€ ticket_key åŒç†ä¹Ÿå¯ä»¥åŠ å…¥ ECDHE åå•†ã€‚


> verify_key å¦‚ä½•ä¸‹å‘ç»™å®¢æˆ·ç«¯ï¼Ÿ

ä¸ºé¿å…è¯ä¹¦é“¾éªŒè¯å¸¦æ¥çš„æ—¶é—´æ¶ˆè€—åŠä¼ è¾“å¸¦æ¥çš„å¸¦å®½æ¶ˆè€—ï¼Œç›´æ¥å°† verify_Key å†…ç½®å®¢æˆ·ç«¯å³å¯ã€‚


> å¦‚ä½•é¿å…ç­¾åå¯†é’¥ sign_key æ³„éœ²å¸¦æ¥çš„å½±å“ï¼Ÿ

å› ä¸º mmtls å†…ç½®äº† verify_key åœ¨å®¢æˆ·ç«¯ï¼Œå¿…è¦æ—¶åŠæ—¶é€šè¿‡å¼ºåˆ¶å‡çº§å®¢æˆ·ç«¯çš„æ–¹å¼æ¥æ’¤é”€å…¬é’¥å¹¶æ›´æ–°ã€‚


> ä¸ºä»€ä¹ˆè¦åœ¨ä¸Šè¿°å¯†é’¥åå•†è¿‡ç¨‹ä¸­éƒ½è¦å¼•å…¥ client_randomã€server_randomã€svr_pub_key ä¸€èµ·åšç­¾åï¼Ÿ

å› ä¸º svr_pri_Key å¯èƒ½ä¼šæ³„éœ²ï¼Œæ‰€æœ‰å•ç‹¬ä½¿ç”¨ svr_pub_key æ—¶ä¼šæœ‰éšæ‚£ï¼Œå› ä¸ºéœ€è¦å¼•å…¥ client_randomã€server_random æ¥ä¿è¯å¾—åˆ°çš„ç­¾åå€¼å”¯ä¸€å¯¹åº”ä¸€æ¬¡æ¡æ‰‹ã€‚


##### Record åè®®

**1ã€è®¤è¯åŠ å¯†**

- 1ï¼‰ã€ä½¿ç”¨å¯¹ç§°å¯†é’¥è¿›è¡Œå®‰å…¨é€šä¿¡ã€‚
- 2ï¼‰ã€åŠ å¯† + æ¶ˆæ¯è®¤è¯ç ï¼šEncrypt-then-MAC
- 3ï¼‰ã€TLS 1.3 åªä½¿ç”¨ AEADï¼ˆAuthenticated-Encryption With Addtional dataï¼‰ç±»ç®—æ³•ï¼šEncrypt ä¸ MAC éƒ½é›†æˆåœ¨ä¸€ä¸ªç®—æ³•å†…éƒ¨ï¼Œè®©æœ‰ç»éªŒçš„å¯†ç ä¸“å®¶åœ¨ç®—æ³•å†…éƒ¨è§£å†³å®‰å…¨é—®é¢˜ã€‚
- 4ï¼‰ã€mmtls ä½¿ç”¨ AES-GCM è¿™ç§ AEAD ç±»ç®—æ³•ã€‚


**2ã€å¯†é’¥æ‰©å±•**

åŒæ–¹ä½¿ç”¨ç›¸åŒçš„å¯¹ç§°å¯†é’¥è¿›è¡ŒåŠ å¯†é€šä¿¡å®¹æ˜“è¢«æŸäº›å¯¹ç§°å¯†é’¥ç®—æ³•ç ´è§£ï¼Œå› æ­¤ï¼Œéœ€è¦å¯¹åŸå§‹å¯¹ç§°å¯†é’¥åšæ‰©å±•å˜æ¢å¾—åˆ°ç›¸åº”çš„å¯¹ç§°åŠ å¯†å‚æ•°ã€‚

å¯†é’¥å˜é•¿éœ€è¦ä½¿ç”¨å¯†é’¥å»¶æ—¶å‡½æ•°ï¼ˆKDFï¼ŒKey Derivation Functionï¼‰ï¼Œè€Œ TLS 1.3 ä¸ mmtls éƒ½ä½¿ç”¨äº† HKDF åšå¯†é’¥æ‰©å±•ã€‚

**3ã€é˜²é‡æ”¾**

ä¸ºè§£å†³é˜²é‡æ”¾ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºè¿æ¥ä¸Šçš„æ¯ä¸€ä¸ªä¸šåŠ¡åŒ…éƒ½æ·»åŠ ä¸€ä¸ªé€’å¢çš„åºåˆ—å·ï¼Œåªè¦ Server æ£€æŸ¥åˆ°æ–°æ”¶åˆ°çš„æ•°æ®åŒ…çš„åºåˆ—å·å°äºç­‰äºä¹‹å‰æ”¶åˆ°çš„æ•°æ®åŒ…çš„åºåˆ—å·ï¼Œå°±åˆ¤æ–­ä¸ºé‡æ”¾åŒ…ï¼Œmmtls å°†åºåˆ—å·ä½œä¸ºæ„é€  AES-GCM ç®—å‚æ•° nonce çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ ·å°±ä¸éœ€è¦å¯¹åºåˆ—å·å•ç‹¬è®¤è¯ã€‚

åœ¨ 0-RTT æ¡æ‰‹ä¸‹ï¼Œç¬¬ä¸€ä¸ªä¸šåŠ¡æ•°æ®åŒ…å’Œæ¡æ‰‹æ•°æ®åŒ…æ— æ³•ä½¿ç”¨ä¸Šè¿°æ–¹æ¡ˆï¼Œæ­¤æ—¶éœ€è¦å®¢æˆ·ç«¯åœ¨ä¸šåŠ¡æ¡†æ¶å±‚å»åè°ƒæ”¯æŒé˜²é‡æ”¾ã€‚

##### å°ç»“

mmtls çš„ **å·¥ä½œè¿‡ç¨‹** å¦‚ä¸‹æ‰€ç¤ºï¼š

- 1ï¼‰ã€ä½¿ç”¨ ECDH åšå¯†é’¥åå•†ã€‚
- 2ï¼‰ã€ä½¿ç”¨ ECDSA è¿›è¡Œç­¾åè®¤è¯ã€‚
- 3ï¼‰ã€ä½¿ç”¨ AES-GCM å¯¹ç§°åŠ å¯†ç®—æ³•å¯¹ä¸šåŠ¡æ•°æ®è¿›è¡ŒåŠ å¯†ã€‚
- 4ï¼‰ã€ä½¿ç”¨ HKDF è¿›è¡Œå¯†é’¥æ‰©å±•ã€‚
- 5ï¼‰ã€ä½¿ç”¨çš„æ‘˜è¦ç®—æ³•ä¸º SHA256ã€‚


å…¶ä¼˜åŠ¿å…·æœ‰å¦‚ä¸‹4ç‚¹ï¼š

- 1ï¼‰ã€è½»é‡çº§ï¼šå»é™¤å®¢æˆ·ç«¯è®¤è¯ï¼Œå†…ç½®ç­¾åå…¬é’¥ï¼Œå‡å°‘éªŒè¯æ—¶ç½‘ç»œäº¤æ¢æ¬¡æ•°ã€‚
- 2ï¼‰ã€å®‰å…¨æ€§ï¼šTLS 1.3 æ¨èå®‰å…¨æ€§æœ€é«˜çš„åŸºç¡€å¯†ç ç»„ä»¶ï¼Œ0-RTT é˜²é‡æ”¾ç”±æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯æ¡†æ¶å±‚ååŒå¤„ç†ã€‚
- 3ï¼‰ã€é«˜æ€§èƒ½ï¼šä½¿ç”¨äº† 0-RTT æ¡æ‰‹ï¼Œä¼˜åŒ–äº† TLS 1.3 ä¸­çš„æ¡æ‰‹æ–¹å¼å’Œå¯†é’¥æ‰©å±•æ–¹å¼ã€‚
- 4ï¼‰ã€é«˜å¯ç”¨ï¼šæœåŠ¡å™¨æ·»åŠ äº†è¿‡è½½ä¿æŠ¤ï¼Œç¡®ä¿å…¶èƒ½åœ¨å®¹ç¾æ¨¡å¼ä¸‹æä¾›å®‰å…¨çº§åˆ«ç¨ä½çš„æœ‰æŸæœåŠ¡ã€‚


#### 3ï¼‰ã€å¤ç”¨ Session Ticket ä¼šè¯ï¼ŒèŠ‚çœä¸€ä¸ª RTT è€—æ—¶ã€‚


æœ€åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç»Ÿä¸€æ¥å…¥å±‚å¯¹ä¼ è¾“æ•°æ®äºŒæ¬¡åŠ å¯†ï¼Œéœ€è¦æ³¨æ„äºŒæ¬¡åŠ å¯†ä¼šå¢åŠ å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„å¤„ç†è€—æ—¶ã€‚


> å¦‚æœæ‰‹æœºè®¾ç½®äº†ä»£ç†ï¼ŒTLS åŠ å¯†çš„æ•°æ®å¯ä»¥è¢«è§£å¼€å¹¶è¢«åˆ©ç”¨ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ

å¯ä»¥åœ¨ [å®¢æˆ·ç«¯é”å®šæ ¹è¯ä¹¦](https://github.com/WooyunDota/DroidDrops/blob/master/2018/SSL.Pinning.Practice.md#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%B3%BB%E7%BB%9F%E8%AF%81%E4%B9%A6%E9%94%81%E5%AE%9A-system-ca-pinning)ï¼Œå¯ä»¥åŒæ—¶å…¼å®¹è€ç‰ˆæœ¬ä¸ä¿è¯è¯ä¹¦æ›¿æ¢çš„çµæ´»æ€§ã€‚


## 8ã€ç½‘ç»œå®¹ç¾æœºåˆ¶

- 1ï¼‰ã€å¤‡ç”¨æœåŠ¡å™¨åˆ†æµã€‚
- 2ï¼‰ã€å¤šæ¬¡å¤±è´¥åä¸€å®šæ—¶é—´å†…ä¸è¿›è¡Œè¯·æ±‚ï¼Œé¿å…é›ªå´©æ•ˆåº”ã€‚


## 9ã€èµ„æœ¬æ‰‹æ®µä¼˜åŒ–

- 1ï¼‰ã€CDN åŠ é€Ÿï¼Œæ›´æ–°åéœ€è¦è®°ä½æ¸…ç†ç¼“å­˜
- 2ï¼‰ã€æé«˜å¸¦å®½
- 3ï¼‰ã€åŠ¨é™èµ„æºåˆ†ç¦»
- 4ï¼‰ã€éƒ¨ç½²è·¨å›½çš„ä¸“çº¿ã€åŠ é€Ÿç‚¹
- 5ï¼‰ã€å¤š IDC å°±è¿›æ¥å…¥
- 6ï¼‰ã€P2P æŠ€æœ¯


# å…­ã€ç½‘ç»œåº“è®¾è®¡

## 1ã€ç»Ÿä¸€çš„ç½‘ç»œä¸­å°

åœ¨ä¸€çº¿äº’è”ç½‘å…¬å¸ï¼Œéƒ½ä¼šæœ‰ç»Ÿä¸€çš„ç½‘ç»œä¸­å°ï¼š

- è´Ÿè´£æä¾›å‰åå°ä¸€æ•´å¥—çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆã€‚
- ç½‘å…³ç”¨äºè§£å†³ä¸­é—´ç½‘ç»œçš„é€šè®¯ï¼Œä¸ºä¸Šå±‚æœåŠ¡æä¾›é«˜è´¨é‡çš„åŒå‘é€šè®¯èƒ½åŠ›ã€‚


## 2ã€å¦‚ä½•è®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„ç»Ÿä¸€ç½‘ç»œåº“ï¼Ÿ

- 1ï¼‰ã€ç»Ÿä¸€ APIï¼šç»Ÿä¸€çš„ç­–ç•¥ç®¡ç†ã€æµè§£æï¼ˆå…¼å®¹JSONã€XMLã€Protocol Buffersï¼‰ç­‰
- 2ï¼‰ã€å…¨å±€ç½‘ç»œæ§åˆ¶ï¼šç»Ÿä¸€çš„ç½‘ç»œè°ƒåº¦ã€æµé‡ç›‘æ§ã€å®¹ç¾ç®¡ç†ç­‰
- 3ï¼‰ã€é«˜æ€§èƒ½ï¼šé€Ÿåº¦ã€CPUã€å†…å­˜ã€I/Oã€å¤±è´¥ç‡ã€å´©æºƒç‡ã€åè®®å…¼å®¹æ€§ç­‰


## 3ã€ç»Ÿä¸€ç½‘ç»œåº“çš„æ ¸å¿ƒæ¨¡å—æœ‰å“ªäº›ï¼Ÿ

- 1ï¼‰ã€DNS ç®¡ç†
- 2ï¼‰ã€è¿æ¥ç®¡ç†
- 3ï¼‰ã€åè®®å¤„ç†
- 4ï¼‰ã€å¹¶å‘æ¨¡å‹
- 5ï¼‰ã€IO æ¨¡å‹
- 6ï¼‰ã€é¢„è¿æ¥
- 7ï¼‰ã€é”™è¯¯å…¼å®¹å¤„ç†
- 8ï¼‰ã€æ•°æ®è§£æ
- 9ï¼‰ã€ç½‘ç»œè´¨é‡ç›‘æ§
- 10ï¼‰æµé‡ç›‘æ§
- 11ï¼‰ã€ä»£ç† WebView ç½‘ç»œè¯·æ±‚

## 4ã€é«˜è´¨é‡ç½‘ç»œåº“

### 1ï¼‰ã€Chromium ç½‘ç»œåº“

- Google å‡ºå“ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäº Chromium ç½‘ç»œåº“äºŒæ¬¡å¼€å‘è‡ªå·±çš„ç½‘ç»œåº“ï¼Œ ä»¥ä¾¿äº«å— Google åç»­ç½‘ç»œä¼˜åŒ–çš„æˆæœï¼Œä¾‹å¦‚ TLS 1.3ã€QUIC æ”¯æŒç­‰ç­‰ã€‚
- è·¨å¹³å°ã€‚
- éœ€è¦è¡¥è¶³ Mars çš„ å¼±ç½‘/è¿æ¥ä¼˜åŒ– åŠŸèƒ½ã€‚
- è‡ªå®šä¹‰åè®®ï¼šæ”¹é€  TLSï¼Œå°† RSA æ›´æ¢ä¸º ECDHEï¼Œä»¥æå‡åŠ è§£å¯†é€Ÿåº¦ã€‚


### 2ï¼‰ã€å¾®ä¿¡ Mars

ä¸€ä¸ªè·¨å¹³å°çš„ Socket å±‚è§£å†³æ–¹æ¡ˆï¼Œä¸æ”¯æŒå®Œæ•´çš„ HTTP åè®®ã€‚

Mars çš„ä¸¤ä¸ªæ ¸å¿ƒæ¨¡å—å¦‚ä¸‹ï¼š

- SDTï¼šç½‘ç»œè¯Šæ–­æ¨¡å—
- STNï¼šä¿¡ä»¤ä¼ è¾“æ¨¡å—ï¼Œé€‚åˆå°æ•°æ®ä¼ è¾“ã€‚


å…¶ä¸­ STN æ¨¡å—çš„ç»„æˆå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc65caf1f970?w=2262&h=832&f=png&s=525700)


#### åŒ…åŒ…è¶…æ—¶

- æ¯æ¬¡è¯»å–æˆ–å‘é€çš„é—´éš”ã€‚
- è·å– sock snd buf å†…æœªå‘é€çš„æ•°æ®ã€‚
- Androidï¼šioctl è¯»å– SIOCOUTQã€‚
- iOSï¼šgetsockopt è¯»å– SO_NWRITEã€‚


#### åŠ¨æ€è¶…æ—¶

æ ¹æ®ç½‘ç»œæƒ…å†µï¼Œè°ƒæ•´å…¶å®ƒè¶…æ—¶çš„ç³»æ•°æˆ–ç»å¯¹å€¼ã€‚


> Mars æ˜¯å¦‚ä½•è¿›è¡Œ è¿æ¥ä¼˜åŒ– çš„ï¼Ÿ

#### å¤åˆè¿æ¥

æ¯é—´éš”å‡ ç§’å¯åŠ¨ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œåªè¦æœ‰è¿æ¥å»ºç«‹æˆåŠŸï¼Œåˆ™å…³é—­å…¶å®ƒè¿æ¥ã€‚=> æœ‰æ•ˆæå‡è¿æ¥æˆåŠŸç‡ã€‚

#### è‡ªåŠ¨é‡è¿ä¼˜åŒ–

- 1ï¼‰ã€å‡å°‘æ— æ•ˆç­‰å¾…æ—¶é—´ï¼Œå¢åŠ é‡è¯•æ¬¡æ•°ã€‚
- 2ï¼‰ã€ä½† TCP å±‚çš„é‡ä¼ é—´éš”è¿‡å¤§æ—¶ï¼Œæ­¤æ—¶æ–­è¿é‡è¿ï¼Œèƒ½å¤Ÿè®© TCP å±‚ä¿æŒç§¯æçš„é‡è¿é—´éš”ï¼Œä»¥æé«˜æˆåŠŸç‡ã€‚
- 3ï¼‰ã€å½“é“¾è·¯å­˜åœ¨è¾ƒå¤§æ³¢åŠ¨æˆ–ä¸¥é‡æ‹¥å¡æ—¶ï¼Œé€šè¿‡æ›´æ¢è¿æ¥ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚


#### ç½‘ç»œåˆ‡æ¢

é€šè¿‡æ„ŸçŸ¥ç½‘ç»œçš„çŠ¶æ€åˆ‡æ¢åˆ°æ›´å¥½çš„ç½‘ç»œç¯å¢ƒä¸‹ã€‚


> Mars æ˜¯å¦‚ä½•è¿›è¡Œ å¼±ç½‘ä¼˜åŒ– çš„ï¼Ÿ

#### å¸¸è§„æ–¹æ¡ˆ

##### 1ï¼‰ã€å¿«é€Ÿé‡ä¼ 

- å‡å°é‡ä¼ æˆæœ¬ï¼ˆSACKã€FECï¼‰
- å°½æ—©å‘ç°é‡ä¼ ï¼ˆDUP ACKã€FACKã€RTOã€NACKï¼‰


##### 2ï¼‰ã€HARQï¼ˆHybrid Automatic Repeat reQuestï¼‰

- 3 GPP æ ‡å‡†æ–¹æ¡ˆã€‚
- å¢åŠ å¹¶å‘åº¦ã€‚
- å°½é‡å‡†ç¡®é¿å…æ‹¥å µï¼ˆä¸¢åŒ…å’Œæ‹¥å µçš„åŒºåˆ«ï¼‰ã€‚


#### è¿›é˜¶æ–¹æ¡ˆ

##### TCP ä¸¢åŒ…çš„æ¢å¤æ–¹å¼ TLP

- 1ã€PTO è§¦å‘å°¾åŒ…é‡ä¼ ã€‚
- 2ã€å°¾åŒ…çš„ ACK å¸¦ä¸Š SACK ä¿¡æ¯ã€‚
- 3ã€SACK è§¦å‘ FACK å¿«é€Ÿé‡ä¼ å’Œæ¢å¤ã€‚
- 4ã€é¿å…äº† RTO å¯¼è‡´çš„æ…¢å¯åŠ¨å’Œå»¶è¿Ÿã€‚


##### å‘å›¾-æœ‰æŸä¸‹è½½

åœ¨å¼±ç½‘ä¸‹å°½é‡ä¿è¯ä¸‹è½½å®Œæ•´çš„å›¾ç‰‡è½®å»“æ˜¾ç¤ºï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚


![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc6873a56c11?w=1694&h=752&f=png&s=1333848)


#### å‘å›¾-æœ‰æŸä¸Šä¼ æ•°æ®

- åœ¨å¼±ç½‘ä¸‹å°½é‡ä¿è¯ä¸Šä¼ å®Œæ•´çš„å›¾ç‰‡è½®å»“æ˜¾ç¤ºï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚
- èƒ½å¤Ÿé™ä½å®¢æˆ·ç«¯ä¸Šä¼ å¤±è´¥ç‡ 10% ä»¥ä¸Šã€‚


#### æœ‰æŸä¸Šä¼ æ•°æ®çš„æµç¨‹ï¼Œæœ‰æŸä¸‹è½½æµç¨‹åŒç†

- 1ï¼‰ã€å‘é€æ¸è¿›å¼å›¾ç‰‡ï¼ˆä¾‹å¦‚ JPG ç­‰ï¼‰ã€‚
- 2ï¼‰ã€æœåŠ¡å™¨æ¥æ”¶æ•°æ®ä¸”å›å¤æ•°æ®ç¡®è®¤åŒ…ã€‚
- 3ï¼‰ã€å½“æ•°æ®è¶³å¤Ÿæ—¶ï¼ˆ50%ï¼‰ï¼Œå›å¤å‘é€æˆåŠŸç¡®è®¤åŒ…ã€‚
- 4ï¼‰ã€å‘é€æ–¹ç»§ç»­è¡¥å……æ•°æ®
    - ç½‘ç»œæ­£å¸¸ï¼Œæ•°æ®å®Œæ•´ã€‚
    - ç½‘ç»œå¼‚å¸¸ï¼Œè®¤ä¸ºå·²å‘é€æˆåŠŸã€‚
- 5ï¼‰ã€æœåŠ¡å™¨é€šçŸ¥å‘é€è€…ã€‚


#### å‘å›¾-ä½æˆæœ¬é‡ä¼ 

å°†åˆ†åŒ…è½¬æˆæµå¼ä¼ è¾“ã€‚

- 1ï¼‰ã€åˆ†åŒ…
    - é™ä½åŒ…å¤§å°
    - å¢åŠ å¹¶å‘
    - åŒ…å¤´æŸè€—
- 2ï¼‰ã€æµå¼
    ç¡®è®¤ç²’åº¦ç­–ç•¥çµæ´»
    å•çº¿ç¨‹


# ä¸ƒã€å…¶å®ƒä¼˜åŒ–æ–¹æ¡ˆ

## 1ã€å¼‚åœ°å¤šæ´»

ä¸€ä¸ªå¤šæœºæˆ¿çš„æ•´ä½“æ–¹æ¡ˆï¼Œåœ¨å¤šä¸ªåœ°åŒºåŒæ—¶å­˜åœ¨å¯¹ç­‰çš„å¤šä¸ªæœºæˆ¿ï¼Œä»¥ç”¨æˆ·ç»´åº¦åˆ’åˆ†ï¼Œå¤šæœºæˆ¿å…±åŒæ‰¿æ‹…å…¨é‡ç”¨æˆ·çš„æµé‡ã€‚

åœ¨å•ä¸ªæœºæˆ¿å‘é€æ•…éšœæ—¶ï¼Œæ•…éšœæœºæˆ¿çš„æµé‡å¯ä»¥å¿«é€Ÿåœ°è¢«è¿å¼•åˆ°å¯ç”¨æœºæˆ¿ï¼Œå‡å°‘æ•…éšœçš„æ¢å¤æ—¶é—´ã€‚


## 2ã€æŠ—æŠ–åŠ¨ä¼˜åŒ–

åº”ç”¨ä¸€ç§æœ‰ç­–ç•¥çš„é‡è¯•æœºåˆ¶ï¼Œå°†ç½‘ç»œè¯·æ±‚ä»¥æ˜¯å¦å‘é€åˆ° socket ç¼“å†²åŒºä½œä¸ºåˆ†å‰²ï¼Œå°†ç½‘ç»œè¯·æ±‚ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ä¸ºâ€è¯·æ±‚å¼€å§‹åˆ°å‘é€åˆ° socket ç¼“å†²åŒºâ€œå’Œâ€å·²ç»å‘é€åˆ° socket ç¼“å†²åŒºåˆ°è¯·æ±‚ç»“æŸâ€œä¸¤ä¸ªé˜¶æ®µã€‚

è¿™æ ·å½“ç”¨æˆ·è¿›ç”µæ¢¯å› ä¸ºç½‘ç»œæŠ–åŠ¨çš„åŸå› ç½‘ç»œé“¾æ¥æ–­äº†ï¼Œä½†æ˜¯æ•°æ®å…¶å®å·²ç»è¯·æ±‚åˆ°äº† socket ç¼“å†²åŒºï¼Œä½¿ç”¨è¿™ç§æœ‰ç­–ç•¥çš„é‡è¯•æœºåˆ¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥æå‡å®¢æˆ·ç«¯çš„ç½‘ç»œæŠ—æŠ–åŠ¨èƒ½åŠ›ã€‚


## 3ã€SYNC æœºåˆ¶

åŒæ­¥å·®é‡æ•°æ®ï¼Œè¾¾åˆ°èŠ‚çœæµé‡ï¼Œæé«˜é€šä¿¡æ•ˆç‡ä¸è¯·æ±‚æˆåŠŸç‡ã€‚

å®¢æˆ·ç«¯ç”¨æˆ·ä¸åœ¨çº¿æ—¶ï¼ŒSYNC æœåŠ¡ç«¯å°†å·®é‡æ•°æ®ä¿æŒåœ¨æ•°æ®åº“ä¸­ã€‚å½“å®¢æˆ·ç«¯ä¸‹æ¬¡è¿æ¥åˆ°æœåŠ¡å™¨æ—¶ï¼Œå†åŒæ­¥å·®é‡æ•°æ®ç»™ç”¨æˆ·ã€‚


## 4ã€é«˜å¹¶å‘æµé‡å¤„ç†ï¼šæœåŠ¡ç«¯æ¥å…¥å±‚å¤šçº§é™æµ

æ ¸å¿ƒæ€æƒ³æ˜¯ä¿éšœæ ¸å¿ƒä¸šåŠ¡åœ¨ä½“éªŒå¯æ¥å—èŒƒå›´å†…åšé™çº§éæ ¸å¿ƒåŠŸèƒ½å’Œä¸šåŠ¡ã€‚ä»å…¥å£åˆ°ä¸šåŠ¡æ¥å£æ€»å…±åˆ†ä¸ºå››ä¸ªå±‚çº§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

- 1ï¼‰ã€LVSï¼ˆå‡ åäº¿çº§ï¼‰ï¼šå¤š VIP å¤šé›†ç¾¤ã€‚
- 2ï¼‰ã€æ¥å…¥ç½‘å…³ï¼ˆäº¿çº§ï¼‰ï¼šTCP é™æµã€æ ¸å¿ƒ RPC é™æµã€‚
- 3ï¼‰ã€API ç½‘å…³ï¼ˆåƒä¸‡çº§ï¼‰ï¼šåˆ†çº§é™æµç®—æ³•ï¼ˆå¯¹ä¸åŒè¯·æ±‚é‡çš„æ¥å£ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ï¼‰
    - é«˜ QPS é™æµï¼šç®€å•åŸºæ•°ç®—æ³•ï¼Œè¶…è¿‡è¿™ä¸ªå€¼ç›´æ¥æ‹’ç»ã€‚
    - ä¸­ QPS é™æµï¼šä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ¥å—ä¸€å®šçš„æµé‡å¹¶å‘ã€‚
    - ä½ QPS é™æµï¼šåˆ†å¸ƒå¼é™æµï¼Œä¿éšœé™æµçš„å‡†ç¡®ã€‚
- 4ï¼‰ã€ä¸šåŠ¡æ¥å£ï¼ˆç™¾ä¸‡çº§ï¼‰
    - è¿”å›å®šåˆ¶å“åº”ã€è‡ªå®šä¹‰è„šæœ¬ã€‚
    - å®¢æˆ·ç«¯é™é»˜ã€Alertã€Toastã€‚


## 5ã€JobScheduler

ç»“åˆ JobScheduler æ¥æ ¹æ®å®é™…æƒ…å†µåšç½‘ç»œè¯·æ±‚. æ¯”æ–¹è¯´ Splash é—ªå±å¹¿å‘Šå›¾ç‰‡, æˆ‘ä»¬å¯ä»¥åœ¨è¿æ¥åˆ° Wifi æ—¶ä¸‹è½½ç¼“å­˜åˆ°æœ¬åœ°; æ–°é—»ç±»çš„ App å¯ä»¥åœ¨å……ç”µ, Wifi çŠ¶æ€ä¸‹åšç¦»çº¿ç¼“å­˜ã€‚


## 6ã€ç½‘ç»œè¯·æ±‚ä¼˜å…ˆçº§æ’åº

appåº”è¯¥å¯¹ç½‘ç»œè¯·æ±‚åˆ’åˆ†ä¼˜å…ˆçº§å°½å¯èƒ½å¿«åœ°å±•ç¤ºæœ€æœ‰ç”¨çš„ä¿¡æ¯ç»™ç”¨æˆ·ã€‚ï¼ˆé«˜ä¼˜å…ˆçº§çš„æœåŠ¡ä¼˜å…ˆä½¿ç”¨é•¿è¿æ¥ï¼‰

ç«‹åˆ»å‘ˆç°ç»™ç”¨æˆ·ä¸€äº›å®è´¨çš„ä¿¡æ¯æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ç”¨æˆ·ä½“éªŒï¼Œç›¸å¯¹äºè®©ç”¨æˆ·ç­‰å¾…é‚£äº›ä¸é‚£ä¹ˆå¿…è¦çš„ä¿¡æ¯æ¥è¯´ã€‚è¿™å¯ä»¥å‡å°‘ç”¨æˆ·ä¸å¾—ä¸ç­‰å¾…çš„æ—¶é—´ï¼Œå¢åŠ APPåœ¨æ…¢é€Ÿç½‘ç»œæ—¶çš„å®ç”¨æ€§ã€‚ï¼ˆä½ä¼˜å…ˆçº§ä½¿ç”¨çŸ­è¿æ¥ï¼‰


## 7ã€å»ºç«‹é•¿è¿é€šé“

### å®ç°åŸç†

å°†ä¼—å¤šè¯·æ±‚æ”¾å…¥ç­‰å¾…å‘é€é˜Ÿåˆ—ä¸­ï¼Œå¾…é•¿è¿é€šé“å»ºç«‹å®Œæ¯•åå†å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¯·æ±‚æ”¾åœ¨é•¿è¿é€šé“ä¸Šä¾æ¬¡é€å‡ºã€‚

### å…³é”®ç»†èŠ‚

HTTP çš„è¯·æ±‚å¤´é”®å€¼å¯¹ä¸­çš„çš„é”®æ˜¯å…è®¸ç›¸åŒå’Œé‡å¤çš„ã€‚ä¾‹å¦‚ Set-Cookie/Cookie å­—æ®µå¯ä»¥åŒ…å«å¤šç»„ç›¸åŒçš„é”®åç§°æ•°æ®ã€‚åœ¨é•¿è¿é€šä¿¡ä¸­ï¼Œå¦‚æœå¯¹ header ä¸­çš„é”®å€¼å¯¹ç”¨ä¸åŠ å¤„ç†çš„å­—å…¸æ–¹å¼ä¿å­˜å’Œä¼ è¾“ï¼Œå°±ä¼šé€ æˆæ•°æ®çš„ä¸¢å¤±ã€‚


## 8ã€å‡å°‘åŸŸåå’Œé¿å…é‡å®šå‘ã€‚

## 9ã€æ²¡æœ‰è¯·æ±‚çš„è¯·æ±‚ï¼Œæ‰æ˜¯æœ€å¿«çš„è¯·æ±‚ã€‚


# ä¸ƒã€ç½‘ç»œä½“ç³»åŒ–æ–¹æ¡ˆå»ºè®¾

## 1ã€çº¿ä¸‹æµ‹è¯•

### 1ï¼‰ã€æ­£ç¡®è®¤è¯†

å°½å¯èƒ½å°†é—®é¢˜åœ¨ä¸Šçº¿å‰æš´éœ²å‡ºæ¥ã€‚

### 2ï¼‰ã€ä¾§é‡ç‚¹

- 1ï¼‰ã€è¯·æ±‚æœ‰è¯¯ã€å¤šä½™
- 2ï¼‰ã€ç½‘ç»œåˆ‡æ¢
- 3ï¼‰ã€å¼±ç½‘
- 4ï¼‰ã€æ— ç½‘


## 2ã€çº¿ä¸Šç›‘æ§

### 1ï¼‰ã€æœåŠ¡ç«¯ç›‘æ§

#### å®è§‚ç›‘æ§ç»´åº¦

##### 1ï¼‰ã€è¯·æ±‚è€—æ—¶

åŒºåˆ†åœ°åŸŸã€æ—¶é—´æ®µã€ç‰ˆæœ¬ã€æœºå‹ã€‚

##### 2ï¼‰ã€å¤±è´¥ç‡

ä¸šåŠ¡å¤±è´¥ä¸è¯·æ±‚å¤±è´¥ã€‚

##### 3ï¼‰ã€Top å¤±è´¥æ¥å£ã€å¼‚å¸¸æ¥å£

ä»¥ä¾¿è¿›è¡Œé’ˆå¯¹æ€§åœ°ä¼˜åŒ–ã€‚

#### å¾®è§‚ç›‘æ§ç»´åº¦

##### 1ï¼‰ã€ååé‡ï¼ˆrequests per secondï¼‰

RPS/TPS/QPSï¼Œæ¯ç§’çš„è¯·æ±‚æ¬¡æ•°ï¼ŒæœåŠ¡å™¨æœ€åŸºæœ¬çš„æ€§èƒ½æŒ‡æ ‡ï¼ŒRPS è¶Šé«˜å°±è¯´æ˜æœåŠ¡å™¨çš„æ€§èƒ½è¶Šå¥½ã€‚

##### 2ï¼‰ã€å¹¶å‘æ•°ï¼ˆconcurrencyï¼‰

åæ˜ æœåŠ¡å™¨çš„è´Ÿè½½èƒ½åŠ›ï¼Œå³æœåŠ¡å™¨èƒ½å¤ŸåŒæ—¶æ”¯æŒçš„å®¢æˆ·ç«¯æ•°é‡ï¼Œè¶Šå¤§è¶Šå¥½ã€‚

##### 3ï¼‰ã€å“åº”æ—¶é—´ï¼ˆtime per requestï¼‰

åæ˜ æœåŠ¡å™¨çš„å¤„ç†èƒ½åŠ›ï¼Œå³å¿«æ…¢ç¨‹åº¦ï¼Œå“åº”æ—¶é—´è¶ŠçŸ­è¶Šå¥½ã€‚

##### 4ï¼‰ã€æ“ä½œç³»ç»Ÿèµ„æº

CPUã€å†…å­˜ã€ç¡¬ç›˜å’Œç½‘å¡ç­‰ç³»ç»Ÿèµ„æºã€‚å¯ä»¥åˆ©ç”¨ topã€vmstat ç­‰å·¥å…·æ£€æµ‹ç›¸å…³æ€§èƒ½ã€‚


#### ä¼˜åŒ–æ–¹é’ˆ

- 1ï¼‰ã€åˆç†åˆ©ç”¨ç³»ç»Ÿèµ„æºï¼Œæé«˜æœåŠ¡å™¨çš„ååé‡å’Œå¹¶å‘æ•°ï¼Œé™ä½å“åº”æ—¶é—´ã€‚
- 2ï¼‰ã€é€‰ç”¨é«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨ï¼Œå¼€å¯é•¿è¿æ¥ï¼Œæå‡ TCP çš„ä¼ è¾“æ•ˆç‡ã€‚


### 2ï¼‰ã€å®¢æˆ·ç«¯ç›‘æ§

è¦å®ç°å®¢æˆ·ç«¯ç›‘æ§ï¼Œé¦–å…ˆæˆ‘ä»¬åº”è¯¥è¦ç»Ÿä¸€ç½‘ç»œåº“ï¼Œè€Œå®¢æˆ·ç«¯éœ€è¦ç›‘æ§çš„æŒ‡æ ‡ä¸»è¦æœ‰å¦‚ä¸‹ä¸‰ç±»ï¼š

- 1ï¼‰ã€æ—¶å»¶ï¼šä¸€èˆ¬æˆ‘ä»¬æ¯”è¾ƒå…³å¿ƒæ¯æ¬¡è¯·æ±‚çš„ DNS æ—¶é—´ã€å»ºè¿æ—¶é—´ã€é¦–åŒ…æ—¶é—´ã€æ€»æ—¶é—´ç­‰ï¼Œä¼šæœ‰ç±»ä¼¼ 1 ç§’å¿«å¼€ç‡ã€2 ç§’å¿«å¼€ç‡è¿™äº›æŒ‡æ ‡ã€‚
- 2ï¼‰ã€ç»´åº¦ï¼šç½‘ç»œç±»å‹ã€å›½å®¶ã€çœä»½ã€åŸå¸‚ã€è¿è¥å•†ã€ç³»ç»Ÿã€å®¢æˆ·ç«¯ç‰ˆæœ¬ã€æœºå‹ã€è¯·æ±‚åŸŸåç­‰ï¼Œè¿™äº›ç»´åº¦ä¸»è¦ç”¨äºåˆ†æé—®é¢˜ã€‚
- 3ï¼‰ã€é”™è¯¯ï¼šDNS å¤±è´¥ã€è¿æ¥å¤±è´¥ã€è¶…æ—¶ã€è¿”å›é”™è¯¯ç ç­‰ï¼Œä¼šæœ‰ DNS å¤±è´¥ç‡ã€è¿æ¥å¤±è´¥ç‡ã€ç½‘ç»œè®¿é—®çš„å¤±è´¥ç‡è¿™äº›æŒ‡æ ‡ã€‚

ä¸ºäº†è¿ç®—ç®€å•æˆ‘ä»¬å¯ä»¥æŠ›å¼ƒ UVï¼Œåªè®¡ç®—æ¯ä¸€åˆ†é’Ÿéƒ¨åˆ†ç»´åº¦çš„ PVã€‚


#### 1ã€Aspect æ’æ¡© â€” ArgusAPM

å…³äº ArgusAPM çš„ç½‘ç»œç›‘æ§åˆ‡é¢æºç åˆ†æå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„ [æ·±å…¥æ¢ç´¢ç¼–è¯‘æ’æ¡©æŠ€æœ¯ï¼ˆäºŒã€AspectJï¼‰ - ä½¿ç”¨ AspectJ æ‰“é€ è‡ªå·±çš„æ€§èƒ½ç›‘æ§æ¡†æ¶](https://juejin.im/post/5e84384af265da47e1593102#heading-26)


##### ç¼ºç‚¹

ç›‘æ§ä¸å…¨é¢ï¼Œå› ä¸º App å¯èƒ½ä¸ä½¿ç”¨ç³»ç»Ÿ/OkHttp ç½‘ç»œåº“ï¼Œæˆ–æ˜¯ç›´æ¥ä½¿ç”¨ Native ç½‘ç»œè¯·æ±‚ã€‚

#### 2ã€Native Hook

éœ€è¦ Hook çš„æ–¹æ³•æœ‰ä¸‰ç±»ï¼š

- 1ï¼‰ã€è¿æ¥ç›¸å…³ï¼šconnect
- 2ï¼‰ã€å‘é€æ•°æ®ç›¸å…³ï¼šsend å’Œ sendtoã€‚
- 3ï¼‰ã€æ¥æ”¶æ•°æ®ç›¸å…³ï¼šrecv å’Œ recvfromã€‚


ä¸åŒç‰ˆæœ¬ Socket çš„å®ç°é€»è¾‘ä¼šæœ‰å·®å¼‚ï¼Œä¸ºäº†å…¼å®¹æ€§è€ƒè™‘ï¼Œæˆ‘ä»¬ç›´æ¥ PLT Hook å†…å­˜æ‰€æœ‰çš„ soï¼Œä½†æ˜¯éœ€è¦æ’é™¤æ‰ Socket å‡½æ•°æœ¬èº«æ‰€åœ¨çš„ libc.soã€‚å…¶ PLT çš„ Hook ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š


```java
hook_plt_method_all_lib("libc.so", "connect", (hook_func) &create_hook);
hook_plt_method_all_lib("libc.so, "send", (hook_func) &send_hook);
hook_plt_method_all_lib("libc.so", "recvfrom", (hook_func) &recvfrom_hook);
```


ä¸‹é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ PLT Hook æ¥è·å–ç½‘ç»œè¯·æ±‚ä¿¡æ¯ã€‚


> [é¡¹ç›®åœ°å€](https://github.com/AndroidAdvanceWithGeektime/Chapter17)


å…¶æˆåŠŸ log å¦‚ä¸‹æ‰€ç¤ºï¼š


```
2020-05-21 15:10:37.328 27507-27507/com.dodola.socket E/HOOOOOOOOK: JNI_OnLoad
2020-05-21 15:10:37.328 27507-27507/com.dodola.socket E/HOOOOOOOOK: enableSocketHook
2020-05-21 15:10:37.415 27507-27507/com.dodola.socket E/HOOOOOOOOK: hook_plt_method
2020-05-21 15:10:58.484 27507-27677/com.dodola.socket E/HOOOOOOOOK: socket_connect_hook sa_family: 10
2020-05-21 15:10:58.495 27507-27677/com.dodola.socket E/HOOOOOOOOK: stack:com.dodola.socket.SocketHook.getStack(SocketHook.java:13)
libcore.io.Linux.connect(Native Method)
libcore.io.BlockGuardOs.connect(BlockGuardOs.java:126)
libcore.io.IoBridge.connectErrno(IoBridge.java:152)
libcore.io.IoBridge.connect(IoBridge.java:130)
java.net.PlainSocketImpl.socketConnect(PlainSocketImpl.java:129)
java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:356)
java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:200)
java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:182)
java.net.SocksSocketImpl.connect(SocksSocketImpl.java:357)
java.net.Socket.connect(Socket.java:616)
com.android.okhttp.internal.Platform.connectSocket(Platform.java:145)
com.android.okhttp.internal.io.RealConnection.connectSocket(RealConnection.java:141)
com.android.okhttp.internal.io.RealConnection.connect(RealConnection.java:112)
com.android.okhttp.internal.http.StreamAllocation.findConnection(StreamAllocation.java:184)
com.android.okhttp.internal.http.Strea
2020-05-21 15:10:58.495 27507-27677/com.dodola.socket E/HOOOOOOOOK: AF_INET6 ipv6 IP===>14.215.177.39:443
2020-05-21 15:10:58.495 27507-27677/com.dodola.socket E/HOOOOOOOOK: socket_connect_hook sa_family: 1
2020-05-21 15:10:58.495 27507-27677/com.dodola.socket E/HOOOOOOOOK: Ignore local socket connect
2020-05-21 15:10:58.523 27507-27677/com.dodola.socket E/HOOOOOOOOK: socket_connect_hook sa_family: 1
2020-05-21 15:10:58.523 27507-27677/com.dodola.socket E/HOOOOOOOOK: Ignore local socket connect
2020-05-21 15:10:58.806 27507-27677/com.dodola.socket E/HOOOOOOOOK: respond:<!DOCTYPE html>
<!--STATUS OK--><html> <head><meta http-equiv=content-type content=text/html;charset=utf-8><meta http-equiv=X-UA-Compatible content=IE=Edge><meta content=always name=referrer><link rel=stylesheet type=text/css href=https://ss1.bdstatic.com/5eN1bjq8AAUYm2zgoY3K/r/www/cache/bdorz/baidu.min.css><title>ç™¾åº¦ä¸€ä¸‹ï¼Œä½ å°±çŸ¥é“</title></head> <body link=#0000cc> <div id=wrapper> <div id=head> <div class=head_wrapper> <div class=s_form> <div class=s_form_wrapper> <div id=lg> <img hidefocus=true src=//www.baidu.com/img/bd_logo1.png width=270 height=129> </div> <form id=form name=f action=//www.baidu.com/s class=fm> <input type=hidden name=bdorz_come value=1> <input type=hidden name=ie value=utf-8> <input type=hidden name=f value=8> <input type=hidden name=rsv_bp value=1> <input type=hidden name=rsv_idx value=1> <input type=hidden name=tn value=baidu><span class="bg s_ipt_wr"><input id=kw name=wd class=s_ipt value maxlength=255 autocomplete=off autofocus=autofocus></span><span class="bg s_btn_wr"><input type=submit id=su value=ç™¾åº¦ä¸€ä¸‹ class="bg s_btn" autofocus></span> </form> </div> </div> <div id=u1> <a href=http://news.baidu.com name=tj_trnews class=mnav>æ–°é—»</a> <a href=https://www.hao123.com name=tj_trhao123 class=mnav>hao123</a> <a href=http://map.baidu.com name=tj_trmap class=mnav>åœ°å›¾</a> <a href=http://v.baidu.com name=tj_trvideo class=mnav>è§†é¢‘</a> <a href=http://tieba.baidu.com name=tj_trtieba class=mnav>è´´å§</a> <noscript> <a href=http://www.baidu.com/bdorz/login.gif?login&tpl=mn&u=http%3A%2F%2Fwww.baidu.com%2f%3fbdorz_come%3d1 name=tj_login class=lb>ç™»å½•</a> </noscript> <script>document.write('<a href="http://www.baidu.com/bdorz/login.gif?login&tpl=mn&u='+ encodeURIComponent(window.location.href+ (window.location.search === "" ? "?" : "&")+ "bdorz_come=1")+ '" name="tj_login" class="lb">ç™»å½•</a>');
</script> <a href=//www.baidu.com/more/ name=tj_briicon class=bri style="display: block;">æ›´å¤šäº§å“</a> </div> </div> </div> <div id=ftCon> <div id=ftConw> <p id=lh> <a href=http://home.baidu.com>å…³äºç™¾åº¦</a> <a href=http://ir.baidu.com>About Baidu</a> </p> <p id=cp>Â©2017 Baidu <a href=http://www.baidu.com/duty/>ä½¿ç”¨ç™¾åº¦å‰å¿…è¯»</a>  <a href=http://jianyi.baidu.com/ class=cp-feedback>æ„è§åé¦ˆ</a> äº¬ICPè¯030173å·  <img src=//www.baidu.com/img/gs.gif> </p> </div> </div> </div> </body> </html>
```


æ­¤å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨çˆ±å¥‡è‰ºæä¾›çš„ [android_plt_hook](https://github.com/iqiyi/xHook/blob/master/docs/overview/android_plt_hook_overview.zh-CN.md) æ¥å®ç° PLT Hookã€‚


##### ç¼ºç‚¹

æ¥ç®¡äº†ç³»ç»Ÿçš„ Local Socketï¼Œéœ€è¦åœ¨ä»£ç ä¸­å¢åŠ è¿‡æ»¤æ¡ä»¶ã€‚


### 3ï¼‰ã€æ¥å…¥å±‚ç›‘æ§

> ä¸ºä»€ä¹ˆè¦åšæ¥å…¥å±‚ç›‘æ§ï¼Ÿ

- 1ï¼‰ã€æœåŠ¡ç«¯æ›´å®¹æ˜“åšåˆ°ç§’çº§çš„å®æ—¶ä¸ŠæŠ¥ã€‚
- 2ï¼‰ã€ä»…é å®¢æˆ·ç«¯çš„ç›‘æ§æ•°æ®å¹¶ä¸å®Œå…¨å¯é ã€‚

#### ç›‘æ§ç»´åº¦

æœåŠ¡çš„å…¥å£å’Œå‡ºå£æµé‡ã€æœåŠ¡ç«¯çš„å¤„ç†æ—¶å»¶ã€é”™è¯¯ç‡ç­‰ã€‚


### 4ï¼‰ã€ç›‘æ§æŠ¥è­¦

- 1ï¼‰ã€ç§’çº§æˆ–è€…åˆ†é’Ÿçº§åˆ«çš„å®æ—¶ç›‘æ§åªæœ‰è®¿é—®é‡ï¼ˆPVï¼‰ã€é”™è¯¯ç‡ç­‰å‡ ä¸ªç»´åº¦ï¼šæœ€å¿«é€Ÿåº¦å‘ç°é—®é¢˜ã€‚
- 2ï¼‰ã€å°æ—¶æˆ–è€…å¤©çº§åˆ«çš„ç›‘æ§å¯ä»¥ç›‘æ§å…¨éƒ¨çš„ç»´åº¦ï¼šæ›´å¥½åœ°å®šä½å‡ºé—®é¢˜çš„åŒºåŸŸã€‚


> ç›‘æ§çš„åŒæ—¶å¦‚ä½•å®ç°å‡†ç¡®çš„è‡ªåŠ¨åŒ–æŠ¥è­¦å‘¢ï¼Ÿ


- 1ï¼‰ã€åŸºäºè§„åˆ™ï¼Œä¾‹å¦‚å¤±è´¥ç‡ä¸å†å²æ•°æ®ç›¸æ¯”æš´æ¶¨ã€æµé‡æš´è·Œç­‰ã€‚
- 2ï¼‰ã€åŸºäºæ—¶é—´åºåˆ—ç®—æ³•æˆ–è€…ç¥ç»ç½‘ç»œçš„æ™ºèƒ½åŒ–æŠ¥è­¦ï¼Œä½¿ç”¨è€…ä¸éœ€è¦å½•å…¥ä»»ä½•è§„åˆ™ï¼Œåªéœ€æœ‰è¶³å¤Ÿé•¿çš„å†å²æ•°æ®ï¼Œå°±å¯ä»¥å®ç°è‡ªåŠ¨æŠ¥è­¦ã€‚


é€šå¸¸æ˜¯ä¸¤ç§ç»“åˆä½¿ç”¨ã€‚


## 3ã€å¼‚å¸¸ç›‘æ§ä½“ç³»æ­å»º

### 1ï¼‰ã€æœåŠ¡å™¨é˜²åˆ·

è¶…é™æ‹’ç»è®¿é—®ã€‚

### 2ï¼‰ã€å®¢æˆ·ç«¯

- 1ï¼‰ã€å¤§æ–‡ä»¶é¢„è­¦
- 2ï¼‰ã€å¼‚å¸¸å…œåº•ç­–ç•¥ï¼šä¾‹å¦‚å®¢æˆ·ç«¯è¶…è¿‡5æ¬¡è¿æ¥å¤±è´¥ï¼Œåˆ™è®¾ç½®æ›´é•¿çš„é‡è¯•æ—¶é—´ã€‚


### 3ï¼‰ã€å•ç‚¹é—®é¢˜è¿½æŸ¥

å¦‚æœç”¨æˆ·åé¦ˆ App æ¶ˆè€—çš„æµé‡è¿‡å¤šï¼Œæˆ–åå°æ¶ˆè€—æµé‡è¾ƒå¤šï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å…·ä½“åœ°åˆ†æç½‘ç»œè¯·æ±‚æ—¥å¿—ã€ä»¥åŠä¸‹å‘å‘½ä»¤æŸ¥çœ‹å…·ä½“æ—¶é—´æ®µçš„æµé‡ã€å®¢æˆ·ç«¯çº¿ä¸Šç›‘æ§ + ä½“ç³»åŒ–æ–¹æ¡ˆå»ºè®¾ æ¥å®ç°å•ç‚¹é—®é¢˜çš„è¿½æŸ¥ã€‚


# å…«ã€ç½‘ç»œä¼˜åŒ–å¸¸è§é—®é¢˜

## 1ã€åœ¨ç½‘ç»œæ–¹é¢ä½ ä»¬åšäº†å“ªäº›ç›‘æ§ï¼Œå»ºç«‹äº†å“ªäº›æŒ‡æ ‡ï¼Ÿ

> æ³¨æ„ï¼šä½“ç°æ¼”è¿›çš„è¿‡ç¨‹ã€‚

ç½‘ç»œä¼˜åŒ–åŠç›‘æ§æˆ‘ä»¬åˆšå¼€å§‹å¹¶æ²¡æœ‰å»åšï¼Œå› æ­¤æˆ‘ä»¬åœ¨ APP çš„åˆæœŸå¹¶æ²¡æœ‰æ³¨æ„åˆ°ç½‘ç»œçš„é—®é¢˜ï¼Œå¹¶ä¸”æˆ‘ä»¬é€šå¸¸æ˜¯åœ¨ WIFI åœºæ™¯ä¸‹è¿›è¡Œå¼€å‘ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰æ³¨æ„åˆ°ç½‘ç»œæ–¹é¢çš„é—®é¢˜ã€‚

å½“ APP å¢å¤§åï¼Œç”¨æˆ·å¢å¤šï¼Œé€æ¸ç”±ç”¨æˆ·åé¦ˆ ç•Œé¢æ‰“ä¸å¼€æˆ–ç•Œé¢æ˜¾ç¤ºæ…¢ï¼Œä¹Ÿæœ‰ç”¨æˆ·åé¦ˆæˆ‘ä»¬ APP æ¶ˆè€—çš„æµé‡æ¯”è¾ƒå¤šã€‚åœ¨æˆ‘ä»¬æ¥å—åˆ°è¿™äº›åé¦ˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ²¡æœ‰æ•°æ®æ”¯æ’‘ï¼Œæ— æ³•åˆ¤æ–­ç”¨æˆ·åé¦ˆæ˜¯ä¸æ˜¯æ­£ç¡®çš„ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¸çŸ¥é“çº¿ä¸Šç”¨æˆ·çœŸå®çš„ä½“éªŒæ˜¯æ€æ ·çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å°± **å»ºç«‹äº†çº¿ä¸Šçš„ç½‘ç»œç›‘æ§ï¼Œä¸»è¦åˆ†ä¸º è´¨é‡ç›‘æ§ä¸æµé‡ç›‘æ§**ã€‚

### 1ï¼‰ã€è´¨é‡ç›‘æ§

é¦–å…ˆï¼Œæœ€é‡è¦çš„æ˜¯æ¥å£çš„è¯·æ±‚æˆåŠŸç‡ä¸æ¯æ­¥çš„è€—æ—¶ï¼Œæ¯”å¦‚ DNS çš„è§£ææ—¶é—´ã€å»ºç«‹è¿æ¥çš„æ—¶é—´ã€æ¥å£å¤±è´¥çš„åŸå› ï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶é—´ç‚¹ä¸ŠæŠ¥ç»™æœåŠ¡å™¨ã€‚

### 2ï¼‰ã€æµé‡ç›‘æ§

é¦–å…ˆï¼Œæˆ‘ä»¬è·å–åˆ°äº†ç²¾å‡†çš„æµé‡æ¶ˆè€—æƒ…å†µï¼Œå¹¶ä¸”åœ¨ APM åå°ï¼Œå¯ä»¥ä¸‹å‘æŒ‡ä»¤è·å–ç”¨æˆ·åœ¨å…·ä½“æ—¶é—´æ®µçš„æµé‡æ¶ˆè€—æƒ…å†µã€‚ => å¼•å‡ºäº®ç‚¹ => å‰åå°æµé‡è·å–æ–¹æ¡ˆã€‚
å…³äºæŒ‡æ ‡ => ç½‘ç»œç›‘æ§ã€‚


## 2ã€æ€ä¹ˆæœ‰æ•ˆåœ°é™ä½ç”¨æˆ·çš„æµé‡æ¶ˆè€—ï¼Ÿ

> æ³¨æ„ï¼šç»“åˆå®é™…æ¡ˆä¾‹

### 1ï¼‰ã€æ•°æ®ï¼šç¼“å­˜ã€å¢é‡æ›´æ–°ï¼ˆè¿™ä¸€æ­¥å‡å°‘äº†éå¸¸å¤šçš„æµé‡æ¶ˆè€—ï¼‰

é¦–å…ˆï¼Œæˆ‘ä»¬å¤„ç†äº†é¡¹ç›®å½“ä¸­å±•ç¤ºæ•°æ®ç›¸å…³çš„æ¥å£ï¼ŒåŒæ—¶ï¼Œå¯¹æ—¶æ•ˆæ€§æ²¡é‚£ä¹ˆå¼ºçš„æ¥å£åšäº†æ•°æ®çš„ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯ä¸€æ®µæ—¶é—´å†…çš„é‡å¤è¯·æ±‚ç›´æ¥èµ°ç¼“å­˜ï¼Œè€Œä¸èµ°ç½‘ç»œè¯·æ±‚ï¼Œä»è€Œé¿å…æµé‡æµªè´¹ã€‚å¯¹äºä¸€äº›æ•°æ®çš„æ›´æ–°ï¼Œä¾‹å¦‚çœå¸‚åŒºåŸŸã€é…ç½®ä¿¡æ¯ã€ç¦»çº¿åŒ…ç­‰ä¿¡æ¯ï¼Œæˆ‘ä»¬ **åŠ ä¸Šç‰ˆæœ¬å·çš„æ¦‚å¿µï¼Œä»¥å®ç°æ¯æ¬¡æ›´æ–°åªä¼ é€’å˜åŒ–çš„æ•°æ®ï¼Œå³å®ç°äº†å¢é‡æ›´æ–°** => äº®ç‚¹ï¼šç¦»çº¿åŒ…å¢é‡æ›´æ–°å®ç°åŸç†ä¸å…³é”®ç»†èŠ‚ã€‚

### 2ï¼‰ã€ä¸Šä¼ ï¼šå‹ç¼©

ç„¶åï¼Œæˆ‘ä»¬åœ¨ä¸Šä¼ æµé‡è¿™æ–¹é¢ä¹Ÿåšäº†å¤„ç†ï¼Œæ¯”å¦‚é’ˆå¯¹ POST è¯·æ±‚ï¼Œæˆ‘ä»¬å¯¹ Body åšäº† GZip å‹ç¼©ï¼Œè€Œå¯¹äºå›¾ç‰‡çš„å‘é€ï¼Œå¿…é¡»è¦ç»è¿‡å‹ç¼©ï¼Œå®ƒèƒ½å¤Ÿåœ¨ä¿è¯æ¸…æ™°åº¦çš„å‰æä¸‹æå¤§åœ°å‡å°‘å…¶ä½“ç§¯ã€‚

### 3ï¼‰ã€å›¾ç‰‡ï¼šç¼©ç•¥å›¾ã€webp

å¯¹äºå›¾ç‰‡å±•ç¤ºï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ä¸åŒåœºæ™¯å±•ç¤ºä¸åŒå›¾ç‰‡çš„ç­–ç•¥ï¼Œæ¯”å¦‚åœ¨åˆ—è¡¨å±•ç¤ºç•Œé¢ï¼Œæˆ‘ä»¬åªå±•ç¤ºäº†ç¼©ç•¥å›¾ï¼Œè€Œåˆ°ç”¨æˆ·æ˜¾ç¤ºå¤§å›¾çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰å»å±•ç¤ºåŸå›¾ã€‚ => å¼•å‡º webp çš„ä½¿ç”¨ç­–ç•¥ã€‚


## 3ã€ç”¨æˆ·åé¦ˆæ¶ˆè€—æµé‡å¤šè¿™ç§é—®é¢˜æ€ä¹ˆæ’æŸ¥ï¼Ÿ

é¦–å…ˆï¼Œéƒ¨åˆ†ç”¨æˆ·é‡åˆ°æµé‡æ¶ˆè€—å¤šçš„æƒ…å†µæ˜¯è‚¯å®šä¼šå­˜åœ¨çš„ï¼Œå› ä¸ºçº¿ä¸Šç”¨æˆ·éå¸¸å¤šï¼Œæ¯ä¸ªäººé‡åˆ°çš„æƒ…å†µè‚¯å®šæ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯”å¦‚æœ‰äº›ç”¨æˆ·ä»–çš„æ“ä½œè·¯å¾„æ¯”è¾ƒè¯¡å¼‚ï¼Œå¯èƒ½ä¼šå¼•å‘ä¸€äº›å¼‚å¸¸æƒ…å†µï¼Œå› æ­¤æœ‰äº›ç”¨æˆ·å¯èƒ½ä¼šæ¶ˆè€—æ¯”è¾ƒå¤šçš„æµé‡ã€‚

### 1ï¼‰ã€ç²¾å‡†è·å–æµé‡çš„èƒ½åŠ›

æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯å¯ä»¥ç²¾ç¡®qåœ°è·å–åˆ°æµé‡çš„æ¶ˆè€—ï¼Œè¿™æ ·å°±ç»™æˆ‘ä»¬æ’æŸ¥ç”¨æˆ·çš„æµé‡æ¶ˆè€—æä¾›äº†ä¾æ®ï¼Œæˆ‘ä»¬å°±çŸ¥é“ç”¨æˆ·çš„æµé‡æ¶ˆè€—æ˜¯ä¸æ˜¯å¾ˆå¤šã€‚

### 2ï¼‰ã€æ‰€æœ‰è¯·æ±‚å¤§å°åŠæ¬¡æ•°çš„ç›‘æ§

æ­¤å¤–ï¼Œé€šè¿‡ç½‘ç»œè¯·æ±‚è´¨é‡çš„ç›‘æ§ï¼Œæˆ‘ä»¬çŸ¥é“äº†ç”¨æˆ·æ‰€æœ‰ç½‘ç»œè¯·æ±‚çš„æ¬¡æ•°ä¸å¤§å°ï¼Œé€šè¿‡å¤§å°å’Œæ¬¡æ•°æ’æŸ¥ï¼Œæˆ‘ä»¬å°±èƒ½çŸ¥é“ç”¨æˆ·åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°äº†å“ªäº› bug æˆ–è€…æ˜¯æ‰§è¡Œäº†ä¸€äº›å¼‚å¸¸çš„é€»è¾‘å¯¼è‡´é‡å¤ä¸‹è½½ï¼Œå¤„äºä¸æ–­é‡è¯•çš„è¿‡ç¨‹ä¹‹ä¸­ã€‚

### 3ï¼‰ã€ä¸»åŠ¨é¢„è­¦çš„èƒ½åŠ›

åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å‘ç°äº†ç±»ä¼¼çš„é—®é¢˜ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦é…å¤‡ä¸»åŠ¨é¢„è­¦çš„èƒ½åŠ›ï¼ŒåŠæ—¶åœ°é€šçŸ¥å¼€å‘åŒå­¦è¿›è¡Œæ’é™¤éªŒè¯ï¼Œé€šè¿‡ä»¥ä¸Šæ‰‹æ®µï¼Œæˆ‘ä»¬å¯¹å¾…ç”¨æˆ·çš„åé¦ˆå°±èƒ½æ›´åŠ é«˜æ•ˆçš„è§£å†³ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰äº†ç”¨æˆ·æ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚æ•°æ®ã€‚


## 4ã€ç³»ç»Ÿå¦‚ä½•çŸ¥é“å½“å‰ WiFi æœ‰é—®é¢˜ï¼Ÿ

å¦‚æœä¸€ä¸ª WiFi å‘é€è¿‡æ•°æ®åŒ…ï¼Œä½†æ˜¯æ²¡æœ‰æ”¶åˆ°ä»»ä½•çš„ ACK å›åŒ…ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥åˆæ­¥åˆ¤æ–­å½“å‰çš„ WiFi æ˜¯æœ‰é—®é¢˜çš„ã€‚


# ä¹ã€æ€»ç»“

ç½‘ç»œä¼˜åŒ–å¯ä»¥è¯´æ˜¯ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–é¢†åŸŸä¸­æ°´æœ€æ·±çš„é¢†åŸŸä¹‹ä¸€ï¼Œè¦æƒ³åšå¥½ç½‘ç»œä¼˜åŒ–å¿…é¡»å…·å¤‡éå¸¸æ‰å®çš„æŠ€æœ¯åŠŸåº•ä¸å…¨é“¾è·¯æ€ç»´ã€‚æ€»æ‰€å‘¨çŸ¥ï¼Œå¯¹äºä¸€ä¸ªå·¥ç¨‹å¸ˆçš„æŠ€æœ¯è¯„çº§å¾€å¾€æ˜¯ä»¥ä»–æœ€æ·±å…¥çš„é‚£ä¸€ä¸¤ä¸ªé¢†åŸŸä¸ºåŸºå‡†ï¼Œè€Œä¸æ˜¯è®¡ç®—å…¶æŠ€æœ¯æ ˆçš„å¹³å‡å€¼ã€‚å› æ­¤ï¼Œå»ºè®®å¤§å®¶èƒ½æ‰¾å‡†ä¸€ä¸¤ä¸ªç‚¹ï¼Œä¾‹å¦‚ ç½‘ç»œã€å†…å­˜ã€NDKã€Flutterï¼Œå¯¹å…¶è¿›è¡Œæ·±å…¥æŒ–æ˜ï¼Œä»¥æ‰“é€ è‡ªèº«çš„æŠ€æœ¯å£å’ã€‚è€Œç¬”è€…åç»­ä¹Ÿä¼šåˆ©ç”¨æ™šä¸Šçš„æ—¶é—´ç»§ç»­æ·±å…¥ **ç½‘ç»œåè®®ä¸å®‰å…¨** çš„é¢†åŸŸï¼Œå¼€å§‹æŒç»­ä¸æ–­åœ°æ·±å…¥æŒ–æ˜ã€‚


# å‚è€ƒé“¾æ¥ï¼š
---

- 1ã€[æ…•è¯¾ç½‘ä¹‹Topå›¢é˜Ÿå¤§ç‰›å¸¦ä½ ç©è½¬Androidæ€§èƒ½åˆ†æä¸ä¼˜åŒ– ç¬¬å…«ç«  Appç½‘ç»œä¼˜åŒ–](https://coding.imooc.com/learn/list/308.html)
- 2ã€[æå®¢æ—¶é—´ä¹‹Androidå¼€å‘é«˜æ‰‹è¯¾ ç½‘ç»œä¼˜åŒ–](https://time.geekbang.org/column/article/80100)
- 3ã€ã€ŠAndroidç§»åŠ¨æ€§èƒ½å®æˆ˜ã€‹ç¬¬ä¸‰ç«  ç½‘ç»œ
- 5ã€[æå®¢æ—¶é—´ä¹‹Web åè®®è¯¦è§£ä¸æŠ“åŒ…å®æˆ˜](https://time.geekba4g.org/course/detail/100026801-100973)
- 5ã€[geektime-geekbang/geektime-webprotocol](https://github.com/geektime-geekbang/geektime-webprotocol)
- 6ã€[wanandroid ç½‘ç»œä¼˜åŒ–](https://www.wanandroid.com/article/query?k=%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96)
- 7ã€[chrome TLS1.3 è®¾ç½®](chrome://flags/#tls13-hardening-for-local-anchors)
- 8ã€[ç¾å›¢ç‚¹è¯„ç§»åŠ¨ç½‘ç»œä¼˜åŒ–å®è·µ](https://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651746151&idx=2&sn=b21d43476f6a7154b71b008bc263ffb5&chksm=bd12b62a8a653f3caae12f0b20c46fc6855c063f83d8600ff9f9a7879beb70065748108beb2a&scene=38#wechat_redirect)
- 9ã€[è˜‘è‡è¡— App Chromium ç½‘ç»œæ ˆå®è·µ](https://www.infoq.cn/article/mogujie-app-chromium-network-layer?useSponsorshipSuggestions=true%2F)
- 10ã€[å¾®ä¿¡Mars â€” ç§»åŠ¨äº’è”ç½‘ä¸‹çš„é«˜è´¨é‡ç½‘ç»œè¿æ¥æ¢ç´¢.pdf](https://github.com/WeMobileDev/article/blob/master/%E5%BE%AE%E4%BF%A1Mars%20%E2%80%94%20%E7%A7%BB%E5%8A%A8%E4%BA%92%E8%81%94%E7%BD%91%E4%B8%8B%E7%9A%84%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E6%8E%A2%E7%B4%A2.pdf)
- 11ã€[Mars -- å¾®ä¿¡è·¨å¹³å°è·¨ä¸šåŠ¡åŸºç¡€ç»„ä»¶](https://github.com/Tencent/mars/wiki)
- 12ã€[é˜¿é‡Œæ— çº¿ 11.11ï¼šæ‰‹æœºæ·˜å®ç§»åŠ¨ç«¯æ¥å…¥ç½‘å…³åŸºç¡€æ¶æ„æ¼”è¿›ä¹‹è·¯](https://www.infoq.cn/article/taobao-mobile-terminal-access-gateway-infrastructure)
- 13ã€[è´¾å²›ï¼šèš‚èšé‡‘æœäº¿çº§å¹¶å‘ä¸‹çš„ç§»åŠ¨ç«¯åˆ°ç«¯ç½‘ç»œæ¥å…¥æ¶æ„è§£æ](https://mp.weixin.qq.com/s/nz8Z3Uj9840KHluWjwyelw)
- 14ã€[æºç¨‹ App çš„ç½‘ç»œæ€§èƒ½ä¼˜åŒ–å®è·µ](https://www.infoq.cn/article/how-ctrip-improves-app-networking-performance)
- 15ã€[ç™¾åº¦Appç½‘ç»œæ·±åº¦ä¼˜åŒ–ç³»åˆ—ã€Šä¸€ã€‹DNSä¼˜åŒ–](https://mp.weixin.qq.com/s/iaPtSF-twWz-AN66UJUBDg)
- 16ã€[google/brotli](https://github.com/google/brotli)
- 17ã€[facebook/zstd](https://github.com/facebook/zstd)
- 18ã€[çœ‹å¾—ã€Œæ·±ã€ã€çœ‹å¾—ã€Œæ¸…ã€â€”â€” æ·±åº¦å­¦ä¹ åœ¨å›¾åƒè¶…æ¸…åŒ–çš„åº”ç”¨](http://imgtec.eetrend.com/d6-imgtec/blog/2017-08/10143.html)
- 19ã€[TLS1.3 VS TLS1.2ï¼Œè®©ä½ æ˜ç™½TLS1.3çš„å¼ºå¤§](https://zhuanlan.zhihu.com/p/44980381)
- 20ã€[åŸºäºTLS1.3çš„å¾®ä¿¡å®‰å…¨é€šä¿¡åè®®mmtlsä»‹ç»](https://mp.weixin.qq.com/s/tvngTp6NoTZ15Yc206v8fQ)
- 21ã€[Facebookæ˜¯å¦‚ä½•å¤§å¹…æå‡TLSè¿æ¥æ•ˆç‡çš„ï¼Ÿ](https://mp.weixin.qq.com/s?__biz=MzI4MTY5NTk4Ng==&mid=2247489465&idx=1&sn=a54e3fe78fc559458fa47104845e764b&source=41#wechat_redirect)
- 22ã€[SSL Pinning Practice](https://github.com/WooyunDota/DroidDrops/blob/master/2018/SSL.Pinning.Practice.md#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%B3%BB%E7%BB%9F%E8%AF%81%E4%B9%A6%E9%94%81%E5%AE%9A-system-ca-pinning)
- 23ã€[P2På¦‚ä½•å°†è§†é¢‘ç›´æ’­å¸¦å®½é™ä½75%ï¼Ÿ](https://mp.weixin.qq.com/s?__biz=MzI4MTY5NTk4Ng==&mid=2247489182&idx=1&sn=e892855fd315ed2f1395f05b765f9c4e&source=41#wechat_redirect)
- 24ã€[BBR: Congestion-Based Congestion Control](https://queue.acm.org/detail.cfm?id=3022184)
- 25ã€[QUICåœ¨æ‰‹æœºå¾®åšä¸­çš„åº”ç”¨å®è·µ.pdf](https://github.com/thinkpiggy/qcon2018ppt/blob/master/QUIC%E5%9C%A8%E6%89%8B%E6%9C%BA%E5%BE%AE%E5%8D%9A%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pdf)
- 26ã€[Hook Socket Sample](https://github.com/AndroidAdvanceWithGeektime/Chapter17)
- 27ã€[RFC ç›®å½•](https://tools.ietf.org/rfc/index)



# Contanct Me

##  â—  å¾®ä¿¡ï¼š

> æ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡ï¼š`bcce5360`  

##  â—  å¾®ä¿¡ç¾¤ï¼š

> **ç”±äºå¾®ä¿¡ç¾¤äººæ•°è¿‡å¤šï¼Œéº»çƒ¦å¤§å®¶æƒ³è¿›å¾®ä¿¡ç¾¤çš„æœ‹å‹ä»¬ï¼ŒåŠ æˆ‘å¾®ä¿¡æ‹‰ä½ è¿›ç¾¤ã€‚**
        

##  â—  QQç¾¤ï¼š

> 2åƒäººQQç¾¤ï¼Œ**Awesome-Androidå­¦ä¹ äº¤æµç¾¤ï¼ŒQQç¾¤å·ï¼š959936182**ï¼Œ æ¬¢è¿å¤§å®¶åŠ å…¥~


## About me

- ### Email: [chao.qu521@gmail.com]()
- ### Blog: [https://jsonchao.github.io/](https://jsonchao.github.io/)
- ### æ˜é‡‘: [https://juejin.im/user/5a3ba9375188252bca050ade](https://juejin.im/user/5a3ba9375188252bca050ade)
    

### å¾ˆæ„Ÿè°¢æ‚¨é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Œå¸Œæœ›æ‚¨èƒ½å°†å®ƒåˆ†äº«ç»™æ‚¨çš„æœ‹å‹æˆ–æŠ€æœ¯ç¾¤ï¼Œè¿™å¯¹æˆ‘æ„ä¹‰é‡å¤§ã€‚

### å¸Œæœ›æˆ‘ä»¬èƒ½æˆä¸ºæœ‹å‹ï¼Œåœ¨ [Github](https://github.com/JsonChao)ã€[æ˜é‡‘](https://juejin.im/user/5a3ba9375188252bca050ade)ä¸Šä¸€èµ·åˆ†äº«çŸ¥è¯†ã€‚



















