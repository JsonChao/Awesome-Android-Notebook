---

		title:  æ·±å…¥æ¢ç´¢ Android ç”µé‡ä¼˜åŒ–
		date: 2020/2/5 17:43:00   
		tags: 
		- Androidè¿›é˜¶
		categories: Androidè¿›é˜¶
		thumbnail: https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1557665970516&di=b58d306a0db07efca58f8c9b655f5c13&imgtype=0&src=http%3A%2F%2Fimg02.tooopen.com%2Fimages%2F20160520%2Ftooopen_sl_055418231108.jpg
---

---


# å‰è¨€

### æˆä¸ºä¸€åä¼˜ç§€çš„Androidå¼€å‘ï¼Œéœ€è¦ä¸€ä»½å®Œå¤‡çš„[çŸ¥è¯†ä½“ç³»](https://github.com/JsonChao/Awesome-Android-Exercise)ï¼Œåœ¨è¿™é‡Œï¼Œè®©æˆ‘ä»¬ä¸€èµ·æˆé•¿ä¸ºè‡ªå·±æ‰€æƒ³çš„é‚£æ ·~ã€‚


# æœ¬æ–‡æ€ç»´å¯¼å›¾

![](https://user-gold-cdn.xitu.io/2020/6/16/172ba7fbb74412e8?w=3210&h=1328&f=png&s=520243)   


# ä¸€ã€æ­£ç¡®è®¤è¯†

## 1ã€ä¸ºä»€ä¹ˆè¦åšç”µé‡ä¼˜åŒ–ï¼Ÿ

åœ¨ Android åº”ç”¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•ä¼˜åŒ–ç”µé‡ä½¿ç”¨ï¼Œè®©æˆ‘ä»¬çš„ App ä¸ä¼šå› ä¸ºç”µé‡æ¶ˆè€—è¿‡é«˜è¢«ç”¨æˆ·æ’æ–¥ï¼Œæˆ–è€…è¢«å…¶ä»–å®‰å…¨åº”ç”¨æŠ¥å‘Šï¼Œä»¥æ­¤ç¡®ä¿ç”¨æˆ·é»æ€§ã€‚

## 2ã€ç”µé‡é‡è§†åº¦ä¸å¤Ÿ

å¼€å‘ä¸­ä¸€ç›´è¿æ¥æ‰‹æœºï¼Œä¸çŸ¥é“ç”µé‡æ¶ˆè€—æœ‰å¤šå¿«ã€‚

## 3ã€ç”µé‡æ¶ˆè€—çº¿ä¸Šéš¾ä»¥é‡åŒ–

æˆ‘ä»¬æ²¡æœ‰åŠæ³•æ‹¿åˆ°æ¯ä¸€ä¸ªç”¨æˆ·æ‰‹æœºçš„ç»„ä»¶èƒ½è€—ï¼Œå…¶ä¸­ä¸åŒçš„ç¡¬ä»¶æ¨¡å—ä½¿ç”¨äº†ä¸åŒçš„å‚æ•°ï¼Œç„¶åä½¿ç”¨äº†ä¸åŒçš„ç®—æ³•æ¥è¿›è¡Œä¼°ç®—ã€‚ä½†æ˜¯ï¼Œå…·ä½“çš„å‚æ•°å€¼æ ¹æ®æ‰‹æœºæ‰€ä½¿ç”¨çš„ç¡¬ä»¶æ¥è¯´æ˜¯ä¸ä¸€æ ·çš„ã€‚


# äºŒã€ç”µæ± æŠ€æœ¯

## 1ã€ç”µæ± å®¹é‡

ç°åœ¨ä¸€èˆ¬æ‰‹æœºçš„ç”µæ± å®¹é‡ä¼šå ç”¨å†…éƒ¨ç»„ä»¶å°†è¿‘ä¸€åŠçš„ç©ºé—´ã€‚

## 2ã€å……ç”µæ—¶é—´

### 1ï¼‰ã€OPPO VOOC é—ªå……æŠ€æœ¯

- 1ã€é€‚é…å™¨ä¸­åŠ å…¥ MCU æ™ºèƒ½èŠ¯ç‰‡ï¼Œå¾—ç›Šäº MCU å¯¹ç”µæµçš„ç²¾å‡†è°ƒèŠ‚ï¼ŒVOOC å®ç°äº†åˆ†æ®µæ’æµå’Œåˆ†æ¡£æŠ€æœ¯ï¼Œèµ·æ­¥æ—¶ï¼ŒVOOC ä¼šæŒ‚ä¸Šé«˜é€Ÿæ¡£ï¼Œä¸­é—´æ—¶ä¼šè‡ªåŠ¨æŒ‚ä¸Šä¸­é€Ÿæ¡£ï¼Œè®©ä½ å¿«é€Ÿå‰è¡Œï¼Œç»“å°¾æ—¶åˆä¼šåˆ‡æ¢æˆä½é€ŸæŒ¡ï¼Œè®©ä½ å¹³ç¨³åˆ°ç«™ã€‚
- 2ã€ä»é€‚é…å™¨åˆ°æ¥å£å†åˆ°æ‰‹æœºå†…éƒ¨çš„å…¨ç«¯å¼äº”é‡é˜²æŠ¤æŠ€æœ¯ã€‚
    - 1ï¼‰ã€é€‚é…å™¨è¿‡è½½ä¿æŠ¤
ç”µæµè¿›å…¥é€‚é…å™¨æ—¶ï¼Œå…¶ä¸­çš„ä¼ æ„Ÿå™¨ä¼šå®æ—¶æ£€æµ‹ç”µå‹ç”µæµï¼Œå®‰å…¨æ—¶ï¼Œ MOSFETï¼ˆä¿æŠ¤ï¼‰å¼€å…³ä¼šè‡ªåŠ¨æ‰“å¼€é—ªå……ã€‚
    - 2ï¼‰ã€é—ªå……æ¡ä»¶é‰´å®šä¿æŠ¤
ç”µæµé€šè¿‡é€‚é…å™¨æ—¶ï¼ŒMCU èŠ¯ç‰‡ä¼šè¯†åˆ«è®¾å¤‡æ˜¯å¦æ”¯æŒé—ªå……ï¼Œåªæœ‰æ”¯æŒæ‰å¼€å¯é—ªå……ä¸ç¬¬äºŒçº§è¿‡è½½ä¿æŠ¤ã€‚
    - 3ï¼‰ã€æ¥å£è¿‡è½½ä¿æŠ¤
ç”µæµè¿›å…¥æ‰‹æœºæ—¶ï¼Œåœ¨ç‰¹åˆ«å®šåˆ¶çš„ 7pinUSB æ¥å£å¤„ï¼Œæ‰‹æœºå†…çš„ MCU ä¼šæ§åˆ¶ç¬¬ä¸‰ä¸ª MOSFETï¼ˆä¿æŠ¤ï¼‰å¼€å…³ï¼Œå®è¡Œç¬¬ä¸‰çº§è¿‡è½½ä¿æŠ¤ã€‚
    - 4ï¼‰ã€ç”µæ± è¿‡è½½ä¿æŠ¤
ç”µæ± å†…çš„ç‰¹æ®Š IC å’Œ MOSFETï¼ˆä¿æŠ¤ï¼‰å¼€å…³è´Ÿè´£å¯¹è¿›å…¥ç”µæ± çš„ç”µå‹ç”µæµå®è¡Œè¿‡è½½ä¿æŠ¤ã€‚
    - 5ï¼‰ã€ç”µæ± ç†”ä¸ä¿æŠ¤
å‡ºç°å¼‚å¸¸æ—¶ï¼Œç”µæ± å†…çš„ä¿é™©ä¸ä¼šç«‹å³ç†”æ–­ï¼Œç‰©ç†æ€§æ–­ç»ç”µæµè¾“å…¥ã€‚
- 3ã€å°†å……ç”µå®‰å…¨æŒ‡æ•°ä» PPMï¼ˆç™¾ä¸‡åˆ†ä¹‹ä¸€ï¼‰æå‡è‡³èˆªå¤©çº§åˆ« DPMï¼ˆåäº¿åˆ†ä¹‹ä¸€ï¼‰ã€‚


### 2ï¼‰ã€å¿«å……æŠ€æœ¯

P=UIï¼ˆç”µåŠŸç‡=ç”µå‹ * ç”µæµï¼‰

#### æ™®é€šå……ç”µè¿‡ç¨‹

- 1ï¼‰ã€å…ˆå°† 220V ç”µå‹é€šè¿‡å……ç”µå¤´é™è‡³ 5Vã€‚
- 2ï¼‰ã€ç„¶åï¼Œæ‰‹æœºå†…éƒ¨ç”µè·¯å†æŠŠ 5V ç”µå‹é™è‡³ 4.2Vã€‚
- 3ï¼‰ã€æœ€åï¼ŒæŠŠç”µé‡è¾“é€ç»™ç”µæ± ï¼Œè€Œæ•´ä¸ªé™å‹çš„è¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿçƒ­èƒ½ã€‚


#### åˆ†ç±»

- 1ï¼‰ã€é«˜å‹ä½ç”µæµå¿«å……æ–¹æ¡ˆï¼šåœ¨å……ç”µè¿‡ç¨‹ä¸­å›½æå‡å……ç”µç”µå‹ï¼ˆ7-20Vï¼‰æ¥æå‡å……ç”µåŠŸç‡ã€‚
- 2ï¼‰ã€ä½å‹å¤§ç”µæµå¿«å……æ–¹æ¡ˆï¼šåœ¨ç”µå‹ä¸€å®šæƒ…å†µä¸‹ï¼Œå¢åŠ ç”µæµï¼Œé€šå¸¸ä½¿ç”¨å¹¶è”ç”µè·¯çš„æ–¹å¼è¿›è¡Œåˆ†æµã€‚


### 3ï¼‰ã€é“-çŸ³å¢¨çƒ¯è¶…çº§ç”µæ± 

- è¶…é«˜è€ç”¨æ€§å’Œå®‰å…¨æ€§ï¼Œå¿«å……å……ç”µ1.1ç§’å°±èƒ½å……æ»¡ç”µã€‚
- å®éªŒé˜¶æ®µã€‚


## 3ã€å¯¿å‘½

é€šå¸¸ä½¿ç”¨å……ç”µå¾ªç¯æ¬¡æ•°è¡¡é‡ã€‚


## 4ã€å®‰å…¨æ€§

ä¸¥æ ¼æ§åˆ¶ç”µæ± å®¹é‡ï¼Œä¾‹å¦‚ VOOC å°±ä½¿ç”¨äº†å„ç§å®‰å…¨æ£€æµ‹æŠ€æœ¯ã€‚


## 5ã€ç”µé‡å’Œç¡¬ä»¶

- æ‰‹æœºè€—ç”µæ˜¯é€šè¿‡ä½¿ç”¨ç›¸åº”çš„ç¡¬ä»¶æ¨¡å—æ¥æ¶ˆè€—ç”µèƒ½ã€‚
- CPUã€å±å¹•ã€WIFIã€æ•°æ®ç½‘ç»œã€GPSã€éŸ³è§†é¢‘é€šè¯åœ¨æ—¥å¸¸è€—ç”µé‡ä¸­å æ¯”æœ€å¤§ã€‚


## 6ã€Android è€—ç”µæ¼”è¿›

### KITKAT

#### æ‰¹å¤„ç†ä¼ æ„Ÿå™¨

åˆ†æ‰¹æœ‰æ•ˆåœ°æ”¶é›†å’Œä¼ é€’ä¼ æ„Ÿå™¨äº‹ä»¶ã€‚

#### Alarm å¯¹é½

æ‰¹å¤„ç†åœ¨åˆç†çš„ç›¸ä¼¼æ—¶é—´å†…çš„æ‰€æœ‰åº”ç”¨çš„é—¹é“ƒï¼Œä»¥ä¾¿ç³»ç»Ÿä»…å”¤é†’ä¸€æ¬¡ã€‚

### Lollipop

- å¼€å¯ Volta é¡¹ç›®
- Job Scheduler
- dumpsys batterystats
- Battery Historian
- ä¿®å¤ native fork è¿›ç¨‹ä¿æ´»çš„ bug


### Marshmallow

- çœç”µåŠŸèƒ½
- Doze ä½åŠŸè€—æ¨¡å¼
- App Standby åº”ç”¨å¾…æœºæ‘¸æ‰‹æœº


### Nougat

- ä¼˜åŒ–çœç”µåŠŸèƒ½
- Doze åŠ å¼ºç‰ˆ
- implicit broadcasts æ˜¾ç¤º
- æ··åˆç¼–è¯‘


### Oreo

- æ›´å¤šä¼˜åŒ–çœç”µåŠŸèƒ½
- åå°æ‰§è¡Œé™åˆ¶
- åå°ä½ç½®é™åˆ¶


### Pï¼ˆç”µå‹ç®¡ç†ä¸¥æ ¼é™åˆ¶ï¼‰

#### åº”ç”¨å¾…æœºåˆ†ç»„ï¼ˆApp Standby Buecketsï¼‰

- ä»åº”ç”¨å®‰è£…å¼€å§‹ã€‚
- åˆ†ç»„å†³å®šåå°è¢«é™åˆ¶çš„ç¨‹åº¦ã€‚
- ä¸å¸¸ç”¨çš„åº”ç”¨å°†è¢«é™åˆ¶åœ°æ›´åŠ ä¸¥æ ¼ã€‚


#### åº”ç”¨åå°é™åˆ¶ï¼ˆBackground Restrictionsï¼‰

- ç”¨æˆ·å¼€å¯ã€‚
- åœæ­¢åå°è¿è¡Œã€‚
- æç¤ºç”¨æˆ·åå°è€—ç”µä¸¥é‡çš„åº”ç”¨ï¼Œç”¨æˆ·å¯é€‰æ‹©åœæ­¢å®ƒä»¬çš„åå°è¿è¡Œã€‚


#### çœç”µæ¨¡å¼ï¼ˆBattery Saverï¼‰

- ç”¨æˆ·å¼€å¯ã€‚
- æ‰€æœ‰åº”ç”¨è¿›å…¥å¾…æœºæ¨¡å¼ã€‚
- æ›´åŠ ä¸¥æ ¼çš„åå°é™åˆ¶ï¼Œè€Œä¸”æ— è§†åº”ç”¨çš„ Target APIã€‚


# ä¸‰ã€ç”µé‡æ£€æµ‹æ–¹æ¡ˆ

å¯¹äºç”µé‡çš„ç»Ÿè®¡æœ‰ä¸€ä¸ªå…¬å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
æ¨¡å—ç”µé‡ï¼ˆmAhï¼‰ = æ¨¡å—ç”µæµï¼ˆmAï¼‰* æ¨¡å—è€—æ—¶ï¼ˆhï¼‰
```

Android ç³»ç»Ÿè¦æ±‚ ROM å‚å•†å¿…é¡»åœ¨ /frameworks/base/core/res/res/xml/power_profile.xml æä¾›ç»„ä»¶çš„ç”µæºé…ç½®æ–‡ä»¶ã€‚è€Œ Android ç³»ç»Ÿçš„ç”µé‡è®¡ç®— PowerProfile æ­£æ˜¯é€šè¿‡è¯»å– power_profile.xml çš„æ•°æ®ã€‚


## 1ã€è®¾ç½®â€”è€—ç”µæ’è¡Œ

- 1ï¼‰ã€ç›´è§‚ï¼Œä½†æ²¡æœ‰è¯¦ç»†æ•°æ®ï¼Œå¯¹è§£å†³é—®é¢˜å¸®åŠ©ä¸å¤§ã€‚
- 2ï¼‰ã€éœ€è¦æ‰¾ç‰¹å®šåœºæ™¯ä¸“é¡¹æµ‹è¯•ï¼Œæ¯”å¦‚åœ¨æŸä¸€ä¸ªç•Œé¢æ“ä½œä¸€æ®µæ—¶é—´ï¼Œç„¶åæ¥åˆ¤æ–­è¿™ä¸ªé¡µé¢æ˜¯å¦è€—ç”µã€‚

## 2ã€ä½¿ç”¨å¹¿æ’­ç›‘å¬ç”µé‡å˜åŒ–â€”ACTION_BATTERY_CHANGED

è·å–ç”µæ± ç”µé‡ã€å……ç”µçŠ¶æ€ã€ç”µæ± çŠ¶æ€ç­‰ä¿¡æ¯ã€‚

### å®æˆ˜æ¡ˆä¾‹

```java
IntentFilter filter = new IntentFilter();
filter.addAction(Intent.ACTION_BATTERY_CHANGED);
Intent intent = registerReceiver(null, filter);
LogUtils.i("battery " + intent.getIntExtra(BatteryManager.EXTRA_LEVEL, -1));
```


### ç¼ºç‚¹

- 1ï¼‰ã€ä»·å€¼ä¸å¤§ï¼šé’ˆå¯¹æ‰‹æœºæ•´ä½“çš„è€—ç”µé‡ï¼Œè€Œéå•ä¸ª Appã€‚
- 2ï¼‰ã€å®æ—¶æ€§å·®ã€ç²¾åº¦è¾ƒä½ï¼Œè¢«åŠ¨é€šçŸ¥ã€‚


## 3ã€dumpsys batterystats

batterystats æ˜¯ Android 5.0 æä¾›çš„å·¥å…·ï¼Œå®ƒå¯ä»¥è·å–å„ä¸ª App çš„ WakeLockã€CPU æ—¶é—´å ç”¨ç­‰ä¿¡æ¯ï¼ŒåŒæ—¶å¢åŠ äº†ä¸€ä¸ª Estimated power useï¼ˆmAhï¼‰åŠŸèƒ½ï¼Œé¢„ä¼°è€—ç”µé‡ã€‚

### ä½œç”¨

å°†ç”µé‡æµ‹é‡è½¬åŒ–ä¸ºåŠŸèƒ½æ¨¡å—çš„ä½¿ç”¨æ—¶é—´æˆ–è€…æ¬¡æ•°ã€‚

```java
adb shell dumpsys batterystats > battery.txt
```


åœ¨ battery.txt æœç´¢ â€˜Estimated power useâ€™ å…³é”®å­—ï¼Œä¸‹é¢ç²—ç•¥ç»Ÿè®¡äº†å„ä¸ª Uid çš„æ€»è€—ç”µé‡ã€‚

```java
Estimated power use (mAh):
Capacity: 3350, Computed drain: 2767, actual drain: 3752-3853
Uid 1000: 1014 ( cpu=999 wake=1.36 radio=11.4 wifi=1.24 gps=0.435 sensor=0.808 ) Excluded from smearing
Unaccounted: 985 ( ) Including smearing: 0 ( ) Excluded from smearing
Uid 0: 416 ( cpu=157 wake=210 radio=38.8 wifi=9.51 ) Excluded from smearing
...
```


batterystats æ‰€è®°å½•çš„ç”µé‡ç»Ÿè®¡æ•°æ®æºè‡ªäº BatteryStatsService-ç”µé‡ç»Ÿè®¡æœåŠ¡ï¼Œå…¶å®ç°ç±»ä¸º BatteryStatsImplï¼Œå†…éƒ¨æ­£æ˜¯ä½¿ç”¨çš„ PowerProfile ã€‚

BatteryStatsImpl ä¸ºæ¯ä¸€ä¸ªåº”ç”¨åˆ›å»ºä¸ä¹‹å¯¹åº”çš„ UID æ¥ç›‘æ§å™¨ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨æƒ…å†µï¼Œå…¶ç»Ÿè®¡äº† 12 å¤§æ¨¡å—çš„ç”µé‡æ¶ˆè€—ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

- Cameraã€Audioã€Video
- Bluetoothã€Networkã€Wakelock
- Sensorã€Radioã€Screen
- WIFIã€CPUã€GPS




## 4ã€[Battery Historian](https://github.com/google/battery-historian)

### ç‰¹ç‚¹

- 1ï¼‰ã€æŸ¥çœ‹è‡ªè®¾å¤‡ä¸Šæ¬¡å……ç”µä»¥æ¥å„ç§æ±‡æ€»ç»Ÿè®¡ä¿¡æ¯ï¼Œè€Œä¸”å¯ä»¥é€‰æ‹©å¯¹åº”çš„ App æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚
- 2ï¼‰ã€å¯è§†åŒ–å±•ç¤ºæŒ‡æ ‡ï¼š
    - è€—ç”µæ¯”ä¾‹ã€‚
    - æ‰§è¡Œæ—¶é—´ã€æ¬¡æ•°ã€‚
- 3ï¼‰ã€ä»…é€‚åˆçº¿ä¸‹ä½¿ç”¨ã€‚

### å®‰è£…

- 1ï¼‰ã€å®‰è£… Docker
- 2ï¼‰ã€docker -- run -p <port>:9999 gcr.io/android-battery-historian/stable:3.0 --port 9999 ï¼ˆéœ€è¦å¤–ç½‘ï¼‰


### å¯¼å‡ºç”µé‡ä¿¡æ¯

- 1ï¼‰ã€ä½¿ç”¨ batterystats å‘½ä»¤é‡ç½®æ‰‹æœºç”µé‡ï¼šadb shell dumpsys batterystats --reset
- 2)ã€ä½¿ç”¨ batterystats å‘½ä»¤è·å–ç”µæ± æ•°æ®æƒé™å¹¶å¼€å¯è®°å½•å…¨é¢çš„ç”µé‡ä¿¡æ¯ï¼šadb shell dumpsys batterystats --enable full-wake-history
- 3ï¼‰ã€æµ‹è¯•å®Œæˆåï¼Œä½¿ç”¨ bugreport å¯¼å‡ºç”µé‡ä¿¡æ¯ï¼š
    - 7.0å’Œ7.0ä»¥åï¼šadb bugreport bugreport.zip
    - 6.0å’Œ6.0ä¹‹å‰:adb bugreport > bugreport.txt
    - é€šè¿‡ historian å›¾å½¢åŒ–å±•ç¤ºç»“æœï¼špython historian.py -a bugreport.txt > battery.html


### ä¸Šä¼ åˆ†æ

- 1ï¼‰ã€æ‰“å¼€ http://localhost:<port>

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc7d4df779e2?w=1500&h=594&f=png&s=84722)


å¦‚æœæ‰“ä¸å¼€ï¼Œå¯ä»¥ä½¿ç”¨å¤‡ç”¨ç½‘ç«™ [bathist](https://bathist.ef.lc/)


- 2ï¼‰ã€ä¸Šä¼  bugreport æ–‡ä»¶ï¼Œç‚¹ Submit æäº¤å³å¯ã€‚


### Battery Historian æ•°æ®åˆ†æ

#### Hitorian V2 â€” ç”µé‡ç»Ÿè®¡å›¾è¡¨

##### Add Metrics

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc804811b00e?w=572&h=634&f=png&s=79148)


åœ¨ Add Metrics ä¸­æˆ‘ä»¬å¯ä»¥å¢åŠ æ›´å¤šçš„æµ‹é‡é¡¹ã€‚

##### CPU running

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc8324616778?w=2866&h=1488&f=png&s=448392)


å¦‚æœä¸€ç›´å¤„äº runningï¼Œåˆ™è¡¨æ˜ç”µé‡æ¶ˆè€—æ¯”è¾ƒé«˜ã€‚

##### JobScheduler

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc86896f8829?w=2876&h=1452&f=png&s=438761)


é€‰ä¸­ Job Scheduler çš„æŸä¸€ä¸ªå·¥ä½œæ—¶é—´ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹å…·ä½“çš„ å‘ç”Ÿçš„æ—¶é—´ã€è€—æ—¶ä»¥åŠæ¬¡æ•°ï¼Œæœ€é‡è¦çš„æ˜¯å®ƒç»Ÿè®¡å‡ºæ¥äº†æ˜¯å“ªä¸€ä¸ªè¿›ç¨‹åœ¨ä½¿ç”¨è¿™ä¸ª JobSchedulerã€‚

#### App Selection

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc892e1b6384?w=898&h=490&f=png&s=78941)


- 1ï¼‰ã€é€‰æ‹©è¦åˆ†æç”µé‡çš„æŒ‡å®š Appã€‚
- 2ï¼‰ã€ç‚¹å‡»å³è¾¹åŒºåŸŸçš„ System Stats ä¸€æ å¯ä»¥åœ¨ä¸‹æ–¹æŸ¥çœ‹å„ä¸ªç³»ç»Ÿç»„ä»¶çš„ç”µé‡ç™¾åˆ†æ¯”æ¶ˆè€—è¯¦æƒ…ï¼Œä¾‹å¦‚ Userspace Wakelocksã€‚


#### ä¸»å…¥å£å¤„çš„ Switch to Bugreport Comparison

![](https://user-gold-cdn.xitu.io/2020/6/7/1728dc8bc221bdab?w=1438&h=478&f=png&s=73877)


é€‰æ‹©å¤šä¸ªæ–‡ä»¶è¿›è¡Œä¸Šä¼ å¯¹æ¯”ã€‚


## 5ã€ç”µé‡ä¸“é¡¹æµ‹è¯•

### 1ï¼‰ã€è€—ç”µåœºæ™¯æµ‹è¯•

- å¤æ‚è®¡ç®—ã€‚
- éŸ³è§†é¢‘æ’­æ”¾ã€‚


### 2ï¼‰ã€ä¼ æ„Ÿå™¨ç›¸å…³

- ä½¿ç”¨æ—¶é•¿
- è€—ç”µé‡
- å‘çƒ­


### 3ï¼‰ã€åå°é™é»˜æµ‹è¯•


# å››ã€è€—ç”µä¼˜åŒ–

## 1ã€è€—ç”µä¼˜åŒ–çš„éš¾ç‚¹

- 1ï¼‰ã€**ç¼ºä¹ç°åœºï¼Œæ— æ³•å¤ç°**ã€‚
- 2ï¼‰ã€**ä¿¡æ¯ä¸å…¨ï¼Œéš¾ä»¥å®šä½**ã€‚
- 3ï¼‰ã€**æ— æ³•è¯„ä¼°ç»“æœ**ã€‚


åœ¨ App å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šç”±äºæŸä¸ªéœ€æ±‚åœºæ™¯æˆ– ä»£ç  bug è€Œå¯¼è‡´å¤§é‡è€—ç”µã€‚

## 2ã€åå°è°ƒåº¦ä»»åŠ¡çœç”µ

### æ€è€ƒæ­¥éª¤

- éœ€è¦åå°è¿è¡Œ
    - é•¿æ—¶é—´ä¸‹è½½ï¼šDownloadManager
    - æ•°æ®åŒæ­¥ï¼šSyncAdapter
    - æœ¬åœ°ä»»åŠ¡ï¼šJobScheduler
- ç‰¹å®šæ—¶é—´æ‰§è¡Œï¼šAlarmManager
- å®æ—¶é€šä¿¡ï¼šæ¨é€æœåŠ¡
- ç«‹åˆ»æ‰§è¡Œï¼šForeground Service


å¯¹äºè€—ç”µä¼˜åŒ–ä¸­ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„å°±æ˜¯ JobSchedulerï¼Œä¸‹é¢ğŸ‘‡ï¼Œæˆ‘ä»¬æ¥å®æˆ˜ä¸€ä¸‹ã€‚

### Job Scheduler å®æˆ˜

```java
/**
 * å¼€å¯ JobScheduler
 */
private void startJobScheduler() {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
        JobScheduler jobScheduler = (JobScheduler) getSystemService(Context.JOB_SCHEDULER_SERVICE);
        JobInfo.Builder builder = new JobInfo.Builder(1, new ComponentName(getPackageName(), JobSchedulerService.class.getName()));
        // è®¾ç½®ä»…åœ¨ å……ç”µå’ŒWIFI ä¸‹æ‰ä½¿ç”¨ JobScheduler è¿›è¡Œæ‰¹é‡ä»»åŠ¡å¤„ç†
        builder.setRequiresCharging(true)
                .setRequiredNetworkType(JobInfo.NETWORK_TYPE_UNMETERED);
        jobScheduler.schedule(builder.build());
    }
}
```


å…¶ä¸­ï¼Œ**JobSchedulerService å°±æ˜¯ç”¨äºè¿›è¡Œæ‰¹é‡ä»»åŠ¡å¤„ç†çš„æœåŠ¡**ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š


```java
/**
 * ç”¨äºè¿›è¡Œæ‰¹é‡ä»»åŠ¡å¤„ç†çš„ JobSchedulerService
 */
@RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)
public class JobSchedulerService extends JobService {

    @Override
    public boolean onStartJob(JobParameters params) {
        // æ­¤å¤„æ‰§è¡Œåœ¨ä¸»çº¿ç¨‹
        // æ¨¡æ‹Ÿä¸€äº›å¤„ç†ï¼šæ‰¹é‡ç½‘ç»œè¯·æ±‚ï¼ŒAPMæ—¥å¿—ä¸ŠæŠ¥
        return false;
    }

    @Override
    public boolean onStopJob(JobParameters params) {
        return false;
    }
}
```


#### ç‰¹ç‚¹

- 1ï¼‰ã€**ä»…æ”¯æŒ API 21 åŠä¹‹ä¸Š**ã€‚
- 2ï¼‰ã€**åœ¨ç¬¦åˆæŸäº›æ¡ä»¶æ—¶åˆ›å»ºæ‰§è¡Œåœ¨åå°çš„ä»»åŠ¡**ã€‚
- 3ï¼‰ã€**æŠŠä¸ç´§æ€¥çš„ä»»åŠ¡æ”¾åˆ°æ›´åˆé€‚çš„æ—¶æœºæ‰¹é‡å¤„ç†**ã€‚


ç¬¦åˆ Android è§„åˆ™ï¼Œæ‰‹æœºåœ¨å……ç”µçŠ¶æ€æ‰å»åšè€—ç”µå·¥ä½œã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
IntentFilter ifilter = new IntentFilter(Intent.ACTION_BATTERY_CHANGED);
Intent batteryStatus = context.registerReceiver(null, ifilter);
//è·å–ç”¨æˆ·æ˜¯å¦åœ¨å……ç”µçš„çŠ¶æ€æˆ–è€…å·²ç»å……æ»¡ç”µäº†
int status = batteryStatus.getIntExtra(BatteryManager.EXTRA_STATUS, -1);
boolean isCharging = status == BatteryManager.BATTERY_STATUS_CHARGING || status == BatteryManager.BATTERY_STATUS_FULL;
```


## 3ã€ç”µé‡ä¼˜åŒ–å¥—è·¯æ€»ç»“

### 1ã€ä¼˜åŒ–åº”ç”¨çš„åå°è€—ç”µ

é¿å…åå°é•¿æ—¶é—´è·å– WakeLockã€WIFI å’Œè“ç‰™çš„æ‰«æç­‰ã€‚

### 2ã€ç¬¦åˆç³»ç»Ÿçš„è€—ç”µè§„åˆ™

Android P ä½¿ç”¨äº† Android Vitals ç›‘æ§åå°è€—ç”µï¼Œå…¶è§„åˆ™å¦‚ä¸‹æ‰€ç¤ºï¼š

- 1ï¼‰ã€Alarm Manager wakeup å”¤é†’è¿‡å¤šï¼šå½“æ‰‹æœºä¸åœ¨å……ç”µçŠ¶æ€ï¼Œæ¯å°æ—¶ wakeup å”¤é†’æ¬¡æ•°å¤§äº 10 æ¬¡ã€‚
- 2ï¼‰ã€é¢‘ç¹ä½¿ç”¨å±€éƒ¨å”¤é†’é”ï¼šå½“æ‰‹æœºä¸åœ¨å……ç”µçŠ¶æ€ï¼Œpartial wake lock æŒæœ‰è¶…è¿‡1å°æ—¶ã€‚
- 3ï¼‰ã€åå°ç½‘ç»œä½¿ç”¨é‡è¿‡é«˜ï¼šå½“æ‰‹æœºä¸åœ¨å……ç”µçŠ¶æ€è€Œä¸”åº”ç”¨åœ¨åå°ï¼Œæ¯å°æ—¶ç½‘ç»œä½¿ç”¨é‡è¶…è¿‡ 50MBã€‚
- 4ï¼‰ã€åå° WiFi scans è¿‡å¤šï¼šå½“æ‰‹æœºä¸åœ¨å……ç”µçŠ¶æ€è€Œä¸”åº”ç”¨åœ¨åå°ï¼Œæ¯å°æ—¶å¤§äº4æ¬¡ WiFi scansã€‚


### 3ã€CPU æ—¶é—´ç‰‡

**Android æ‰‹æœºä¿æŠ¤ AP å’Œ BP ä¸¤ä¸ª CPUã€‚AP å³ Application Processorï¼Œæ‰€æœ‰çš„ç”¨æˆ·ç•Œé¢ä»¥åŠ App éƒ½æ˜¯è¿è¡Œåœ¨ AP ä¸Šçš„ã€‚BP å³ Baseband Processorï¼Œæ‰‹æœºå°„é¢‘éƒ½æ˜¯è¿è¡Œåœ¨è¿™ä¸ª CPU ä¸Šçš„ã€‚è€Œä¸€èˆ¬æˆ‘ä»¬æ‰€è¯´çš„è€—ç”µï¼ŒPowerProfile æ–‡ä»¶é‡Œé¢çš„ CPUï¼ŒæŒ‡çš„æ˜¯ AP**ã€‚

CPU è€—ç”µé€šå¸¸æœ‰ä¸¤ç§æƒ…å†µï¼š

- 1ï¼‰ã€**é•¿æœŸé¢‘ç¹å”¤é†’ï¼šåŸæœ¬å¯ä»¥ä»…ä»…åœ¨ BP ä¸Šè¿è¡Œï¼Œæ¶ˆè€— 5mA å·¦å³ï¼Œä½†æ˜¯å› ä¸ºå”¤é†’ï¼ŒAP å°±ä¼šè¿ä½œï¼Œä¸åŒæ‰‹æœºæƒ…å†µä¸ä¸€æ ·ï¼Œè‡³å°‘ä¼šå¯¼è‡´ 20~30 mA å·¦å³çš„è€—ç”µ**ã€‚
- 2ï¼‰ã€**CPU é•¿æœŸé«˜è´Ÿè·ï¼šä¾‹å¦‚ App é€€åˆ°åå°çš„æ—¶å€™æ²¡æœ‰åœæ­¢åŠ¨ç”»ï¼Œæˆ–è€…ç¨‹åºæœ‰ä¸é€€å‡ºçš„æ­»å¾ªç¯ç­‰ç­‰ï¼Œå¯¼è‡´ CPU æ»¡é¢‘ã€æ»¡æ ¸åœ°è·‘**ã€‚


å¸¸ç”¨ä¼˜åŒ– CPU æ—¶é—´ç‰‡çš„æ–¹å¼æœ‰ï¼š

- 1ï¼‰ã€**è·å–è¿è¡Œè¿‡ç¨‹çº¿ç¨‹ CPU æ¶ˆè€—ï¼Œå®šä½ CPU å ç”¨ç‡å¼‚å¸¸æ–¹æ³•**ã€‚
- 2ï¼‰ã€**å‡å°‘åå°åº”ç”¨çš„ä¸»åŠ¨è¿è¡Œ**ã€‚


### 4ã€ç½‘ç»œç›¸å…³

é€šå¸¸æƒ…å†µä¸‹ï¼Œä½¿ç”¨ WIFI è¿æ¥ç½‘ç»œæ—¶çš„åŠŸè€—è¦ä½äºä½¿ç”¨ç§»åŠ¨ç½‘ç»œçš„åŠŸè€—ã€‚è€Œä½¿ç”¨ç§»åŠ¨ç½‘ç»œä¼ è¾“æ•°æ®ï¼Œç”µé‡çš„æ¶ˆè€—æœ‰ä»¥ä¸‹3ç§çŠ¶æ€ï¼š

- **Full powerï¼šé«˜åŠŸç‡çŠ¶æ€ï¼Œç§»åŠ¨ç½‘ç»œè¿æ¥è¢«æ¿€æ´»ï¼Œå…è®¸è®¾å¤‡ä»¥æœ€å¤§çš„ä¼ è¾“é€Ÿç‡è¿›è¡Œæ“ä½œ**ã€‚
- **Low powerï¼šä½åŠŸè€—çŠ¶æ€ï¼Œå¯¹ç”µé‡çš„æ¶ˆè€—å·®ä¸å¤šæ˜¯ Full power çŠ¶æ€ä¸‹çš„ 50%**ã€‚
- **Standbyï¼šç©ºé—²æ€ï¼Œæ²¡æœ‰æ•°æ®è¿æ¥éœ€è¦ä¼ è¾“ï¼Œç”µé‡æ¶ˆè€—æœ€å°‘**ã€‚


å› æ­¤ï¼Œä¸ºäº†é¿å…ç½‘ç»œè¿æ¥æ‰€å¸¦æ¥çš„ç”µé‡æ¶ˆè€—ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨å¦‚ä¸‹å‡ ç§æ–¹æ¡ˆï¼š

- 1ï¼‰ã€å°½é‡åœ¨ WIFI ç¯å¢ƒä¸‹è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œåœ¨ä½¿ç”¨ WIFI ä¼ è¾“æ•°æ®æ—¶ï¼Œåº”è¯¥å°½å¯èƒ½å¢å¤§æ¯ä¸ªåŒ…çš„å¤§å°ï¼ˆä¸è¶…è¿‡ MTUï¼‰ï¼Œå¹¶é™ä½å‘åŒ…çš„é¢‘ç‡ã€‚
- 2ï¼‰ã€åœ¨èœ‚çªç§»åŠ¨ç½‘ç»œä¸‹éœ€è¦å¯¹è¯·æ±‚æ—¶æœºåŠæ¬¡æ•°æ§åˆ¶ï¼šå¯ä»¥å»¶è¿Ÿæ‰§è¡Œçš„ç½‘ç»œè¯·æ±‚ç¨åä¸€èµ·å‘é€ï¼Œæœ€å¥½åšåˆ°æ‰¹é‡æ‰§è¡Œï¼Œå°½é‡é¿å…é¢‘ç¹çš„é—´éš”ç½‘ç»œè¯·æ±‚ï¼Œä»¥å°½é‡å¤šåœ°ä¿æŒåœ¨ Radio Standby çŠ¶æ€ã€‚
- 3ï¼‰ã€ä½¿ç”¨ JSON å’Œ Protobuf è¿›è¡Œæ•°æ®å‹ç¼©ï¼Œå‡å°‘æ—¶é—´ã€‚
- 4ï¼‰ã€ç¦æ­¢ä½¿ç”¨è½®è¯¢åŠŸèƒ½ï¼šè½®è¯¢ä¼šå¯¼è‡´ç½‘ç»œè¯·æ±‚ä¸€ç›´å¤„äºè¢«æ¿€æ´»çš„çŠ¶æ€ï¼Œè€—ç”µè¿‡é«˜ã€‚


### 5ã€å®šä½ç›¸å…³

- 1ï¼‰ã€**æ ¹æ®åœºæ™¯è°¨æ…é€‰æ‹©å®šä½æ¨¡å¼ï¼šå¯¹å®šä½å‡†ç¡®åº¦æ²¡é‚£ä¹ˆé«˜çš„åœºæ™¯å¯ä»¥é€‰æ‹©ä½ç²¾åº¦æ¨¡å¼**ã€‚
- 2ï¼‰ã€**å¯ä»¥è€ƒè™‘ç½‘ç»œå®šä½ä»£æ›¿ GPS**ã€‚
- 3ï¼‰ã€**ä½¿ç”¨ååŠ¡å¿…åŠæ—¶å…³é—­ï¼Œå‡å°‘æ›´æ–°é¢‘ç‡ï¼Œä¾‹å¦‚å®šä½å¼€å¯ä¸€å®šæ—¶é—´åè¶…è¿‡æŸä¸ªé˜ˆå€¼å¯ä»¥æ‰§è¡Œä¸€ä¸ªå…œåº•ç­–ç•¥ï¼šå¼ºåˆ¶å…³é—­ GPS**ã€‚


### 6ã€ç•Œé¢ç›¸å…³

- 1ï¼‰ã€**ç¦»å¼€ç•Œé¢ååœæ­¢ç›¸å…³æ´»åŠ¨ï¼Œä¾‹å¦‚å…³é—­åŠ¨ç”»**ã€‚
- 2ï¼‰ã€**è€—ç”µæ“ä½œåˆ¤æ–­å‰åå°ï¼Œå¦‚æœæ˜¯åå°åˆ™ä¸æ‰§è¡Œç›¸å…³æ“ä½œ**ã€‚


### 7ã€WakeLock ç›¸å…³

WakeLock å¸¸ç”¨äºåå°æ’­æ”¾éŸ³è§†é¢‘ã€å½•åˆ¶éŸ³è§†é¢‘ã€ä¸‹è½½æ–‡ä»¶çš„æƒ…å†µã€‚å¦‚æœæ²¡æœ‰åˆç†ä½¿ç”¨ WakeLockï¼Œåˆ™ä¼šé€ æˆä¸¥é‡çš„è€—ç”µé—®é¢˜ï¼Œä¸ºäº†é¿å…è¯¥é—®é¢˜ï¼Œ**æˆ‘ä»¬åº”è¯¥å®šæœŸé’ˆå¯¹ä½¿ç”¨äº† WakeLock çš„æ¨¡å—è¿›è¡Œé‡ç‚¹æ’æŸ¥**ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `adb shell dumpsys power` å‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿå½“å‰çš„è€—ç”µä¿¡æ¯ï¼Œå…¶ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° WakeLock åˆ—è¡¨ï¼Œå®ƒé€šå¸¸ä¼šä»¥ **â€mLocks.sizeâ€œ æˆ–è€… â€Wake Locksï¼šsizeâ€œ** å¼€å¤´ã€‚å…³äº WakeLock çš„ä½¿ç”¨æˆ‘ä»¬è¦ç€é‡æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

- 1ï¼‰ã€**æ³¨æ„æˆå¯¹ä½¿ç”¨ acquireã€release**ã€‚
- 2ï¼‰ã€**å»ºè®®ä½¿ç”¨å¸¦å‚æ•°çš„ acquireï¼Œé¿å…æ²¡æœ‰åŠæ—¶é‡Šæ”¾è€Œå¯¼è‡´ç”µé‡æ¶ˆè€—è¿‡å¤§**ã€‚
- 3ï¼‰ã€**ä½¿ç”¨ finally ç¡®ä¿ release ä¸€å®šä¼šè¢«è°ƒç”¨**ã€‚
- 4ï¼‰ã€**å¸¸äº®åœºæ™¯ä½¿ç”¨ keepScreenOn å³å¯**ã€‚
- 5ï¼‰ã€**WakeLock æœ‰ä¸€ä¸ªæ¥å£ setReferenceCountedï¼Œç”¨æ¥è®¾ç½® WakeLock çš„æŠ€æœ¯æœºåˆ¶ï¼Œå®˜æ–¹é»˜è®¤ä¸ºè®¡æ•°ã€‚true ä¸ºè®¡æ•°ï¼Œfalse ä¸ºä¸è®¡æ•°ã€‚æ‰€è°“è®¡æ•°å³æ¯ä¸€ä¸ª acquire å¿…é¡»å¯¹åº”ä¸€ä¸ª releaseï¼›ä¸è®¡æ•°åˆ™æ˜¯æ— è®ºæœ‰å¤šå°‘ä¸ª acquireï¼Œä¸€ä¸ª release å°±å¯ä»¥é‡Šæ”¾ã€‚ä½†æ˜¯é—®é¢˜æ˜¯æœ‰çš„ç¬¬ä¸‰æ–¹ ROM å®ƒå°†é»˜è®¤è®¾ç½®ä¸ºäº†ä¸è®¡æ•°ï¼Œä»¥ä¸ºæˆ‘ä»¬éœ€è¦åœ¨è°ƒç”¨ newWakeLock ä¹‹åå†è°ƒç”¨ setReferenceCounted ä¸º false**ã€‚


### 8ã€è®¡ç®—ä¼˜åŒ–

**æµ®ç‚¹è¿ç®—æ¯”æ•´æ•°è¿ç®—æ›´æ¶ˆè€— CPU æ—¶é—´ç‰‡ï¼Œå› æ­¤è€—ç”µä¹Ÿä¼šå¢åŠ **ã€‚é¿å¼€æµ®ç‚¹è¿ç®—çš„ä¼˜åŒ–æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š

- 1ï¼‰ã€**é™¤æ³•å˜ä¹˜æ³•**ã€‚
- 2ï¼‰ã€**å……åˆ†åˆ©ç”¨ç§»ä½**ã€‚
- 3ï¼‰ã€**åœ¨ native å±‚å¼€å‘æ—¶ï¼Œå¯ä»¥åˆ©ç”¨ ARM neon æŒ‡ä»¤é›†åšå¹¶è¡Œè¿ç®—ï¼Œæ³¨æ„éœ€è¦ ARM V7 åŠä»¥ä¸Šæ¶æ„ CPU æ‰èƒ½æ”¯æŒ**ã€‚


### 9ã€ç­å±æ—¶åœæ­¢åŠ¨ç”»

**æˆ‘ä»¬å¯ä»¥ç›‘å¬ç­å±ä»¥åŠäº®å±çš„å¹¿æ’­ï¼Œåœ¨ç­å±çš„æ—¶å€™åœæ­¢ surfaceView çš„åŠ¨ç”»ç»˜åˆ¶ã€‚åœ¨äº®å±çš„æ—¶å€™ï¼Œæ¢å¤åŠ¨ç”»çš„ç»˜åˆ¶**ã€‚


# äº”ã€è€—ç”µç›‘æ§

ä»¥åå°è€—ç”µç›‘æ§ä¸ºä¸»ï¼Œå¿…é¡»ç›‘æ§çš„æ¨¡å—æœ‰ï¼š

- 1ï¼‰ã€**Alarm wakeup**
- 2ï¼‰ã€**WakeLock**
- 3ï¼‰ã€**WiFi scans**
- 4ï¼‰ã€**Network**


**å¿…é¡»ç›‘æ§çš„ç°åœºä¿¡æ¯æœ‰** ï¼š

- 1ï¼‰ã€**å †æ ˆä¿¡æ¯**
- 2ï¼‰ã€**æ˜¯å¦å……ç”µ**
- 3ï¼‰ã€**ç”µé‡æ°´å¹³**
- 4ï¼‰ã€**åº”ç”¨å‰åå°æ—¶é—´**
- 5ï¼‰ã€**CPU çŠ¶æ€ä¿¡æ¯**


æœ€åï¼Œæˆ‘ä»¬éœ€è¦ **æç‚¼è§„åˆ™ï¼Œå°†ç›‘æ§å†…å®¹ => æŠ½è±¡æˆè§„åˆ™**ã€‚

## 1ã€Java Hook

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»£ç†å¯¹åº”çš„ Service å®ç°ï¼Œå®Œæˆæ”¶é›† Wakelockã€Alarmã€GPS çš„ç”³è¯·å †æ ˆã€é‡Šæ”¾ä¿¡æ¯ã€æ‰‹æœºå……ç”µçŠ¶æ€ç­‰ç­‰ã€‚

[ç¤ºä¾‹é¡¹ç›®](https://github.com/simplezhli/Chapter19)


## 2ã€ç”µé‡è¾…åŠ©ç›‘æ§å®æˆ˜

### 1ï¼‰ã€è·å–è¿è¡Œæ—¶èƒ½è€—æ–‡ä»¶

- 1ï¼‰ã€adb pull /system/framework/framework-res.apk
- 2ï¼‰ã€åç¼–è¯‘ï¼Œxmlâ€”ã€‹power_profile


### 2ï¼‰ã€ç”µé‡è¾…åŠ©ç›‘æ§

#### çº¿ä¸‹ä½¿ç”¨ epic è¿›è¡Œ AOP ç”µé‡è¾…åŠ©ç»Ÿè®¡

è¿™é‡Œæˆ‘ä»¬å°±ä»¥ WakeLock çš„ç›‘æ§ä¸ºä¾‹ï¼Œåˆ‡é¢ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public static long sStartTime = 0;
@Insert(value = "acquire")
@TargetClass(value = "com.optimize.performance.wakelock.WakeLockUtils",scope = Scope.SELF)
public static void acquire(Context context){
    trace = Log.getStackTraceString(new Throwable());
    sStartTime = System.currentTimeMillis();
    Origin.callVoid();
    new Handler().postDelayed(new Runnable() {
        @Override
        public void run() {
            WakeLockUtils.release();
        }
    },1000);
}
@Insert(value = "release")
@TargetClass(value = "com.optimize.performance.wakelock.WakeLockUtils",scope = Scope.SELF)
public static void release(){
    LogUtils.i("PowerManager "+(System.currentTimeMillis() - sStartTime)+"/n"+trace);
```


æ­¤å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨ epic æ¥ç›‘æ§æ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ï¼Œè¶…è¿‡é˜ˆå€¼åˆ™è­¦å‘Šï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public static long runTime = 0;
@Insert(value = "run")
@TargetClass(value = "java.lang.Runnable",scope = Scope.ALL)
public void run(){
    runTime = System.currentTimeMillis();
    Origin.callVoid();
    LogUtils.i("runTime "+(System.currentTimeMillis() - runTime));
}
```


## 3ã€ç¼–è¯‘æ’æ¡©

**å†™ä¸€ä¸ªåŸºç¡€ç±»ï¼Œç„¶ååœ¨ç»Ÿä¸€çš„è°ƒç”¨æ¥å£ä¸­æ·»åŠ ç›‘æ§é€»è¾‘**ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ `Facebook Battery-Metrics` è·å–ã€ç›‘æ§æ•°æ®çš„æ–¹å¼ã€‚å…¶ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public class WakelockMetrics {

    /**
     * è·å– WakeLock
     *
     * @param wakeLock WakeLock
     * @param timeout è¶…æ—¶æ—¶é—´
     */
    public static void acquire(PowerManager.WakeLock wakeLock, long timeout) {
        wakeLock.acquire(timeout);
        // ç›‘æ§ wakelock ç›¸å…³ä¿¡æ¯
        Log.e("HOOOOOOOOK", "--acquireWakeLock--");
        Log.e("HOOOOOOOOK", Utils.getStackTrace());
        // ä½¿ç”¨ Battery-Metrics åº“ç»Ÿè®¡å…¶å®ƒç»´åº¦çš„ç”µé‡ä¿¡æ¯
        
    }

    /**
     * é‡Šæ”¾ WakeLock
     *
     * @param wakeLock WakeLock
     */
    public static void release(PowerManager.WakeLock wakeLock) {
        wakeLock.release();
        Log.e("HOOOOOOOOK", "--releaseWakeLock--");
        Log.e("HOOOOOOOOK", Utils.getStackTrace());
        // ä½¿ç”¨ Battery-Metrics åº“ç»Ÿè®¡å…¶å®ƒç»´åº¦çš„ç”µé‡ä¿¡æ¯
        
    }

}
```


Gradle è€—ç”µé‡ç»Ÿè®¡æ’ä»¶ä¸­ BatteryCreateMethodVisitor çš„æ ¸å¿ƒå®ç°ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
@Override
public void visitMethodInsn(int opcode, String owner, String name, String descriptor, boolean isInterface) {
    // ç›‘æ§ Wakelock
    String monitorClass = "com/ss/android/ugc/bytex/example/battery_monitor/WakelockMetrics";
    if (!monitorClass.equals(className)
            && "android/os/PowerManager$WakeLock".equals(owner)
            && opcode == Opcodes.INVOKEVIRTUAL
            && "acquire".equals(name)) {
        mv.visitMethodInsn(
                Opcodes.INVOKESTATIC,
                monitorClass,
                name,
                "(Landroid/os/PowerManager$WakeLock;J)V",
                isInterface
        );
        return;
    }
    if (!monitorClass.equals(className)
            && "android/os/PowerManager$WakeLock".equals(owner)
            && opcode == Opcodes.INVOKEVIRTUAL
            && "release".equals(name)) {
        mv.visitMethodInsn(
                Opcodes.INVOKESTATIC,
                monitorClass,
                name,
                "(Landroid/os/PowerManager$WakeLock;)V",
                isInterface
        );
        return;
    }
    // ç›‘æ§ Gps
    monitorClass = "com/ss/android/ugc/bytex/example/battery_monitor/GpsMetrics";
    if (!monitorClass.equals(className)
            && "android/location/LocationManager".equals(owner)
            && opcode == Opcodes.INVOKEVIRTUAL
            && "requestLocationUpdates".equals(name)) {
        mv.visitMethodInsn(
                Opcodes.INVOKESTATIC,
                monitorClass,
                name,
                "(Landroid/location/LocationManager;Ljava/lang/String;JFLandroid/location/LocationListener;)V",
                isInterface
        );
        return;
    }
    if (!monitorClass.equals(className)
            && "android/location/LocationManager".equals(owner)
            && opcode == Opcodes.INVOKEVIRTUAL
            && "removeUpdates".equals(name)) {
        mv.visitMethodInsn(
                Opcodes.INVOKESTATIC,
                monitorClass,
                name,
                "(Landroid/location/LocationManager;Landroid/location/LocationListener;)V",
                isInterface
        );
        return;
    }
    // ç›‘æ§ Alarm Service
    monitorClass = "com/ss/android/ugc/bytex/example/battery_monitor/AlarmMetrics";
    if (!monitorClass.equals(className)
            && "android/app/AlarmManager".equals(owner)
            && opcode == Opcodes.INVOKEVIRTUAL
            && "set".equals(name)) {
        mv.visitMethodInsn(
                Opcodes.INVOKESTATIC,
                monitorClass,
                name,
                "(Landroid/app/AlarmManager;IJLandroid/app/PendingIntent;)V",
                isInterface
        );
        return;
    }
    if (!monitorClass.equals(className)
            && "android/app/AlarmManager".equals(owner)
            && opcode == Opcodes.INVOKEVIRTUAL
            && "cancel".equals(name)) {
        mv.visitMethodInsn(
                Opcodes.INVOKESTATIC,
                monitorClass,
                name,
                "(Landroid/app/AlarmManager;Landroid/app/PendingIntent;)V",
                isInterface
        );
        return;
    }
    super.visitMethodInsn(opcode, owner, name, descriptor, isInterface);
}
```


#### ç¼ºç‚¹

ç³»ç»Ÿçš„ä»£ç æ’æ¡©æ–¹æ¡ˆæ— æ³•æ›¿æ¢ã€‚


# å…­ã€ç”µé‡ä¼˜åŒ–å¸¸è§é—®é¢˜

## 1ã€æ€ä¹ˆåšç”µé‡æµ‹è¯•ï¼Ÿ

ç”µé‡ç›¸å…³çš„æµ‹è¯•ç›¸å¯¹æ¥è¯´éš¾åº¦è¾ƒå¤§ï¼Œå› ä¸º App åœ¨å…·ä½“æ‰‹æœºä¸Šçš„è€—ç”µé‡æ— æ³•å‡†ç¡®ç»Ÿè®¡ï¼Œæ¯ä¸€ä¸ªæ‰‹æœºæ‰€ä½¿ç”¨çš„ç¡¬ä»¶ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆå®ƒç›¸åº”çš„åŠŸè€—å°±ä¸ä¸€æ ·ã€‚è€Œä¸”è¿™ä¸ªåŠŸè€—å€¼æˆ‘ä»¬åªèƒ½åœ¨çº¿ä¸‹é€šè¿‡å¯¼å‡ºæ‰‹æœºçš„ power_profile.xml æ–‡ä»¶æ‹¿åˆ°ã€‚

ç”±äºæˆ‘ä»¬æ— æ³•è·å–å‡†ç¡®çš„è€—ç”µé‡ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½å¢åŠ å¤šä¸ªç»´åº¦æ¥è¾…åŠ©åˆ¤æ–­ App æ˜¯å¦è€—ç”µã€‚

æœ€åï¼Œæˆ‘ä»¬å¯ä»¥åˆ†åœºæ™¯å„ä¸ªçªç ´ã€‚

å…³äºç”µé‡æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹å„ä¸ªåŠŸèƒ½åœºæ™¯è¿›è¡Œé’ˆå¯¹æ€§çš„ä¸“é¡¹æµ‹è¯•ã€‚æ“ä½œä¸€æ®µæ—¶é—´åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ‰‹æœºè®¾ç½®â€”ç”µé‡æ¶ˆè€—é‡Œé¢ï¼Œåˆ©ç”¨å…¶æ•°æ®ä½œä¸ºåˆ¤æ–­ä¾æ®ã€‚è¿™æ ·è™½ç„¶ç›´è§‚ï¼Œä½†ç²¾ç¡®åº¦ä¸è¡Œã€‚

ä»‹ç» Battery Historianï¼š

- Google æ¨å‡ºçš„ä¸€æ¬¾ Android ç”µé‡åˆ†æå·¥å…·ï¼Œå®ƒæ”¯æŒ Android 5.0 åŠä»¥ä¸Šç³»ç»Ÿçš„ç”µé‡åˆ†æã€‚
- å®ƒè·å–åˆ°çš„å„ä¸ªè€—ç”µæ¨¡å—çš„è€—ç”µä¿¡æ¯è¦ç›¸å¯¹ç²¾ç¡®ã€ä¸°å¯Œåœ°å¤šã€‚ä¾‹å¦‚ GPSã€WaleLockã€è“ç‰™ ç­‰çš„å·¥ä½œæ—¶é—´ä»¥åŠè€—ç”µé‡ã€‚
- æ­¤å¤–ï¼Œå®ƒä¸ä»…å¯ä»¥é’ˆå¯¹å•ä¸ª App è¿›è¡Œé€‰æ‹©ï¼Œä¹Ÿå¯ä»¥æ¯”å¯¹ä¸åŒçš„ç”µé‡åœºæ™¯çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ ä¼˜åŒ–å‰ã€ä¼˜åŒ–å çš„ä¿¡æ¯ã€‚
- Battery Historian çš„ç¼ºç‚¹åœ¨äºå®ƒåªèƒ½åœ¨çº¿ä¸‹ä½¿ç”¨ã€‚å› æ­¤é™¤äº†ä½¿ç”¨å…¶åœ¨çº¿ä¸‹æµ‹è¯•ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨çº¿ä¸Šå¢åŠ ä¸€äº›ç”µé‡çš„è¾…åŠ©ç›‘æ§ï¼Œç»Ÿè®¡ä¾‹å¦‚ï¼šè€—ç”µç»„ä»¶çš„ä½¿ç”¨æ¬¡æ•°ã€è°ƒç”¨å †æ ˆä»¥åŠè®¿é—®æ—¶é—´ã€‚è¿™äº›éƒ½æ˜¯ä¸ç”¨æˆ·ç›¸å…³çš„åŸºç¡€ç”µé‡æ¶ˆè€—æ•°æ®ï¼Œå¦‚æœæœ‰ç”¨æˆ·åé¦ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™äº›ä¿¡æ¯æ¥åˆ¤æ–­ç”¨æˆ·æ˜¯ä¸æ˜¯æœ‰è€—ç”µçš„æ“ä½œã€‚


## 2ã€æœ‰å“ªäº›æœ‰æ•ˆçš„ç”µé‡ä¼˜åŒ–æ‰‹æ®µï¼Ÿ

å› ä¸ºæˆ‘ä»¬ä¸èƒ½åœ¨çº¿ä¸Šç»Ÿè®¡å‡º App çš„ç”µé‡æ¶ˆè€—ï¼Œå› æ­¤éœ€è¦åœ¨å°½é‡ä¿è¯ App åœ¨æ­£å¸¸ä½¿ç”¨ä¸‹çš„è€—ç”µã€‚å¯¹æ­¤æˆ‘ä»¬é‡‡å–äº†ä¸€ç³»åˆ—çš„ç”µé‡ä¼˜åŒ–æªæ–½ï¼š

### 1ï¼‰ã€ç½‘ç»œç›¸å…³

- ç½‘ç»œè¯·æ±‚çš„æ—¶æœºä»¥åŠæ¬¡æ•°ï¼Œå°†å¯ä»¥å»¶è¿Ÿçš„ç½‘ç»œè¯·æ±‚æ‰¹é‡å‘é€ï¼Œå‡å°‘ç½‘ç»œè¢«æ¿€æ´»çš„æ—¶æœºä¸æ¬¡æ•°ã€‚
- æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ç½‘ç»œä¼ è¾“æ•°æ®è¿›è¡Œå‹ç¼©ï¼Œä»¥é™ä½ä¼ è¾“çš„æ—¶é—´ä¸æµé‡ã€‚
- æœ€åï¼Œä¸€å®šè¦ç¦æ­¢ä½¿ç”¨è½®è¯¢çš„æ–¹å¼æ¥åšä¸šåŠ¡æ“ä½œã€‚


### 2ï¼‰ã€ä¼ æ„Ÿå™¨ç›¸å…³

æ ¹æ®åœºæ™¯è°¨æ…åœ°é€‰æ‹©ä¼ æ„Ÿå™¨ä½¿ç”¨çš„æ¨¡å¼ï¼Œæ¯”å¦‚è¯´åœ¨ä½¿ç”¨ GPS çš„æ—¶å€™ä¸€èˆ¬è¦é¿å…ä½¿ç”¨é«˜ç²¾åº¦çš„æ¨¡å¼ï¼Œæˆ–è€…æ˜¯å°½é‡å¤ç”¨ä¸Šä¸€æ¬¡çš„å®šä½ç»“æœã€‚

### 3ï¼‰ã€WakeLock

æˆ‘ä»¬åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨ WakeLock æœ‰å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼Œç¬¬ä¸€ï¼Œacquireã€release è¦æˆå¯¹åœ°é‡Šæ”¾ï¼Œç¬¬äºŒï¼Œå°½é‡ä½¿ç”¨ acquire çš„è¶…æ—¶æ–¹æ³•æ¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…å› ä¸ºå¼‚å¸¸æƒ…å†µä»è€Œå¯¼è‡´ WakeLock è€Œæ— æ³•é‡Šæ”¾çš„æƒ…å†µï¼Œç¬¬ä¸‰ï¼Œå…³äº WakeLock çš„é‡Šæ”¾ä¸€å®šè¦å†™åœ¨ try-catch-finally çš„ finally å½“ä¸­ï¼Œä¿è¯ WakeLock åœ¨å¼‚å¸¸æƒ…å†µä¸‹çš„é‡Šæ”¾ã€‚

### 4ï¼‰ã€JobScheduler

JobScheduler å¯ä»¥å…è®¸å¼€å‘è€…åœ¨ç¬¦åˆæŸäº›æ¡ä»¶ä¸‹åˆ›é€ æ‰§è¡Œåœ¨åå°çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®æ‰§è¡Œä¸€äº›è€—ç”µæ“ä½œçš„åœºæ™¯ï¼Œæ¯”å¦‚è¯´ å¤„äº WIFI çŠ¶æ€ä¸‹åŒæ—¶è¿æ¥ç”µæº çš„æƒ…å†µä¸‹ã€‚åŒæ—¶ï¼Œè¦æ³¨æ„ç”¨æˆ·åœ¨ç¦»å¼€ç•Œé¢åï¼Œè¦é¿å…è€—ç”µçš„æ“ä½œï¼Œæ¯”å¦‚è¯´åœæ­¢æ’­æ”¾åŠ¨ç”»ã€‚é€šè¿‡è¿™äº›æ“ä½œï¼Œæˆ‘ä»¬çš„ App å°±ä¸ä¼šæ¯”ä¹‹å‰è€—ç”µäº†ã€‚


# ä¸ƒã€æ€»ç»“

å¯¹äºç”µé‡ä¼˜åŒ–æ¥è¯´ï¼Œæœ€é‡è¦çš„å°±æ˜¯ **å»ºç«‹ç›‘æ§ä¸è‡ªåŠ¨åŒ–æŠ¥è­¦çš„ä¸€æ•´å¥—ä½“ç³»ï¼Œåªæœ‰å‘ç°äº†è€—ç”µçš„é—®é¢˜æ‰€åœ¨ï¼Œæ‰èƒ½ä½¿ç”¨é’ˆå¯¹æ€§çš„è§£å†³æªæ–½**ã€‚


# å…¬ä¼—å·

æˆ‘çš„å…¬ä¼—å· `JsonChao` å¼€é€šå•¦ï¼Œæ¬¢è¿å…³æ³¨~

![](https://user-gold-cdn.xitu.io/2020/6/11/172a29b8b626ef93?w=258&h=258&f=jpeg&s=28705)

# å‚è€ƒé“¾æ¥ï¼š
---

- 1ã€ã€ŠAndroidæ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µã€‹ç¬¬å…­ç«  è€—ç”µä¼˜åŒ–ï¼ˆåŸºç¡€ï¼‰
- 2ã€æ…•è¯¾ç½‘ä¹‹Topå›¢é˜Ÿå¤§ç‰›å¸¦ä½ ç©è½¬Androidæ€§èƒ½åˆ†æä¸ä¼˜åŒ– ç¬¬ä¹ç«  Appç”µé‡ä¼˜åŒ–ï¼ˆè¿›é˜¶ï¼‰
- 3ã€æå®¢æ—¶é—´ä¹‹Androidå¼€å‘é«˜æ‰‹è¯¾ è€—ç”µä¼˜åŒ–ï¼ˆè¿›é˜¶ï¼‰
- 4ã€ã€ŠAndroidç§»åŠ¨æ€§èƒ½å®æˆ˜ã€‹ç¬¬äº”ç«  ç”µæ± ï¼ˆç»éªŒï¼‰
- 5ã€[æ‰‹æœºç¡¬ä»¶å·²è¿›å…¥å‘å±•ç“¶é¢ˆï¼Œæœªæ¥ç”µæ± æŠ€æœ¯å°†å¦‚ä½•çªç ´ï¼Ÿ](https://mobile.pconline.com.cn/1089/10896724.html)
- 6ã€[VOOC é—ªå……](https://baike.baidu.com/item/VOOC%E9%97%AA%E5%85%85/13887450?fromtitle=%E5%85%85%E7%94%B55%E5%88%86%E9%92%9F%E9%80%9A%E8%AF%9D2%E5%B0%8F%E6%97%B6&fromid=18226496#reference-%5B4%5D-13589055-wrap)
- 7ã€[google/battery-historian](https://github.com/google/battery-historian)
- 8ã€[google/battery-historian-docs](https://github.com/facebookincubator/Battery-Metrics/blob/master/docs/references.md)
- 9ã€[google/battery-historian-api](https://facebookincubator.github.io/Battery-Metrics/)
- 10ã€[å¤§ä¼—ç‚¹è¯„ App çš„çŸ­è§†é¢‘è€—ç”µé‡ä¼˜åŒ–å®æˆ˜](https://tech.meituan.com/2018/03/11/dianping-shortvideo-battery-testcase.html)
- 11ã€[Android åå°è°ƒåº¦ä»»åŠ¡ä¸çœç”µ](https://blog.dreamtobe.cn/2016/08/15/android_scheduler_and_battery/)
- 12ã€[Android P ç”µé‡ç®¡ç†](https://mp.weixin.qq.com/s/APhUH7MBDUZ6tQv0xDgaWQ)
- 13ã€[facebookincubator/Battery-Metrics](https://github.com/facebookincubator/Battery-Metrics)
- 14ã€[simplezhli/Chapter19](https://github.com/simplezhli/Chapter19)


# Contanct Me

##  â—  å¾®ä¿¡ï¼š

> æ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡ï¼š`bcce5360`  

##  â—  å¾®ä¿¡ç¾¤ï¼š

> **ç”±äºå¾®ä¿¡ç¾¤äººæ•°è¿‡å¤šï¼Œéº»çƒ¦å¤§å®¶æƒ³è¿›å¾®ä¿¡ç¾¤çš„æœ‹å‹ä»¬ï¼ŒåŠ æˆ‘å¾®ä¿¡æ‹‰ä½ è¿›ç¾¤ã€‚**
        

##  â—  QQç¾¤ï¼š

> 2åƒäººQQç¾¤ï¼Œ**Awesome-Androidå­¦ä¹ äº¤æµç¾¤ï¼ŒQQç¾¤å·ï¼š959936182**ï¼Œ æ¬¢è¿å¤§å®¶åŠ å…¥~


## About me

- ### Email: [chao.qu521@gmail.com]()
- ### Blog: [https://jsonchao.github.io/](https://jsonchao.github.io/)
- ### æ˜é‡‘: [https://juejin.im/user/5a3ba9375188252bca050ade](https://juejin.im/user/5a3ba9375188252bca050ade)
    

### å¾ˆæ„Ÿè°¢æ‚¨é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Œå¸Œæœ›æ‚¨èƒ½å°†å®ƒåˆ†äº«ç»™æ‚¨çš„æœ‹å‹æˆ–æŠ€æœ¯ç¾¤ï¼Œè¿™å¯¹æˆ‘æ„ä¹‰é‡å¤§ã€‚

### å¸Œæœ›æˆ‘ä»¬èƒ½æˆä¸ºæœ‹å‹ï¼Œåœ¨ [Github](https://github.com/JsonChao)ã€[æ˜é‡‘](https://juejin.im/user/5a3ba9375188252bca050ade)ä¸Šä¸€èµ·åˆ†äº«çŸ¥è¯†ã€‚



















